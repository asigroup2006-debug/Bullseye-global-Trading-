<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#0e1016">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Bulls Eye ‚Äî Global Trading Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;background:#0e1016;}
body{color:#fff;font-family:'Inter',system-ui,sans-serif;font-size:14px;}
::-webkit-scrollbar{width:0;height:0;}
.app{height:100vh;display:flex;flex-direction:column;max-width:430px;margin:0 auto;background:#0e1016;}
.scr{display:none;flex:1;flex-direction:column;overflow:hidden;}
.scr.on{display:flex;}
.cnt{flex:1;overflow-y:auto;}

/* TOPBAR */
.topbar{display:flex;align-items:center;padding:10px 14px;gap:10px;background:#0e1016;flex-shrink:0;}
.srch-box{flex:1;display:flex;align-items:center;gap:8px;background:#1c2130;border-radius:10px;padding:9px 14px;}
.srch-box input{background:none;border:none;outline:none;color:#8b949e;font-size:14px;width:100%;font-family:'Inter',sans-serif;}
.tb-btn{display:flex;flex-direction:column;align-items:center;gap:2px;padding:7px 11px;background:#1c2130;border-radius:10px;cursor:pointer;border:none;color:#fff;}
.tb-btn span{font-size:10px;color:#8b949e;font-weight:500;}

/* TICKER */
.strip{height:36px;background:#0e1016;border-bottom:1px solid #1a1f2e;overflow:hidden;display:flex;align-items:center;flex-shrink:0;}
.strip-inner{display:flex;animation:scroll 50s linear infinite;white-space:nowrap;}
@keyframes scroll{from{transform:translateX(0)}to{transform:translateX(-50%)}}
.si{display:inline-flex;align-items:center;gap:6px;padding:0 14px;border-right:1px solid #1a1f2e;}
.si-n{font-size:13px;color:#9ba3ae;font-weight:500;}
.si-p{font-size:13px;font-weight:700;color:#fff;}
.si-c{font-size:12px;font-weight:600;}
.up{color:#17c3a8!important;}.dn{color:#f0627a!important;}

/* H-TABS */
.h-tabs{display:flex;background:#0e1016;border-bottom:1px solid #1a1f2e;flex-shrink:0;overflow-x:auto;}
.h-tabs::-webkit-scrollbar{height:0;}
.htab{padding:12px 16px;font-size:14px;font-weight:500;color:#8b949e;cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;}
.htab.act{color:#fff;border-bottom-color:#fff;}
.htab-gear{margin-left:auto;padding:12px 14px;color:#8b949e;flex-shrink:0;}

/* INDEX HEADER */
.idx-hdr{padding:14px 16px 8px;flex-shrink:0;}
.idx-top{display:flex;align-items:flex-start;justify-content:space-between;}
.idx-name{font-size:20px;font-weight:700;color:#fff;display:flex;align-items:center;gap:6px;cursor:pointer;}
.idx-name select{background:transparent;border:none;outline:none;color:#fff;font-size:20px;font-weight:700;cursor:pointer;appearance:none;-webkit-appearance:none;}
.idx-arrow{color:#8b949e;}
.idx-price{font-size:28px;font-weight:700;color:#fff;margin-top:4px;}
.idx-chg{font-size:14px;font-weight:600;margin-top:2px;}
.idx-exch{font-size:12px;color:#8b949e;margin-left:8px;font-weight:400;}

/* CHART TABS */
.chart-tabs{display:flex;border-bottom:1px solid #1a1f2e;flex-shrink:0;}
.ctab{padding:11px 16px;font-size:14px;color:#8b949e;border-bottom:2px solid transparent;cursor:pointer;font-weight:500;}
.ctab.act{color:#fff;border-bottom-color:#fff;}

/* CHART CONTROLS */
.chart-ctrl{display:flex;align-items:center;border-bottom:1px solid #1a1f2e;padding:8px 4px;}
.cc{display:flex;flex-direction:column;align-items:center;gap:3px;flex:1;cursor:pointer;padding:4px 6px;}
.cc-i{font-size:17px;color:#8b949e;}
.cc-t{font-size:13px;font-weight:600;color:#fff;}
.cc-l{font-size:10px;color:#8b949e;}

/* LIVE SNAPSHOT */
.lsnap{padding:16px;}
.lsnap-t{font-size:17px;font-weight:600;color:#fff;margin-bottom:16px;}
.snap-row{margin-bottom:18px;}
.snap-lbl{display:flex;justify-content:space-between;margin-bottom:8px;}
.snap-lo{font-size:12px;color:#8b949e;}
.snap-hi{font-size:12px;color:#8b949e;text-align:right;}
.snap-lv{font-size:16px;font-weight:700;color:#fff;margin-top:2px;}
.snap-bar{height:4px;background:#1c2130;border-radius:2px;position:relative;}
.snap-fill{height:100%;background:#17c3a8;border-radius:2px;}
.snap-dot{position:absolute;top:-4px;width:12px;height:12px;background:#fff;border-radius:50%;border:2px solid #17c3a8;margin-left:-6px;}

/* FU-OC BUTTONS */
.fo-row{display:flex;gap:10px;padding:0 16px 14px;}
.fo-btn{flex:1;display:flex;align-items:center;gap:8px;background:#1c2130;border-radius:12px;padding:14px 16px;cursor:pointer;border:none;color:#fff;font-size:14px;font-weight:600;}
.fo-btn svg{color:#8b949e;}
.fo-opt{background:linear-gradient(135deg,#5c2d91,#7c3aed);}
.fo-opt svg{color:#fff;}

/* SCALPER BANNER */
.scalper{margin:0 16px 16px;background:linear-gradient(135deg,#4a1d7a,#6d28d9);border-radius:14px;padding:16px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;}
.sc-t{font-size:15px;font-weight:700;color:#fff;}
.sc-s{font-size:12px;color:rgba(255,255,255,.65);margin-top:3px;}

/* SECTION HEADER */
.sec-hdr{display:flex;align-items:center;justify-content:space-between;padding:16px 16px 10px;}
.sec-ttl{font-size:16px;font-weight:700;color:#fff;display:flex;align-items:center;gap:6px;}
.sec-more{font-size:13px;font-weight:600;color:#fff;cursor:pointer;}

/* AI SIGNAL CARDS */
.ai-sig-row{display:flex;gap:10px;padding:0 16px 14px;overflow-x:auto;}
.ai-sig-row::-webkit-scrollbar{height:0;}
.ai-card{min-width:155px;background:#131820;border-radius:14px;padding:14px;cursor:pointer;border:1px solid #1a1f2e;flex-shrink:0;}
.ai-card-sym{font-size:16px;font-weight:700;color:#fff;margin-bottom:4px;}
.ai-card-pr{font-size:14px;color:#8b949e;margin-bottom:8px;}
.ai-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:700;}
.ai-badge.buy{background:#17c3a81a;color:#17c3a8;border:1px solid #17c3a840;}
.ai-badge.sell{background:#f0627a1a;color:#f0627a;border:1px solid #f0627a40;}
.ai-card-acc{font-size:11px;color:#8b949e;margin-top:6px;}

/* GLOBAL SNAPSHOT CARDS */
.g-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 16px 14px;}
.g-card{background:#131820;border-radius:14px;padding:14px;cursor:pointer;border:1px solid #1a1f2e;}
.g-flag{font-size:20px;margin-bottom:6px;}
.g-region{font-size:11px;color:#8b949e;font-weight:500;margin-bottom:3px;}
.g-name{font-size:15px;font-weight:700;color:#fff;margin-bottom:6px;}
.g-price{font-size:20px;font-weight:700;color:#fff;margin-bottom:2px;}
.g-chg{font-size:13px;font-weight:600;}

/* COMMODITY CARDS */
.comm-row{display:flex;gap:10px;padding:0 16px 14px;overflow-x:auto;}
.comm-row::-webkit-scrollbar{height:0;}
.c-card{min-width:120px;background:#131820;border-radius:14px;padding:14px;flex-shrink:0;cursor:pointer;border:1px solid #1a1f2e;}
.c-icon{font-size:24px;margin-bottom:8px;}
.c-name{font-size:12px;color:#8b949e;font-weight:500;margin-bottom:4px;text-transform:uppercase;}
.c-price{font-size:17px;font-weight:700;color:#fff;margin-bottom:2px;}
.c-chg{font-size:12px;font-weight:600;}

/* AI MARKET PULSE */
.pulse-card{margin:0 16px 14px;background:#131820;border-radius:14px;padding:16px;border:1px solid #1a1f2e;}
.pulse-hdr{display:flex;align-items:center;gap:8px;margin-bottom:12px;}
.pulse-dot{width:8px;height:8px;border-radius:50%;background:#17c3a8;animation:blink 1.5s infinite;}
.pulse-ttl{font-size:14px;font-weight:700;color:#fff;letter-spacing:.5px;}
.pulse-row{display:flex;align-items:flex-start;gap:10px;margin-bottom:10px;}
.pulse-ico{font-size:16px;flex-shrink:0;margin-top:1px;}
.pulse-txt{font-size:14px;color:#cccccc;line-height:1.6;}
.pulse-txt b{color:#fff;}

/* NEWS CARDS */
.news-row{display:flex;flex-direction:column;gap:0;}
.news-card{display:flex;gap:12px;padding:14px 16px;border-bottom:1px solid #0d1017;cursor:pointer;}
.news-img{width:72px;height:56px;border-radius:10px;object-fit:cover;flex-shrink:0;background:#1c2130;display:flex;align-items:center;justify-content:center;font-size:22px;}
.news-body{flex:1;}
.news-src{font-size:11px;color:#8b949e;font-weight:600;margin-bottom:4px;text-transform:uppercase;letter-spacing:.3px;}
.news-ttl{font-size:14px;font-weight:600;color:#fff;line-height:1.5;margin-bottom:4px;}
.news-time{font-size:11px;color:#8b949e;}
.news-bull{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px;}

/* TOP PICKS */
.pick-row{display:flex;gap:10px;padding:0 16px 14px;overflow-x:auto;}
.pick-row::-webkit-scrollbar{height:0;}
.pick-card{min-width:160px;background:#131820;border-radius:14px;padding:14px;flex-shrink:0;cursor:pointer;border:1px solid #1a1f2e;}
.pick-sym{font-size:16px;font-weight:700;color:#fff;margin-bottom:2px;}
.pick-name{font-size:11px;color:#8b949e;margin-bottom:8px;}
.pick-pr{font-size:18px;font-weight:700;color:#fff;margin-bottom:4px;}
.pick-chg{font-size:13px;font-weight:600;}
.pick-badge{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:6px;font-size:11px;font-weight:700;margin-top:6px;}

/* VOICE BUTTON */
/* ‚îÄ‚îÄ SENSIBULL OPTIONS CHAIN ‚îÄ‚îÄ */
.oc-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
.oc-table{width:100%;border-collapse:collapse;min-width:580px;}
.oc-table th{font-size:10px;font-weight:700;color:#8b949e;text-transform:uppercase;letter-spacing:.4px;padding:8px 6px;border-bottom:1px solid #1a1f2e;position:sticky;top:0;background:#0e1016;z-index:2;}
.oc-table td{font-size:12px;font-weight:600;padding:7px 6px;border-bottom:1px solid #0d1017;text-align:center;cursor:pointer;transition:background .15s;}
.oc-table tr:hover td{background:#131820;}
.oc-ce{color:#17c3a8;}.oc-pe{color:#f0627a;}
.oc-atm td{background:#17c3a808!important;}
.oc-strike{font-size:13px;font-weight:800;color:#fff;background:#1c2130!important;}
.pcr-bar{padding:10px 16px;background:#131820;display:flex;align-items:center;gap:10px;border-bottom:1px solid #1a1f2e;flex-shrink:0;}
.bk-broker-card{background:#131820;border:2px solid #1a1f2e;border-radius:16px;padding:18px 14px;text-align:center;cursor:pointer;transition:all .2s;position:relative;}
.bk-broker-card:active{transform:scale(.95);}
.bk-broker-card.connected{border-color:#17c3a8;}
.strat-card{background:#131820;border:1px solid #1a1f2e;border-radius:14px;margin:0 16px 12px;padding:16px;cursor:pointer;}
.strat-leg{font-size:11px;font-weight:600;padding:3px 8px;border-radius:6px;}
.strat-leg.buy{background:#17c3a81a;color:#17c3a8;border:1px solid #17c3a840;}
.strat-leg.sell{background:#f0627a1a;color:#f0627a;border:1px solid #f0627a40;}
.strat-leg.neutral{background:#f59e0b1a;color:#f59e0b;border:1px solid #f59e0b40;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.fade-up{animation:fadeUp .25s ease forwards;}

.voice-fab{position:fixed;bottom:80px;right:18px;width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#1a6b5e,#17c3a8);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:100;box-shadow:0 4px 20px rgba(23,195,168,.4);border:none;}
.voice-fab svg{color:#fff;}
.voice-fab.listening{animation:pulse-ring 1s infinite;}
@keyframes pulse-ring{0%{box-shadow:0 0 0 0 rgba(23,195,168,.5)}70%{box-shadow:0 0 0 14px rgba(23,195,168,0)}100%{box-shadow:0 0 0 0 rgba(23,195,168,0)}}

/* WATCHLIST */
.wl-hdr{padding:22px 16px 8px;}
.wl-t{font-size:28px;font-weight:700;color:#fff;letter-spacing:-.5px;}
.wl-tabs{display:flex;gap:6px;padding:6px 16px 12px;flex-shrink:0;}
.wltab{padding:8px 16px;border-radius:20px;font-size:14px;font-weight:500;cursor:pointer;border:1px solid #1c2130;color:#8b949e;background:transparent;}
.wltab.act{background:#fff;color:#000;border-color:#fff;}
.rdot{display:inline-block;width:8px;height:8px;background:#f0627a;border-radius:50%;margin-right:5px;animation:blink 1.5s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
.scan-tabs{display:flex;gap:6px;padding:8px 16px;overflow-x:auto;flex-shrink:0;}
.scan-tabs::-webkit-scrollbar{height:0;}
.stab{padding:7px 14px;border-radius:20px;font-size:13px;font-weight:500;border:1px solid #2a2f3e;color:#8b949e;cursor:pointer;background:transparent;white-space:nowrap;}
.stab.act{background:#fff;color:#000;border-color:#fff;}
.idx-filter{display:flex;align-items:center;justify-content:space-between;padding:4px 16px 10px;}
.ifl{font-size:13px;color:#8b949e;}
.ifd{display:flex;align-items:center;gap:6px;background:#1c2130;padding:7px 14px;border-radius:20px;font-size:13px;font-weight:600;color:#fff;cursor:pointer;}
.col-hdr{display:flex;padding:8px 16px;background:#0a0d14;}
.col-hdr span{font-size:11px;color:#8b949e;font-weight:500;letter-spacing:.4px;text-transform:uppercase;}
.wl-row{display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #0d1017;cursor:pointer;}
.wl-row:active{background:#131820;}
.wl-lf{flex:1;}
.wl-nm{font-size:17px;font-weight:600;color:#fff;margin-bottom:3px;}
.wl-sb{font-size:13px;color:#8b949e;}
.wl-oi{width:115px;text-align:right;padding-right:6px;}
.wl-ov{font-size:15px;font-weight:600;margin-bottom:2px;}
.wl-op{font-size:12px;font-weight:600;}
.wl-rt{width:100px;text-align:right;}
.wl-pr{font-size:17px;font-weight:700;color:#fff;margin-bottom:2px;}
.wl-ch{font-size:13px;font-weight:600;}
.list-tabs{display:flex;border-bottom:1px solid #1a1f2e;overflow-x:auto;flex-shrink:0;align-items:center;}
.list-tabs::-webkit-scrollbar{height:0;}
.ltab{padding:10px 14px;font-size:14px;font-weight:500;color:#8b949e;cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;}
.ltab.act{color:#fff;border-bottom-color:#fff;}
.ltab-ic{padding:10px 12px;color:#8b949e;font-size:18px;cursor:pointer;}
.add-stock{display:flex;align-items:center;gap:10px;background:#1c2130;margin:10px 16px;padding:12px 16px;border-radius:12px;cursor:pointer;border:none;color:#8b949e;font-size:14px;font-weight:500;width:calc(100% - 32px);}

/* DETAIL */
.det-hdr{padding:12px 16px 0;flex-shrink:0;}
.det-nav{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.bk-btn{width:34px;height:34px;border-radius:8px;background:#1c2130;display:flex;align-items:center;justify-content:center;border:none;color:#fff;font-size:16px;cursor:pointer;flex-shrink:0;}
.det-info{flex:1;}
.det-sym{font-size:20px;font-weight:700;color:#fff;display:flex;align-items:center;gap:8px;}
.det-badge{font-size:11px;color:#8b949e;background:#1c2130;padding:2px 8px;border-radius:4px;}
.det-price{font-size:28px;font-weight:700;color:#fff;margin-top:2px;}
.det-chg{font-size:14px;font-weight:600;margin-top:2px;}
.det-tabs{display:flex;border-bottom:1px solid #1a1f2e;overflow-x:auto;flex-shrink:0;}
.det-tabs::-webkit-scrollbar{height:0;}
.dtab{padding:11px 16px;font-size:14px;color:#8b949e;border-bottom:2px solid transparent;cursor:pointer;white-space:nowrap;font-weight:500;}
.dtab.act{color:#fff;border-bottom-color:#fff;}

/* TRADE BAR */
.trade-bar{display:flex;gap:10px;padding:12px 16px;background:#0e1016;border-top:1px solid #1a1f2e;flex-shrink:0;}
.buy-btn{flex:1;padding:14px;background:#17c3a8;border:none;border-radius:12px;font-size:16px;font-weight:700;color:#000;cursor:pointer;}
.sell-btn{flex:1;padding:14px;background:#f0627a;border:none;border-radius:12px;font-size:16px;font-weight:700;color:#fff;cursor:pointer;}

/* ORDERS */
.pg-hdr{padding:22px 16px 8px;flex-shrink:0;}
.pg-t{font-size:28px;font-weight:700;color:#fff;}
.pg-tabs{display:flex;border-bottom:1px solid #1a1f2e;padding:0 16px;flex-shrink:0;}
.pgtab{padding:12px 16px;font-size:14px;color:#8b949e;border-bottom:2px solid transparent;cursor:pointer;font-weight:500;}
.pgtab.act{color:#fff;border-bottom-color:#fff;font-weight:600;}
.ord-row{display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #0d1017;cursor:pointer;}
.or-l{flex:1;}
.or-sym{font-size:16px;font-weight:600;color:#fff;margin-bottom:3px;}
.or-det{font-size:13px;color:#8b949e;}
.or-r{text-align:right;}
.or-st{font-size:13px;font-weight:600;margin-bottom:3px;}
.or-amt{font-size:14px;font-weight:700;color:#fff;}
.empty-st{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:12px;color:#8b949e;padding:40px;}
.empty-st svg{opacity:.25;}
.empty-t{font-size:17px;font-weight:600;color:#fff;}

/* PORTFOLIO */
.pf-sum{margin:12px 16px;background:#131820;border-radius:16px;padding:20px;}
.pf-lbl{font-size:13px;color:#8b949e;margin-bottom:4px;}
.pf-val{font-size:32px;font-weight:700;color:#fff;}
.pf-ret{font-size:14px;font-weight:600;margin-top:4px;}
.pf-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:16px;}
.pf-cell{background:#0e1016;border-radius:10px;padding:10px;}
.pf-cl{font-size:12px;color:#8b949e;margin-bottom:4px;}
.pf-cv{font-size:15px;font-weight:700;color:#fff;}
.hold-row{display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #0d1017;cursor:pointer;}
.h-ico{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;margin-right:12px;flex-shrink:0;}
.h-l{flex:1;}
.h-nm{font-size:16px;font-weight:600;color:#fff;margin-bottom:3px;}
.h-dt{font-size:13px;color:#8b949e;}
.h-r{text-align:right;}
.h-pnl{font-size:16px;font-weight:700;margin-bottom:2px;}
.h-pct{font-size:13px;font-weight:600;}

/* PROFILE */
.prof-pg{padding:0 16px 30px;}
.prof-av{width:76px;height:76px;background:#1a6b5e;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:30px;font-weight:700;color:#fff;margin:8px auto 12px;}
.prof-nm{font-size:22px;font-weight:700;color:#fff;text-align:center;}
.prof-lk{font-size:14px;color:#8b949e;text-align:center;margin-top:4px;display:flex;align-items:center;justify-content:center;gap:4px;cursor:pointer;}
.prof-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:16px 0;}
.pc{background:#1c2130;border-radius:14px;padding:16px 10px;text-align:center;cursor:pointer;}
.pc-ic{font-size:22px;margin-bottom:8px;}
.pc-v{font-size:15px;font-weight:700;color:#fff;margin-bottom:2px;}
.pc-l{font-size:12px;color:#8b949e;}
.sec-card{background:#1c2130;border-radius:14px;margin-bottom:10px;overflow:hidden;}
.sec-t{padding:14px 16px 4px;font-size:13px;font-weight:600;color:#8b949e;text-transform:uppercase;letter-spacing:.4px;}
.mr{display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #131820;cursor:pointer;}
.mr:last-child{border-bottom:none;}
.mr-ic{width:36px;height:36px;background:#131820;border-radius:9px;display:flex;align-items:center;justify-content:center;margin-right:12px;font-size:17px;}
.mr-l{flex:1;}
.mr-t{font-size:15px;font-weight:500;color:#fff;}
.mr-s{font-size:12px;color:#8b949e;margin-top:2px;}
.mr-arr{color:#8b949e;font-size:18px;}
.badge{background:#6d28d9;color:#fff;font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px;margin-left:6px;}

/* FUND GRID */
.fund-grid{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:#1a1f2e;border-radius:12px;overflow:hidden;margin-bottom:14px;}
.fc{background:#131820;padding:12px;}
.fc-l{font-size:12px;color:#8b949e;margin-bottom:4px;}
.fc-v{font-size:14px;font-weight:700;color:#fff;}

/* SIMILAR STOCKS */
.sim-cards{display:flex;gap:10px;overflow-x:auto;padding:12px 16px;}
.sim-cards::-webkit-scrollbar{height:0;}
.sim-card{min-width:150px;background:#1c2130;border-radius:12px;padding:12px;flex-shrink:0;cursor:pointer;}
.sim-nm{font-size:14px;font-weight:600;color:#fff;margin-bottom:4px;}
.sim-pr{font-size:16px;font-weight:700;color:#fff;}
.sim-ch{font-size:13px;font-weight:600;}

/* PCR / IV CHARTS */
.pcr-wrap{background:#131820;border-radius:12px;padding:12px;margin-bottom:14px;}
.pcr-legend{display:flex;gap:12px;margin-bottom:8px;}
.pcr-leg{display:flex;align-items:center;gap:5px;font-size:12px;color:#8b949e;}
.pcr-dot{width:9px;height:9px;border-radius:50%;}
.pcr-exp{margin-left:auto;font-size:12px;color:#8b949e;}

/* ORDER OVERLAY */
.ov{position:fixed;inset:0;z-index:500;display:none;align-items:flex-end;background:rgba(0,0,0,.75);}
.ov.on{display:flex;}
.ov-sheet{width:100%;background:#131820;border-radius:20px 20px 0 0;padding:18px 18px 40px;}
.ov-bar{width:32px;height:3px;background:#2a2f3e;border-radius:2px;margin:0 auto 16px;}
.ov-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;}
.ov-sym{font-size:18px;font-weight:700;color:#fff;}
.ov-mpr{font-size:13px;color:#8b949e;margin-top:3px;}
.ov-cls{width:28px;height:28px;background:#1c2130;border-radius:6px;border:none;color:#fff;font-size:14px;cursor:pointer;}
.ov-type{display:flex;gap:5px;background:#0e1016;padding:4px;border-radius:10px;margin-bottom:12px;}
.ov-tt{flex:1;padding:8px;border-radius:7px;border:none;background:transparent;font-size:13px;font-weight:600;cursor:pointer;color:#8b949e;}
.ov-tt.b-a{background:#17c3a8;color:#000;}
.ov-tt.s-a{background:#f0627a;color:#fff;}
.ov-seg{display:flex;gap:4px;background:#0e1016;padding:3px;border-radius:9px;margin-bottom:12px;}
.ov-sb{flex:1;padding:7px;border-radius:7px;border:none;background:transparent;font-size:12px;cursor:pointer;color:#8b949e;text-align:center;}
.ov-sb.act{background:#1c2130;color:#fff;}
.ov-lbl{font-size:12px;color:#8b949e;margin-bottom:5px;font-weight:500;}
.ov-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}
.ov-inp{width:100%;background:#0e1016;border:1px solid #2a2f3e;border-radius:9px;padding:12px;color:#fff;font-size:15px;font-weight:600;outline:none;font-family:'Inter',sans-serif;}
.ov-inp:focus{border-color:#17c3a8;}
.ov-mg{display:flex;justify-content:space-between;background:#1a1f2e;border-radius:9px;padding:12px;margin-bottom:12px;}
.ov-mg span:first-child{font-size:13px;color:#8b949e;}
.ov-mg span:last-child{font-size:14px;font-weight:700;}
.ov-submit-buy{width:100%;padding:14px;border:none;border-radius:12px;background:#17c3a8;color:#000;font-size:16px;font-weight:700;cursor:pointer;}
.ov-submit-sell{width:100%;padding:14px;border:none;border-radius:12px;background:#f0627a;color:#fff;font-size:16px;font-weight:700;cursor:pointer;}

/* BOTTOM NAV */
.bnav{height:64px;display:flex;align-items:center;justify-content:space-around;background:#0e1016;border-top:1px solid #1a1f2e;flex-shrink:0;}
.bn{display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;padding:6px 12px;}
.bn-ic{font-size:22px;opacity:.35;line-height:1;}
.bn-lb{font-size:10px;font-weight:500;color:#8b949e;}
.bn.act .bn-ic{opacity:1;}
.bn.act .bn-lb{color:#fff;}
.trade-fab{width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#5c2d91,#7c3aed);display:flex;align-items:center;justify-content:center;cursor:pointer;margin-top:-18px;box-shadow:0 4px 20px rgba(109,40,217,.5);}

/* NOTIF */
.notif{position:fixed;top:72px;left:50%;transform:translateX(-50%) translateY(-10px);background:#1c2130;border:1px solid #2a2f3e;border-radius:14px;padding:12px 16px;z-index:700;opacity:0;pointer-events:none;transition:all .25s;min-width:280px;max-width:90vw;box-shadow:0 8px 40px rgba(0,0,0,.7);}
.notif.on{opacity:1;transform:translateX(-50%) translateY(0);}
.n-t{font-size:13px;font-weight:700;color:#fff;margin-bottom:2px;}
.n-b{font-size:12px;color:#8b949e;}
</style>
</head>
<body>
<div class="app">

<!-- ‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê -->
<div class="scr on" id="homeScreen">
  <div class="topbar">
    <div class="srch-box">
      <svg width="15" height="15" fill="none" stroke="#8b949e" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input placeholder="Search futures, stocks, indices..." readonly>
    </div>
    <div class="tb-btn" onclick="goTo('funds')">
      <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      <span>Funds</span>
    </div>
    <div class="tb-btn" onclick="showAlertsScreen()" style="position:relative;">
      <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
      <span id="alertBadge" style="display:none;position:absolute;top:4px;right:6px;width:8px;height:8px;background:#f0627a;border-radius:50%;"></span>
      <span>Alerts</span>
    </div>
    <div class="tb-btn" onclick="goTo('profile')">
      <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span>Profile</span>
    </div>
  </div>
  <div class="strip" id="strip"></div>
  <div class="h-tabs">
    <div class="htab act" onclick="setHTab(this,'fo')">F&O</div>
    <div class="htab" onclick="setHTab(this,'stocks')">Stocks</div>
    <div class="htab" onclick="setHTab(this,'research')">Research</div>
    <div class="htab" onclick="setHTab(this,'ipo')">IPO</div>
    <div class="htab" onclick="setHTab(this,'etfs')">ETFs</div>
    <div class="htab-gear">‚öôÔ∏è</div>
  </div>
  <div class="cnt" id="homeC"></div>
</div>

<!-- ‚ïê‚ïê‚ïê WATCHLIST ‚ïê‚ïê‚ïê -->
<div class="scr" id="watchlistScreen">
  <div class="wl-hdr"><div class="wl-t">My Watchlist</div></div>
  <div class="wl-tabs">
    <div class="wltab" id="wt0" onclick="setWTab('mylist')">My Lists</div>
    <div class="wltab" id="wt1" onclick="setWTab('scanner')"><span class="rdot"></span>Stock Scanners</div>
    <div class="wltab" id="wt2" onclick="setWTab('recent')">Recently viewed</div>
  </div>
  <div class="cnt" id="wlC"></div>
</div>

<!-- ‚ïê‚ïê‚ïê ORDERS ‚ïê‚ïê‚ïê -->
<div class="scr" id="ordersScreen">
  <div class="pg-hdr"><div class="pg-t">Orders</div></div>
  <div class="pg-tabs">
    <div class="pgtab act">Pending</div>
    <div class="pgtab">Executed</div>
    <div class="pgtab">All</div>
  </div>
  <div class="cnt" id="ordersC"></div>
</div>

<!-- ‚ïê‚ïê‚ïê PORTFOLIO ‚ïê‚ïê‚ïê -->
<div class="scr" id="portfolioScreen">
  <div class="pg-hdr"><div class="pg-t">Portfolio</div></div>
  <div class="pg-tabs">
    <div class="pgtab act">Holdings</div>
    <div class="pgtab">Positions</div>
  </div>
  <div class="cnt" id="pfC"></div>
</div>

<!-- ‚ïê‚ïê‚ïê DETAIL ‚ïê‚ïê‚ïê -->
<div class="scr" id="detailScreen">
  <div class="det-hdr">
    <div class="det-nav">
      <button class="bk-btn" onclick="goBack()">‚Üê</button>
      <div class="det-info">
        <div class="det-sym">
          <span id="dSym">RELIANCE</span>
          <span style="color:#8b949e;font-size:14px;cursor:pointer;" onclick="">‚ñº</span>
          <span class="det-badge" id="dExch">NSE</span>
        </div>
        <div class="det-price" id="dPrice">‚Çπ2,847</div>
        <div class="det-chg dn" id="dChg">-15.95 (0.56%)</div>
      </div>
      <div style="width:34px;height:34px;background:#1c2130;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#8b949e;font-size:16px;margin-left:auto;">üîç</div>
    </div>
  </div>
  <div class="det-tabs" id="detTabs">
    <div class="dtab act" onclick="setDTab(this,'chart')">Chart</div>
    <div class="dtab" onclick="setDTab(this,'options')">Options analytics</div>
    <div class="dtab" onclick="setDTab(this,'fundamentals')">Fundamentals</div>
    <div class="dtab" onclick="setDTab(this,'shareholding')">Shareholding</div>
  </div>
  <div class="cnt" id="detC"></div>
  <div class="trade-bar">
    <button class="buy-btn" onclick="openOrder('BUY')">Buy</button>
    <button class="sell-btn" onclick="openOrder('SELL')">Sell</button>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê FUNDS SCREEN ‚ïê‚ïê‚ïê -->
<div class="scr" id="fundsScreen">
  <div style="display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #1a1f2e;flex-shrink:0;">
    <button class="bk-btn" onclick="goTo('profile')">‚Üê</button>
    <div style="font-size:20px;font-weight:700;color:#fff;margin-left:12px;">üí∞ Funds & Payments</div>
  </div>
  <div class="cnt" id="fundsC"></div>
</div>

<!-- ‚ïê‚ïê‚ïê BROKER LOGIN SCREEN (Sensibull-style) ‚ïê‚ïê‚ïê -->
<div class="scr" id="brokerScreen">
  <div class="cnt" id="brokerC"></div>
</div>

<!-- ‚ïê‚ïê‚ïê OPTIONS CHAIN SCREEN ‚ïê‚ïê‚ïê -->
<div class="scr" id="optchainScreen">
  <div style="display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #1a1f2e;flex-shrink:0;">
    <button class="bk-btn" onclick="goTo('home')">‚Üê</button>
    <div id="ocTitle" style="font-size:18px;font-weight:700;color:#fff;margin-left:12px;">NIFTY Option Chain</div>
    <div style="margin-left:auto;display:flex;gap:8px;">
      <select id="ocExpiry" onchange="buildOptionChain()" style="background:#1c2130;border:1px solid #2a2f3e;border-radius:8px;color:#fff;padding:6px 10px;font-size:12px;outline:none;">
        <option>27 Mar 25</option><option>03 Apr 25</option><option>10 Apr 25</option><option>17 Apr 25</option>
      </select>
    </div>
  </div>
  <!-- PCR Bar -->
  <div id="ocPCRBar" style="flex-shrink:0;"></div>
  <!-- Chain table -->
  <div class="cnt" id="optchainC"></div>
</div>

<!-- ‚ïê‚ïê‚ïê STRATEGY BUILDER SCREEN ‚ïê‚ïê‚ïê -->
<div class="scr" id="strategyScreen">
  <div style="display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #1a1f2e;flex-shrink:0;">
    <button class="bk-btn" onclick="goTo('home')">‚Üê</button>
    <div style="font-size:18px;font-weight:700;color:#fff;margin-left:12px;">üß† Strategy Builder</div>
    <div style="margin-left:auto;font-size:11px;color:#17c3a8;font-weight:600;">AI Powered</div>
  </div>
  <div class="cnt" id="strategyC"></div>
</div>

<!-- ‚ïê‚ïê‚ïê DEMAT SCREEN ‚ïê‚ïê‚ïê -->
<div class="scr" id="dematScreen">
  <div style="display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #1a1f2e;flex-shrink:0;">
    <button class="bk-btn" onclick="goTo('profile')">‚Üê</button>
    <div style="font-size:20px;font-weight:700;color:#fff;margin-left:12px;">üìÇ Open Demat Account</div>
  </div>
  <div class="cnt" id="dematC"></div>
</div>

<!-- ‚ïê‚ïê‚ïê API SETTINGS SCREEN ‚ïê‚ïê‚ïê -->
<div class="scr" id="apiScreen">
  <div style="display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #1a1f2e;flex-shrink:0;">
    <button class="bk-btn" onclick="goTo('profile')">‚Üê</button>
    <div style="font-size:20px;font-weight:700;color:#fff;margin-left:12px;">‚öôÔ∏è API Settings</div>
  </div>
  <div class="cnt" id="apiC"></div>
</div>

<!-- ‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê -->
<div class="scr" id="profileScreen">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;flex-shrink:0;">
    <button class="bk-btn" onclick="goTo('home')">‚Üê</button>
    <span style="color:#8b949e;cursor:pointer;font-size:18px;">‚öôÔ∏è</span>
  </div>
  <div class="cnt" id="profC"></div>
</div>

<!-- ‚ïê‚ïê‚ïê BOTTOM NAV ‚ïê‚ïê‚ïê -->
<div class="bnav" id="bnav">
  <div class="bn act" id="bn-home" onclick="goTo('home')"><div class="bn-ic">üè†</div><div class="bn-lb">Home</div></div>
  <div class="bn" id="bn-watchlist" onclick="goTo('watchlist')"><div class="bn-ic">üîñ</div><div class="bn-lb">Watchlist</div></div>
  <div class="trade-fab" onclick="openOrder('BUY')">
    <svg width="22" height="22" fill="none" stroke="#fff" stroke-width="2.5" viewBox="0 0 24 24"><path d="M7 16V4m0 0L3 8m4-4 4 4M17 8v12m0 0 4-4m-4 4-4-4"/></svg>
  </div>
  <div class="bn" id="bn-orders" onclick="goTo('orders')"><div class="bn-ic">üìã</div><div class="bn-lb">Orders</div></div>
  <div class="bn" id="bn-portfolio" onclick="goTo('portfolio')"><div class="bn-ic">üíº</div><div class="bn-lb">Portfolio</div></div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê ORDER OVERLAY ‚ïê‚ïê‚ïê -->
<div class="ov" id="ov" onclick="if(event.target===this)closeOrder()">
  <div class="ov-sheet">
    <div class="ov-bar"></div>
    <div class="ov-top">
      <div>
        <div class="ov-sym" id="ovSym">RELIANCE</div>
        <div class="ov-mpr" id="ovMPr">‚Çπ2,847 ¬∑ NSE</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="ov-type" style="margin:0;">
          <button class="ov-tt b-a" id="ovB" onclick="setOT('BUY')">BUY</button>
          <button class="ov-tt" id="ovS" onclick="setOT('SELL')">SELL</button>
        </div>
        <button class="ov-cls" onclick="closeOrder()">‚úï</button>
      </div>
    </div>
    <div class="ov-seg" id="ovSeg1">
      <button class="ov-sb act" onclick="oS(this)">Intraday</button>
      <button class="ov-sb" onclick="oS(this)">Delivery</button>
      <button class="ov-sb" onclick="oS(this)">MTF</button>
    </div>
    <div class="ov-seg" id="ovSeg2">
      <button class="ov-sb act" onclick="oS(this)">LIMIT</button>
      <button class="ov-sb" onclick="oS(this)">MARKET</button>
      <button class="ov-sb" onclick="oS(this)">SL</button>
      <button class="ov-sb" onclick="oS(this)">SL-M</button>
    </div>
    <div class="ov-row">
      <div><div class="ov-lbl">PRICE (‚Çπ)</div><input class="ov-inp" type="number" id="ovPr" oninput="calcMg()"></div>
      <div><div class="ov-lbl">QUANTITY</div><input class="ov-inp" type="number" id="ovQt" value="1" oninput="calcMg()"></div>
    </div>
    <div class="ov-mg"><span>Margin Required</span><span id="ovMg">‚Çπ569</span></div>
    <button class="ov-submit-buy" id="ovBtn" onclick="placeOrder()">‚ö° Confirm BUY</button>
  </div>
</div>

<!-- VOICE FAB -->
<button class="voice-fab" id="voiceBtn" onclick="toggleVoice()">
  <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
</button>

<!-- NOTIF -->
<div class="notif" id="notif">
  <div style="display:flex;gap:10px;align-items:flex-start;">
    <span id="nIco" style="font-size:18px;">üìà</span>
    <div><div class="n-t" id="nTit"></div><div class="n-b" id="nBod"></div></div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const IDXS=[
  {s:'NIFTY 50',  p:25178.65,c:-317.90,pct:-1.25,e:'NSE'},
  {s:'BANKNIFTY', p:53490.25,c:-858.70,pct:-1.58,e:'NSE'},
  {s:'SENSEX',    p:81287.19,c:-961.42,pct:-1.17,e:'BSE'},
  {s:'FINNIFTY',  p:23842.10,c:-198.45,pct:-0.82,e:'NSE'},
  {s:'GIFTNIFTY', p:25195.00,c:+16.35, pct:+0.06,e:'SGX'},
  {s:'MIDCPNIFTY',p:12847.30,c:-87.20, pct:-0.67,e:'NSE'},
];
const GIDX=[
  // US
  {s:'DOW JONES',   p:38847,  c:+0.62,f:'üá∫üá∏',r:'USA'},
  {s:'S&P 500',     p:4924,   c:+0.48,f:'üá∫üá∏',r:'USA'},
  {s:'NASDAQ',      p:15628,  c:+0.91,f:'üá∫üá∏',r:'USA'},
  {s:'RUSSELL 2000',p:2042,   c:+0.34,f:'üá∫üá∏',r:'USA'},
  // ASIA
  {s:'NIKKEI 225',  p:37785,  c:+1.24,f:'üáØüáµ',r:'Japan'},
  {s:'HANG SENG',   p:16482,  c:-1.12,f:'üá≠üá∞',r:'HK'},
  {s:'SHANGHAI',    p:3024,   c:-0.87,f:'üá®üá≥',r:'China'},
  {s:'KOSPI',       p:2487,   c:+0.43,f:'üá∞üá∑',r:'Korea'},
  {s:'STI',         p:3248,   c:+0.43,f:'üá∏üá¨',r:'Singapore'},
  {s:'ASX 200',     p:7684,   c:+0.28,f:'üá¶üá∫',r:'Australia'},
  // EUROPE
  {s:'FTSE 100',    p:7682,   c:-0.23,f:'üá¨üáß',r:'UK'},
  {s:'DAX',         p:18234,  c:+0.54,f:'üá©üá™',r:'Germany'},
  {s:'CAC 40',      p:7834,   c:+0.32,f:'üá´üá∑',r:'France'},
  {s:'EURO STOXX',  p:4834,   c:+0.18,f:'üá™üá∫',r:'Europe'},
];
const COMM=[
  {s:'GOLD',        p:2028.40,c:+0.32,i:'ü•á',u:'USD/oz'},
  {s:'SILVER',      p:23.84,  c:-0.18,i:'ü•à',u:'USD/oz'},
  {s:'CRUDE OIL',   p:78.42,  c:-0.63,i:'üõ¢Ô∏è',u:'USD/bbl'},
  {s:'BRENT',       p:82.14,  c:-0.48,i:'‚ö´',u:'USD/bbl'},
  {s:'NAT GAS',     p:2.84,   c:+1.24,i:'‚õΩ',u:'USD/MMBtu'},
  {s:'COPPER',      p:3.84,   c:+0.54,i:'üî∂',u:'USD/lb'},
  {s:'PLATINUM',    p:918,    c:+0.21,i:'üíé',u:'USD/oz'},
  {s:'PALLADIUM',   p:1024,   c:-0.84,i:'üîò',u:'USD/oz'},
  {s:'ALUMINIUM',   p:2234,   c:+0.38,i:'‚¨ú',u:'USD/t'},
  {s:'ZINC',        p:2534,   c:-0.24,i:'üî≤',u:'USD/t'},
  {s:'MCX GOLD',    p:62480,  c:+0.42,i:'ü•á',u:'‚Çπ/10g'},
  {s:'MCX SILVER',  p:74320,  c:-0.28,i:'ü•à',u:'‚Çπ/kg'},
  {s:'MCX CRUDE',   p:6542,   c:-0.58,i:'üõ¢Ô∏è',u:'‚Çπ/bbl'},
];
const STOCKS=[
  // ‚îÄ‚îÄ LARGE CAP ‚îÄ‚îÄ
  {s:'RELIANCE',  n:'Reliance Industries',       p:2847.30,c:-15.40,pct:-0.54,sec:'Oil & Gas',   col:'#17c3a8'},
  {s:'HDFCBANK',  n:'HDFC Bank Ltd',             p:1623.80,c:+8.45, pct:+0.52,sec:'Banking',     col:'#6b88ff'},
  {s:'ICICIBANK', n:'ICICI Bank',                p:1089.60,c:+22.80,pct:+2.14,sec:'Banking',     col:'#f0627a'},
  {s:'TCS',       n:'Tata Consultancy Services', p:3912.50,c:+34.10,pct:+0.88,sec:'IT',          col:'#a78bfa'},
  {s:'INFOSYS',   n:'Infosys Ltd',               p:1782.40,c:+12.30,pct:+0.70,sec:'IT',          col:'#34d399'},
  {s:'WIPRO',     n:'Wipro Ltd',                 p:498.35, c:-2.80, pct:-0.56,sec:'IT',          col:'#fb923c'},
  {s:'TATAMOTORS',n:'Tata Motors Ltd',           p:982.70, c:+30.50,pct:+3.21,sec:'Auto',        col:'#22d3ee'},
  {s:'BAJFINANCE',n:'Bajaj Finance Ltd',         p:7234.50,c:+134.2,pct:+1.89,sec:'NBFC',        col:'#f59e0b'},
  {s:'TATASTEEL', n:'Tata Steel Ltd',            p:142.60, c:-1.40, pct:-0.97,sec:'Metal',       col:'#94a3b8'},
  {s:'ONGC',      n:'ONGC Ltd',                  p:267.80, c:-2.00, pct:-0.74,sec:'Oil & Gas',   col:'#84cc16'},
  {s:'MARUTI',    n:'Maruti Suzuki India',       p:12437.5,c:+122.3,pct:+0.98,sec:'Auto',        col:'#6b88ff'},
  {s:'LTFH',      n:'L&T Finance Holdings',      p:283.95, c:+14.25,pct:+5.32,sec:'NBFC',        col:'#17c3a8'},
  // ‚îÄ‚îÄ BANKING ‚îÄ‚îÄ
  {s:'SBIN',      n:'State Bank of India',       p:812.40, c:+6.80, pct:+0.84,sec:'Banking',     col:'#22d3ee'},
  {s:'AXISBANK',  n:'Axis Bank Ltd',             p:1182.30,c:-8.40, pct:-0.71,sec:'Banking',     col:'#a78bfa'},
  {s:'KOTAKBANK', n:'Kotak Mahindra Bank',       p:1876.50,c:+12.60,pct:+0.68,sec:'Banking',     col:'#f0627a'},
  {s:'INDUSINDBK',n:'IndusInd Bank',             p:987.40, c:-14.20,pct:-1.42,sec:'Banking',     col:'#fb923c'},
  {s:'PNB',       n:'Punjab National Bank',      p:98.45,  c:+1.20, pct:+1.23,sec:'Banking',     col:'#f59e0b'},
  {s:'BANKBARODA',n:'Bank of Baroda',            p:234.80, c:+2.40, pct:+1.03,sec:'Banking',     col:'#84cc16'},
  {s:'CANBK',     n:'Canara Bank',               p:98.70,  c:-0.80, pct:-0.81,sec:'Banking',     col:'#94a3b8'},
  // ‚îÄ‚îÄ IT ‚îÄ‚îÄ
  {s:'HCLTECH',   n:'HCL Technologies',          p:1842.70,c:+28.40,pct:+1.56,sec:'IT',          col:'#6b88ff'},
  {s:'TECHM',     n:'Tech Mahindra',             p:1432.60,c:+18.70,pct:+1.32,sec:'IT',          col:'#34d399'},
  {s:'NAUKRI',    n:'Info Edge (Naukri)',         p:6842.30,c:+124.8,pct:+1.86,sec:'IT',          col:'#17c3a8'},
  {s:'PAYTM',     n:'One97 Communications',      p:432.80, c:-8.40, pct:-1.91,sec:'Fintech',     col:'#f0627a'},
  // ‚îÄ‚îÄ AUTO ‚îÄ‚îÄ
  {s:'BAJAJ-AUTO',n:'Bajaj Auto Ltd',            p:8934.20,c:+87.40,pct:+0.99,sec:'Auto',        col:'#f59e0b'},
  {s:'HEROMOTOCO',n:'Hero MotoCorp',             p:4834.60,c:+42.80,pct:+0.89,sec:'Auto',        col:'#22d3ee'},
  {s:'EICHERMOT', n:'Eicher Motors',             p:4234.80,c:-28.40,pct:-0.67,sec:'Auto',        col:'#a78bfa'},
  {s:'M&M',       n:'Mahindra & Mahindra',       p:2842.50,c:+68.40,pct:+2.46,sec:'Auto',        col:'#34d399'},
  // ‚îÄ‚îÄ PHARMA ‚îÄ‚îÄ
  {s:'SUNPHARMA', n:'Sun Pharmaceutical',        p:1734.80,c:+24.80,pct:+1.45,sec:'Pharma',      col:'#fb923c'},
  {s:'DRREDDY',   n:'Dr Reddys Laboratories',   p:6234.50,c:+84.20,pct:+1.37,sec:'Pharma',      col:'#17c3a8'},
  {s:'CIPLA',     n:'Cipla Ltd',                 p:1534.20,c:-12.80,pct:-0.83,sec:'Pharma',      col:'#6b88ff'},
  {s:'DIVISLAB',  n:'Divi\'s Laboratories',      p:4234.80,c:+48.20,pct:+1.15,sec:'Pharma',      col:'#f0627a'},
  // ‚îÄ‚îÄ INFRA & ENERGY ‚îÄ‚îÄ
  {s:'LT',        n:'Larsen & Toubro',           p:3487.25,c:+34.80,pct:+1.01,sec:'Infra',       col:'#f59e0b'},
  {s:'NTPC',      n:'NTPC Ltd',                  p:334.20, c:-7.65, pct:-2.24,sec:'Energy',      col:'#84cc16'},
  {s:'POWERGRID', n:'Power Grid Corp',           p:284.55, c:+2.40, pct:+0.85,sec:'Energy',      col:'#22d3ee'},
  {s:'TATAPOWER', n:'Tata Power',                p:382.75, c:-4.20, pct:-1.09,sec:'Energy',      col:'#a78bfa'},
  {s:'ADANIPORTS',n:'Adani Ports & SEZ',        p:1234.80,c:+18.40,pct:+1.51,sec:'Infra',       col:'#f0627a'},
  {s:'ADANIENT',  n:'Adani Enterprises',         p:2834.50,c:-28.40,pct:-0.99,sec:'Infra',       col:'#fb923c'},
  // ‚îÄ‚îÄ METALS ‚îÄ‚îÄ
  {s:'JSWSTEEL',  n:'JSW Steel Ltd',             p:842.60, c:+8.40, pct:+1.01,sec:'Metal',       col:'#94a3b8'},
  {s:'HINDALCO',  n:'Hindalco Industries',       p:634.80, c:+12.40,pct:+1.99,sec:'Metal',       col:'#17c3a8'},
  {s:'SAIL',      n:'Steel Authority of India',  p:127.40, c:-2.55, pct:-1.96,sec:'Metal',       col:'#6b88ff'},
  {s:'COALINDIA', n:'Coal India Ltd',            p:387.45, c:-9.20, pct:-2.31,sec:'Mining',      col:'#f59e0b'},
  // ‚îÄ‚îÄ CONSUMER ‚îÄ‚îÄ
  {s:'TITAN',     n:'Titan Company Ltd',         p:3267.80,c:+24.80,pct:+0.76,sec:'Consumer',    col:'#f0627a'},
  {s:'ASIANPAINT',n:'Asian Paints Ltd',          p:2834.60,c:-18.40,pct:-0.64,sec:'Consumer',    col:'#a78bfa'},
  {s:'NESTLEIND', n:'Nestle India Ltd',          p:24234.8,c:+182.4,pct:+0.76,sec:'Consumer',    col:'#34d399'},
  {s:'BRITANNIA', n:'Britannia Industries',      p:4834.50,c:+42.80,pct:+0.89,sec:'Consumer',    col:'#fb923c'},
  {s:'TATACONSUM',n:'Tata Consumer Products',   p:934.80, c:+8.40, pct:+0.91,sec:'Consumer',    col:'#22d3ee'},
  // ‚îÄ‚îÄ FINANCIAL ‚îÄ‚îÄ
  {s:'BAJAJFINSV',n:'Bajaj Finserv Ltd',         p:1634.80,c:+24.80,pct:+1.54,sec:'Financial',   col:'#17c3a8'},
  {s:'HDFCLIFE',  n:'HDFC Life Insurance',       p:624.30, c:-4.20, pct:-0.67,sec:'Insurance',   col:'#6b88ff'},
  // ‚îÄ‚îÄ NEW AGE ‚îÄ‚îÄ
  {s:'ZOMATO',    n:'Zomato Ltd',                p:198.40, c:-4.20, pct:-2.07,sec:'Food Tech',   col:'#f0627a'},
  {s:'HAL',       n:'Hindustan Aeronautics',     p:4234.80,c:+124.8,pct:+3.04,sec:'Defence',     col:'#f59e0b'},
  {s:'BEL',       n:'Bharat Electronics',        p:234.80, c:+4.80, pct:+2.09,sec:'Defence',     col:'#84cc16'},
  {s:'IRCTC',     n:'IRCTC Ltd',                 p:834.20, c:+12.40,pct:+1.51,sec:'Travel',      col:'#22d3ee'},
  {s:'DLF',       n:'DLF Ltd',                   p:834.60, c:-8.40, pct:-1.00,sec:'Real Estate', col:'#a78bfa'},
  {s:'GODREJPROP',n:'Godrej Properties',         p:1731.00,c:+34.80,pct:+2.05,sec:'Real Estate', col:'#34d399'},
  {s:'BPCL',      n:'BPCL Ltd',                  p:312.80, c:-2.40, pct:-0.76,sec:'Oil & Gas',   col:'#fb923c'},
  {s:'IOC',       n:'Indian Oil Corporation',    p:165.40, c:+1.80, pct:+1.10,sec:'Oil & Gas',   col:'#17c3a8'},
  {s:'GRASIM',    n:'Grasim Industries',         p:2634.80,c:+28.40,pct:+1.09,sec:'Cement',      col:'#6b88ff'},
  {s:'ULTRACEMCO',n:'UltraTech Cement',          p:10234.8,c:+84.80,pct:+0.84,sec:'Cement',      col:'#f0627a'},
];
const SCANS={
  gainers:   [{s:'Tejas Networks',p:435.85,c:+64.80,pct:+17.46},{s:'Redington',p:280.45,c:+35.90,pct:+14.68},{s:'Sarda Energy',p:551.60,c:+32.70,pct:+6.30},{s:'Sun TV Network',p:647.65,c:+36.25,pct:+5.93},{s:'L&T Tech Svcs',p:3512.40,c:+195.0,pct:+5.88},{s:'Chennai Petro',p:961.95,c:+45.50,pct:+4.96},{s:'Jaiprakash Power',p:15.25,c:+0.70,pct:+4.81},{s:'Finolex Cables',p:913.70,c:+40.35,pct:+4.62}],
  losers:    [{s:'LTFH',p:283.95,c:-15.95,pct:-5.32},{s:'Wipro',p:498.35,c:-18.80,pct:-3.63},{s:'Tata Steel',p:142.60,c:-4.45,pct:-3.02},{s:'ONGC',p:267.80,c:-7.20,pct:-2.62},{s:'Coal India',p:387.45,c:-9.20,pct:-2.31},{s:'NTPC',p:334.20,c:-7.65,pct:-2.24},{s:'BHEL',p:234.75,c:-4.90,pct:-2.04},{s:'SAIL',p:127.40,c:-2.55,pct:-1.96}],
  volume:    [{s:'RELIANCE',p:2847.30,c:-15.40,pct:-0.54,vol:'18.4Cr'},{s:'HDFCBANK',p:1623.80,c:+8.45,pct:+0.52,vol:'12.2Cr'},{s:'TATAMOTORS',p:982.70,c:+30.50,pct:+3.21,vol:'9.8Cr'},{s:'ICICIBANK',p:1089.60,c:+22.80,pct:+2.14,vol:'8.7Cr'},{s:'ZOMATO',p:198.40,c:-4.20,pct:-2.07,vol:'7.6Cr'}],
  shortcover:[{s:'Angel One',n:'Angel One Ltd',oi:'-21.38%',oiL:'308.32L',p:233.20,c:+5.40},{s:'LTFH',n:'L&T Finance Hldgs',oi:'-34.78%',oiL:'669.22L',p:283.95,c:+5.32},{s:'CAMS',n:'Computer Age Mgmt',oi:'-5.17%',oiL:'67.89L',p:677.60,c:+4.37},{s:'PPLPHARMA',n:'Piramal Pharma',oi:'-2.36%',oiL:'186.64L',p:156.13,c:+3.87},{s:'GODREJPROP',n:'Godrej Properties',oi:'-1.92%',oiL:'81.32L',p:1731.00,c:+3.72},{s:'UNOMINDA',n:'UNO Minda',oi:'-2.03%',oiL:'66.98L',p:1188.50,c:+3.42},{s:'BSE',n:'BSE Ltd',oi:'-18.53%',oiL:'107.43L',p:2707.10,c:+3.35},{s:'MANAPPURAM',n:'Manappuram Finance',oi:'-4.21%',oiL:'506.73L',p:283.25,c:+3.18}],
  shortbuild:[{s:'HDFCLIFE',n:'HDFC Life Insurance',oi:'+28.45%',oiL:'412.38L',p:624.30,c:-4.20},{s:'SBICARD',n:'SBI Cards',oi:'+19.32%',oiL:'287.64L',p:712.85,c:-3.95},{s:'INDUSTOWER',n:'Indus Towers',oi:'+15.67%',oiL:'523.41L',p:334.60,c:-3.75},{s:'MUTHOOTFIN',n:'Muthoot Finance',oi:'+12.88%',oiL:'178.92L',p:1842.45,c:-3.40},{s:'TATAPOWER',n:'Tata Power',oi:'+11.23%',oiL:'892.34L',p:382.75,c:-3.15},{s:'ZOMATO',n:'Zomato Ltd',oi:'+9.76%',oiL:'1243.67L',p:198.40,c:-2.90}],
  longbuild: [{s:'RELIANCE',n:'Reliance Industries',oi:'+18.43%',oiL:'1243.56L',p:2847.00,c:+1.53},{s:'HDFCBANK',n:'HDFC Bank Ltd',oi:'+14.21%',oiL:'2341.23L',p:1623.45,c:+1.38},{s:'ICICIBANK',n:'ICICI Bank',oi:'+12.67%',oiL:'3421.87L',p:1089.30,c:+2.11},{s:'TCS',n:'TCS Ltd',oi:'+9.34%',oiL:'456.78L',p:3912.00,c:+1.24},{s:'LT',n:'L&T Ltd',oi:'+8.76%',oiL:'678.34L',p:3487.25,c:+1.67},{s:'MARUTI',n:'Maruti Suzuki',oi:'+6.54%',oiL:'123.45L',p:12437.50,c:+0.98}],
  longunwind:[{s:'WIPRO',n:'Wipro Ltd',oi:'-8.87%',oiL:'1234.56L',p:498.35,c:-1.15},{s:'TATASTEEL',n:'Tata Steel',oi:'-7.95%',oiL:'4521.34L',p:142.60,c:-0.98},{s:'COALINDIA',n:'Coal India',oi:'-6.32%',oiL:'2341.78L',p:387.45,c:-0.87},{s:'ONGC',n:'ONGC Ltd',oi:'-5.76%',oiL:'3456.23L',p:267.80,c:-0.74},{s:'NTPC',n:'NTPC Ltd',oi:'-4.54%',oiL:'2134.56L',p:334.20,c:-0.65},{s:'POWERGRID',n:'Power Grid Corp',oi:'-3.87%',oiL:'1876.43L',p:284.55,c:-0.52}],
  rsi_os:    [{s:'ONGC',p:267.80,c:-0.74,rsi:28},{s:'SAIL',p:127.40,c:-0.43,rsi:24},{s:'BHEL',p:234.75,c:-0.38,rsi:26},{s:'COALINDIA',p:387.45,c:-0.87,rsi:29},{s:'POWERGRID',p:284.55,c:-0.52,rsi:27}],
  rsi_ob:    [{s:'ICICIBANK',p:1089.30,c:+2.11,rsi:78},{s:'BAJFINANCE',p:7234.50,c:+1.89,rsi:76},{s:'TATAMOTORS',p:982.70,c:+3.21,rsi:74},{s:'MARUTI',p:12437.50,c:+0.98,rsi:72},{s:'TITAN',p:3267.80,c:+0.76,rsi:71}],
};
const MYLISTS={
  'Power':['NTPC','POWERGRID','TATAMOTORS','ONGC','BHEL'],
  'Defence':['RELIANCE','TCS','INFOSYS','WIPRO','HDFCBANK'],
  'IT sector':['TCS','INFOSYS','WIPRO','TATAMOTORS','ICICIBANK'],
  'Banking':['HDFCBANK','ICICIBANK','TATASTEEL','BAJFINANCE','MARUTI'],
};
const HOLDS=[
  {s:'RELIANCE',qty:50,avg:2680,col:'#17c3a8'},{s:'TCS',qty:20,avg:3820,col:'#a78bfa'},
  {s:'ICICIBANK',qty:100,avg:980,col:'#f0627a'},{s:'BAJFINANCE',qty:15,avg:6800,col:'#f59e0b'},
  {s:'INFOSYS',qty:40,avg:1700,col:'#34d399'},
];

// STATE
let curS=STOCKS[0],oType='BUY',wTab='mylist',scanTab='shortcover',listTab='Power',hTab='fo',dTab='chart',prevScr='watchlist',curIdx=0;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TICKER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildTicker(){
  const all=[...IDXS.map(x=>({s:x.s,p:x.p,c:x.c})),...GIDX.map(x=>({s:x.f+' '+x.s,p:x.p,c:x.c})),...COMM.map(x=>({s:x.i+' '+x.s,p:x.p,c:x.c}))];
  const h=[...all,...all].map(x=>`<span class="si"><span class="si-n">${x.s}</span><span class="si-p">${x.p.toLocaleString('en-IN',{maximumFractionDigits:2})}</span><span class="si-c ${x.c>=0?'up':'dn'}">${x.c>=0?'‚ñ≤':'‚ñº'}${Math.abs(x.c).toFixed(2)}%</span></span>`).join('');
  document.getElementById('strip').innerHTML=`<div class="strip-inner">${h}</div>`;
}
buildTicker();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SCRS=['home','watchlist','orders','portfolio','detail','profile','funds','demat','api','broker','optchain','strategy'];
function goTo(id){
  if(id==='detail') prevScr=document.querySelector('.scr.on')?.id.replace('Screen','')||'watchlist';
  SCRS.forEach(s=>document.getElementById(s+'Screen')?.classList.toggle('on',s===id));
  const nav=document.getElementById('bnav');
  nav.style.display=['detail','profile','funds','demat','api','broker','optchain','strategy'].includes(id)?'none':'flex';
  ['home','watchlist','orders','portfolio'].forEach(s=>document.getElementById('bn-'+s)?.classList.toggle('act',s===id));
  if(id==='home')      buildHome();
  if(id==='watchlist'){buildWL();setWTabActive();}
  if(id==='orders')    buildOrders();
  if(id==='portfolio') buildPF();
  if(id==='profile')   buildProf();
  if(id==='funds')     buildFunds();
  if(id==='demat')     buildDemat();
  if(id==='api')       buildAPISettings();
  if(id==='broker')    buildBrokerLogin();
  if(id==='optchain')  buildOptionChain();
  if(id==='strategy')  buildStrategyBuilder();
}
function goBack(){goTo(prevScr);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setHTab(el,t){document.querySelectorAll('.htab').forEach(x=>x.classList.remove('act'));el.classList.add('act');hTab=t;buildHome();}
const AI_SIGNALS=[
  {s:'RELIANCE', p:2847,  sig:'BUY',  acc:'84%', reason:'Breakout + Volume surge'},
  {s:'ICICIBANK',p:1089,  sig:'BUY',  acc:'81%', reason:'RSI reversal at support'},
  {s:'HDFCBANK', p:1623,  sig:'BUY',  acc:'79%', reason:'Golden cross + FII buying'},
  {s:'WIPRO',    p:498,   sig:'SELL', acc:'77%', reason:'Bearish engulfing + weak OI'},
  {s:'TATASTEEL',p:142,   sig:'SELL', acc:'75%', reason:'Long unwinding detected'},
  {s:'TCS',      p:3912,  sig:'BUY',  acc:'82%', reason:'Strong quarterly results'},
];
const NEWS=[
  {ico:'üìà',src:'Economic Times',title:'Nifty may test 25,500 as FIIs turn buyers; ICICI Bank, Reliance in focus',time:'2 min ago',bull:true},
  {ico:'üè¶',src:'Moneycontrol',title:'RBI keeps repo rate unchanged at 6.5%; MPC policy stance remains withdrawal',time:'18 min ago',bull:true},
  {ico:'‚õΩ',src:'Bloomberg',title:'Crude oil rises 1.2% on Middle East tensions; ONGC, BPCL stocks may gain',time:'32 min ago',bull:true},
  {ico:'üìâ',src:'LiveMint',title:'IT sector faces headwinds as US tech spending slows; TCS, Infosys cautious',time:'1 hr ago',bull:false},
  {ico:'üè≠',src:'Business Standard',title:'Tata Motors Q3 profit jumps 138% on JLR recovery; stock gains 3.2%',time:'2 hr ago',bull:true},
  {ico:'üíä',src:'CNBC TV18',title:'Sun Pharma gets USFDA nod for generic drug; exports to boost revenue',time:'3 hr ago',bull:true},
];
const VOICE_CMDS=[
  'Show RELIANCE price','Buy 10 lots Nifty','What is PCR today','Show top gainers',
  'Open HDFC Bank chart','Set alert for Nifty 25500','Show my portfolio','Check Sensex'
];

function buildHome(){
  const idx=IDXS[curIdx],up=idx.c>=0;
  const idxOpts=IDXS.map((x,i)=>`<option value="${i}" style="background:#1c2130;color:#fff;"${i===curIdx?' selected':''}>${x.s}</option>`).join('');
  document.getElementById('homeC').innerHTML=`
  <div class="idx-hdr">
    <div class="idx-top">
      <div>
        <div class="idx-name">
          <select onchange="curIdx=+this.value;buildHome()">${idxOpts}</select>
          <span class="idx-arrow">‚ñº</span>
        </div>
        <div class="idx-price">${idx.p.toLocaleString('en-IN',{maximumFractionDigits:2})}</div>
        <div class="idx-chg ${up?'up':'dn'}">${up?'+':''}${idx.c.toFixed(2)} (${Math.abs(idx.pct).toFixed(2)}%)<span class="idx-exch">${idx.e}</span></div>
      </div>
    </div>
  </div>
  <div class="chart-tabs">
    <div class="ctab act">Chart</div>
    <div class="ctab">Options analytics</div>
    <div class="ctab">Stocks</div>
  </div>
  <canvas id="hChart" width="430" height="200" style="display:block;"></canvas>
  <div class="chart-ctrl">
    <div class="cc"><div class="cc-i">‚Üî</div><div class="cc-l">Range</div></div>
    <div class="cc"><div class="cc-t">1 min</div><div class="cc-l">Interval</div></div>
    <div class="cc"><div class="cc-i" style="font-style:italic;font-weight:700;">f</div><div class="cc-l">Indicators</div></div>
    <div class="cc"><div class="cc-i">‚úèÔ∏è</div><div class="cc-l">Drawings</div></div>
    <div class="cc"><div class="cc-i">‚öôÔ∏è</div><div class="cc-l">Settings</div></div>
    <div class="cc"><div class="cc-i">‚õ∂</div></div>
  </div>
  <div class="fo-row">
    <button class="fo-btn" onclick="ocSym=IDXS[curIdx].s;goTo('optchain')"><svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>Futures</button>
    <button class="fo-btn fo-opt" onclick="ocSym=IDXS[curIdx].s;goTo('optchain')"><svg width="17" height="17" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>Option Chain</button>
    <button class="fo-btn" onclick="goTo('strategy')" style="background:#5c4df31a;border-color:#5c4df3;color:#a78bfa;">üß† Strategy</button>
  </div>
  <div class="lsnap">
    <div class="lsnap-t">Live snapshot</div>
    <div class="snap-row">
      <div class="snap-lbl">
        <div><div class="snap-lo">Today's low</div><div class="snap-lv">${(idx.p*.989).toFixed(2)}</div></div>
        <div style="text-align:right;"><div class="snap-lo">Today's high</div><div class="snap-lv">${(idx.p*1.008).toFixed(2)}</div></div>
      </div>
      <div class="snap-bar"><div class="snap-fill" style="width:35%;"></div><div class="snap-dot" style="left:35%;"></div></div>
    </div>
    <div class="snap-row">
      <div class="snap-lbl">
        <div><div class="snap-lo">52 W Low</div><div class="snap-lv">${(idx.p*.79).toFixed(2)}</div></div>
        <div style="text-align:right;"><div class="snap-lo">52 W High</div><div class="snap-lv">${(idx.p*1.14).toFixed(2)}</div></div>
      </div>
      <div class="snap-bar"><div class="snap-fill" style="width:61%;background:#6b88ff;"></div><div class="snap-dot" style="left:61%;border-color:#6b88ff;"></div></div>
    </div>
  </div>
  <div class="scalper" onclick="notif('‚ö°','Options Scalper','Live AI signals active for ${idx.s}')">
    <div><div class="sc-t">Enter Options Scalper ‚Üí</div><div class="sc-s">Live signals ¬∑ AI momentum detection</div></div>
    <span style="font-size:20px;color:#fff;">‚Ä∫</span>
  </div>

  <!-- AI SIGNALS -->
  <div class="sec-hdr"><div class="sec-ttl">ü§ñ AI BUY/SELL SIGNALS</div><div class="sec-more" onclick="notif('ü§ñ','AI Signals','82% accuracy ¬∑ Updated every 15 min')">SEE ALL</div></div>
  <div class="ai-sig-row">
    ${AI_SIGNALS.map(a=>`<div class="ai-card" onclick="openDet('${a.s}')">
      <div class="ai-card-sym">${a.s}</div>
      <div class="ai-card-pr">‚Çπ${a.p.toLocaleString('en-IN')}</div>
      <div class="ai-badge ${a.sig==='BUY'?'buy':'sell'}">${a.sig==='BUY'?'‚ñ≤':'‚ñº'} ${a.sig}</div>
      <div class="ai-card-acc">Accuracy: ${a.acc} ¬∑ ${a.reason}</div>
    </div>`).join('')}
  </div>

  <!-- AI MARKET PULSE -->
  <div class="pulse-card">
    <div class="pulse-hdr"><div class="pulse-dot"></div><div class="pulse-ttl">ü§ñ AI MARKET PULSE</div></div>
    <div class="pulse-row"><div class="pulse-ico">üü¢</div><div class="pulse-txt"><b>Nifty bullish:</b> PCR 1.24 ‚Äî put writers active at 25000. Bias positive.</div></div>
    <div class="pulse-row"><div class="pulse-ico">üåç</div><div class="pulse-txt"><b>Global cues:</b> US markets green, Gift Nifty +76 pts, positive open expected.</div></div>
    <div class="pulse-row"><div class="pulse-ico">ü•á</div><div class="pulse-txt"><b>Gold $2028:</b> Safe haven buying. Watch energy & metal stocks.</div></div>
    <div class="pulse-row" style="margin-bottom:0;"><div class="pulse-ico">üí°</div><div class="pulse-txt"><b>Best bets:</b> ICICIBANK, BAJFINANCE dips mein accumulate karo.</div></div>
  </div>

  <!-- TOP AI PICKS -->
  <div class="sec-hdr"><div class="sec-ttl">üéØ TOP AI PICKS</div><div class="sec-more">SEE ALL</div></div>
  <div class="pick-row">
    ${STOCKS.slice(0,6).map(s=>{const up=s.c>=0;return`<div class="pick-card" onclick="openDet('${s.s}')">
      <div class="pick-sym">${s.s}</div>
      <div class="pick-name">${s.n}</div>
      <div class="pick-pr">‚Çπ${s.p.toLocaleString('en-IN',{maximumFractionDigits:2})}</div>
      <div class="pick-chg ${up?'up':'dn'}">${up?'+':''}${s.c.toFixed(2)} (${Math.abs(s.pct).toFixed(2)}%)</div>
      <div class="pick-badge" style="background:${up?'#17c3a81a':'#f0627a1a'};color:${up?'#17c3a8':'#f0627a'};border:1px solid ${up?'#17c3a840':'#f0627a40'};">${up?'‚ñ≤ BUY':'‚ñº SELL'}</div>
    </div>`}).join('')}
  </div>

  <!-- GLOBAL SNAPSHOT -->
  <div class="sec-hdr"><div class="sec-ttl">üåç GLOBAL SNAPSHOT</div><div class="sec-more" onclick="showGlobalFull()">MORE</div></div>
  <div class="g-grid">
    ${GIDX.slice(0,6).map(g=>{const up=g.c>=0;return`<div class="g-card" onclick="notif('${g.f}','${g.s}','${g.p.toLocaleString()} ¬∑ ${up?'+':''}${g.c.toFixed(2)}% ¬∑ ${g.r}')">
      <div class="g-flag">${g.f}</div>
      <div class="g-region">${g.r}</div>
      <div class="g-name">${g.s}</div>
      <div class="g-price">${g.p.toLocaleString('en-IN')}</div>
      <div class="g-chg ${up?'up':'dn'}">${up?'‚ñ≤':'‚ñº'} ${Math.abs(g.c).toFixed(2)}%</div>
    </div>`}).join('')}
  </div>

  <!-- COMMODITIES -->
  <div class="sec-hdr"><div class="sec-ttl">‚ö° COMMODITIES</div><div class="sec-more" onclick="showCommoditiesFull()">MORE</div></div>
  <div class="comm-row">
    ${COMM.slice(0,8).map(c=>{const up=c.c>=0;return`<div class="c-card" onclick="notif('${c.i}','${c.s}','${c.p.toLocaleString('en-IN',{maximumFractionDigits:2})} ${c.u} ¬∑ ${up?'+':''}${c.c.toFixed(2)}%')">
      <div class="c-icon">${c.i}</div>
      <div class="c-name">${c.s}</div>
      <div class="c-price">${c.p.toLocaleString('en-IN',{maximumFractionDigits:2})}</div>
      <div class="c-chg ${up?'up':'dn'}">${up?'‚ñ≤':'‚ñº'} ${Math.abs(c.c).toFixed(2)}%</div>
      <div style="font-size:10px;color:#555;margin-top:3px;">${c.u}</div>
    </div>`}).join('')}
  </div>

  <!-- LATEST NEWS -->
  <div class="sec-hdr"><div class="sec-ttl">üì∞ LATEST NEWS</div><div class="sec-more">SEE ALL</div></div>
  <div class="news-row">
    ${NEWS.map(n=>`<div class="news-card" onclick="notif('${n.ico}',${JSON.stringify(n.src)},${JSON.stringify(n.title)})">
      <div class="news-img">${n.ico}</div>
      <div class="news-body">
        <div class="news-src"><span class="news-bull" style="background:${n.bull?'#17c3a8':'#f0627a'};"></span>${n.src}</div>
        <div class="news-ttl">${n.title}</div>
        <div class="news-time">${n.time}</div>
      </div>
    </div>`).join('')}
  </div>

  <div style="height:80px;"></div>`;
  setTimeout(()=>drawCandles('hChart',430,200,idx.p,up),40);
}

function drawCandles(id,W,H,baseP,up){
  const cv=document.getElementById(id);if(!cv)return;
  const cx=cv.getContext('2d');cx.clearRect(0,0,W,H);
  cx.strokeStyle='rgba(255,255,255,.03)';cx.lineWidth=.5;
  for(let i=1;i<5;i++){cx.beginPath();cx.moveTo(0,i*H/5);cx.lineTo(W,i*H/5);cx.stroke();}
  let p=baseP,cd=[];
  for(let i=0;i<52;i++){const o=p,r=p*.008,h=o+Math.random()*r,l=o-Math.random()*r,c=o+(Math.random()-.5+(up?.002:-.002))*r;p=c;cd.push({o,h,l,c,b:c>=o});}
  const mn=Math.min(...cd.map(x=>x.l)),mx=Math.max(...cd.map(x=>x.h)),rng=mx-mn||1;
  const py=v=>10+(mx-v)/rng*(H-20),cw=6,gap=2;
  cd.forEach((c,i)=>{
    const x=4+i*(cw+gap),col=c.b?'#17c3a8':'#f0627a';
    cx.strokeStyle=col;cx.lineWidth=1;cx.beginPath();cx.moveTo(x+cw/2,py(c.h));cx.lineTo(x+cw/2,py(c.l));cx.stroke();
    cx.fillStyle=col;const t=py(Math.max(c.o,c.c)),b=py(Math.min(c.o,c.c));cx.fillRect(x,t,cw,Math.max(1,b-t));
    const vl=.3+Math.random()*.7;cx.fillStyle=c.b?'rgba(23,195,168,.18)':'rgba(240,98,122,.18)';cx.fillRect(x,H-vl*30,cw,vl*30);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WATCHLIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setWTabActive(){
  ['mylist','scanner','recent'].forEach((t,i)=>document.getElementById('wt'+i)?.classList.toggle('act',t===wTab));
}
function setWTab(t){wTab=t;setWTabActive();buildWL();}
function buildWL(){
  if(wTab==='mylist') document.getElementById('wlC').innerHTML=buildMyList();
  else if(wTab==='scanner') document.getElementById('wlC').innerHTML=buildScanner();
  else document.getElementById('wlC').innerHTML=buildRecent();
}
function buildMyList(){
  const lists=Object.keys(MYLISTS);
  const syms=MYLISTS[listTab]||[];
  const rows=STOCKS.filter(x=>syms.includes(x.s));
  return `
  <div class="list-tabs">
    ${lists.map(l=>`<div class="ltab ${l===listTab?'act':''}" onclick="listTab='${l}';buildWL()">${l}</div>`).join('')}
    <div class="ltab-ic">‚ãÆ</div><div class="ltab-ic">+</div><div class="ltab-ic">‚â°</div>
  </div>
  <div class="col-hdr"><span style="flex:1;">Stock</span><span style="width:130px;text-align:right;">LTP / Change</span></div>
  ${(rows.length?rows:STOCKS.slice(0,5)).map(s=>wRow(s)).join('')}
  <button class="add-stock" onclick="notif('üîç','Search','Add stocks to ${listTab} list')">
    <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    Search & Add
  </button>
  <div style="height:20px;"></div>`;
}
function wRow(s){
  const up=s.c>=0;
  return `<div class="wl-row" onclick="openDet('${s.s}')">
    <div class="wl-lf"><div class="wl-nm">${s.n||s.s}</div><div class="wl-sb">NSE</div></div>
    <div class="wl-rt"><div class="wl-pr">${s.p.toLocaleString('en-IN',{maximumFractionDigits:2})}</div><div class="wl-ch ${up?'up':'dn'}">${up?'+':''}${s.c.toFixed(2)} (${Math.abs(s.pct||s.c).toFixed(2)}%)</div></div>
  </div>`;
}
function buildScanner(){
  const tabs=[
    {id:'gainers',lbl:'Gainers'},{id:'losers',lbl:'Losers'},
    {id:'volume',lbl:'Volume Shocker'},{id:'shortcover',lbl:'Short Covering'},
    {id:'shortbuild',lbl:'Short Buildup'},{id:'longbuild',lbl:'Long Buildup'},
    {id:'longunwind',lbl:'Long Unwinding'},{id:'rsi_os',lbl:'RSI Oversold'},{id:'rsi_ob',lbl:'RSI Overbought'},
  ];
  const data=SCANS[scanTab]||SCANS.gainers;
  const isOI=['shortcover','shortbuild','longbuild','longunwind'].includes(scanTab);
  const isBull=['gainers','shortcover','longbuild','rsi_ob'].includes(scanTab);
  return `
  <div class="scan-tabs">
    ${tabs.map(t=>`<div class="stab ${t.id===scanTab?'act':''}" onclick="scanTab='${t.id}';buildWL()">${t.lbl}</div>`).join('')}
  </div>
  <div class="idx-filter"><span class="ifl">Index</span><div class="ifd">NIFTY 500 ‚ñº</div></div>
  <div class="col-hdr">
    <span style="flex:1;">STOCKS</span>
    ${isOI?'<span style="width:115px;text-align:right;padding-right:6px;">TOTAL OI (L)</span>':''}
    <span style="width:100px;text-align:right;">LTP (CHG%)</span>
  </div>
  ${data.map(s=>{
    const up=s.c>=0;
    return `<div class="wl-row" onclick="openDet('${s.s}')">
      <div class="wl-lf"><div class="wl-nm">${s.n||s.s}</div><div class="wl-sb">NSE</div></div>
      ${isOI?`<div class="wl-oi"><div class="wl-ov ${isBull?'up':'dn'}">${s.oiL}</div><div class="wl-op ${isBull?'up':'dn'}">(${s.oi})</div></div>`:''}
      <div class="wl-rt"><div class="wl-pr">${(s.p||s.ltp||0).toFixed(2)}</div><div class="wl-ch ${up?'up':'dn'}">${up?'+':''}${s.c.toFixed(2)}(${Math.abs(s.pct||s.c).toFixed(2)}%)</div></div>
    </div>`;
  }).join('')}
  <div style="height:20px;"></div>`;
}
function buildRecent(){
  return`<div style="padding:10px 16px 4px;font-size:11px;color:#8b949e;text-transform:uppercase;letter-spacing:.5px;font-weight:500;">Recently Viewed</div>
  ${STOCKS.slice(0,6).map(s=>wRow(s)).join('')}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STOCK DETAIL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDet(sym){
  curS=STOCKS.find(x=>x.s===sym)||STOCKS[0];
  const up=curS.c>=0;
  document.getElementById('dSym').textContent=curS.s;
  document.getElementById('dPrice').textContent='‚Çπ'+curS.p.toLocaleString('en-IN',{maximumFractionDigits:2});
  document.getElementById('dChg').className='det-chg '+(up?'up':'dn');
  document.getElementById('dChg').textContent=(up?'+':'')+curS.c.toFixed(2)+' ('+Math.abs(curS.pct).toFixed(2)+'%)';
  goTo('detail');
  document.querySelectorAll('.dtab').forEach((t,i)=>{t.classList.toggle('act',i===0);});
  dTab='chart';buildDetC('chart');
}
function setDTab(el,t){dTab=t;document.querySelectorAll('.dtab').forEach(x=>x.classList.remove('act'));el.classList.add('act');buildDetC(t);}
function buildDetC(t){
  const s=curS,up=s.c>=0;
  let h='';
  if(t==='chart'){
    h=`<canvas id="dChart" width="430" height="220" style="display:block;"></canvas>
    <div class="chart-ctrl">
      <div class="cc"><div class="cc-i">‚Üî</div><div class="cc-l">Range</div></div>
      <div class="cc"><div class="cc-t">1 min</div><div class="cc-l">Interval</div></div>
      <div class="cc"><div class="cc-i" style="font-style:italic;font-weight:700;">f</div><div class="cc-l">Indicators</div></div>
      <div class="cc"><div class="cc-i">‚úèÔ∏è</div><div class="cc-l">Drawings</div></div>
      <div class="cc"><div class="cc-i">‚öôÔ∏è</div><div class="cc-l">Settings</div></div>
    </div>
    <div class="fo-row" style="margin-top:10px;">
      <button class="fo-btn" onclick="notif('üìä','Futures','${s.s} Futures ‚Äî Dec Expiry')"><svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>Futures</button>
      <button class="fo-btn fo-opt" onclick="notif('üîó','Option Chain','${s.s} Option Chain')"><svg width="17" height="17" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>Option Chain</button>
    </div>
    <div class="lsnap">
      <div class="lsnap-t">Live snapshot</div>
      <div class="snap-row">
        <div class="snap-lbl">
          <div><div class="snap-lo">Today's low</div><div class="snap-lv">‚Çπ${(s.p*.992).toFixed(2)}</div></div>
          <div style="text-align:right;"><div class="snap-lo">Today's high</div><div class="snap-lv">‚Çπ${(s.p*1.006).toFixed(2)}</div></div>
        </div>
        <div class="snap-bar"><div class="snap-fill" style="width:42%;"></div><div class="snap-dot" style="left:42%;"></div></div>
      </div>
      <div class="snap-row">
        <div class="snap-lbl">
          <div><div class="snap-lo">52 W Low</div><div class="snap-lv">‚Çπ${(s.p*.74).toFixed(2)}</div></div>
          <div style="text-align:right;"><div class="snap-lo">52 W High</div><div class="snap-lv">‚Çπ${(s.p*1.18).toFixed(2)}</div></div>
        </div>
        <div class="snap-bar"><div class="snap-fill" style="width:58%;background:#6b88ff;"></div><div class="snap-dot" style="left:58%;border-color:#6b88ff;"></div></div>
      </div>
    </div>
    <div class="scalper" onclick="notif('‚ö°','Options Scalper','${s.s} scalping signals')">
      <div><div class="sc-t">Enter Options Scalper ‚Üí</div><div class="sc-s">Live signals ¬∑ ${s.sec}</div></div>
    </div>
    <div style="height:80px;"></div>`;
  } else if(t==='options'){
    h=`<div style="padding:16px;">
      <div style="font-size:17px;font-weight:600;color:#fff;margin-bottom:14px;">Put Call Ratio (PCR)</div>
      <div class="pcr-legend"><div class="pcr-leg"><div class="pcr-dot" style="background:#6b88ff;"></div>Price</div><div class="pcr-leg"><div class="pcr-dot" style="background:#f59e0b;"></div>PCR</div><div class="pcr-exp">Expiry: 30 Mar</div></div>
      <div class="pcr-wrap"><canvas id="pcrC" width="360" height="110"></canvas></div>
      <div style="font-size:17px;font-weight:600;color:#fff;margin-bottom:14px;">ATM IV</div>
      <div class="pcr-legend"><div class="pcr-leg"><div class="pcr-dot" style="background:#6b88ff;"></div>Price</div><div class="pcr-leg"><div class="pcr-dot" style="background:#f59e0b;"></div>ATM IV</div><div class="pcr-exp">Expiry: 30 Mar</div></div>
      <div class="pcr-wrap"><canvas id="ivC" width="360" height="110"></canvas></div>
    </div><div style="height:80px;"></div>`;
  } else if(t==='fundamentals'){
    h=`<div style="padding:16px;">
      <div style="font-size:17px;font-weight:600;color:#fff;margin-bottom:14px;">${s.n}</div>
      <div class="fund-grid">
        <div class="fc"><div class="fc-l">Market Cap</div><div class="fc-v">‚Çπ${(s.p*670/1000).toFixed(0)}K Cr</div></div>
        <div class="fc"><div class="fc-l">P/E Ratio</div><div class="fc-v">${(18+Math.random()*12).toFixed(1)}</div></div>
        <div class="fc"><div class="fc-l">EPS</div><div class="fc-v">‚Çπ${(s.p/22).toFixed(1)}</div></div>
        <div class="fc"><div class="fc-l">Book Value</div><div class="fc-v">‚Çπ${(s.p*.6).toFixed(0)}</div></div>
        <div class="fc"><div class="fc-l">Dividend Yield</div><div class="fc-v">1.2%</div></div>
        <div class="fc"><div class="fc-l">ROE</div><div class="fc-v">18.4%</div></div>
        <div class="fc"><div class="fc-l">Debt/Equity</div><div class="fc-v">0.42</div></div>
        <div class="fc"><div class="fc-l">52W High</div><div class="fc-v">‚Çπ${(s.p*1.18).toFixed(0)}</div></div>
      </div>
      <div style="font-size:17px;font-weight:600;color:#fff;margin-bottom:14px;">Quarterly Results</div>
      <div class="fund-grid">
        <div class="fc"><div class="fc-l">Revenue Q3 (Cr)</div><div class="fc-v">‚Çπ${(s.p*2.4).toFixed(0)}</div></div>
        <div class="fc"><div class="fc-l">Net Profit Q3 (Cr)</div><div class="fc-v">‚Çπ${(s.p*.4).toFixed(0)}</div></div>
        <div class="fc"><div class="fc-l">YoY Growth</div><div class="fc-v up">+12.4%</div></div>
        <div class="fc"><div class="fc-l">QoQ Growth</div><div class="fc-v up">+3.8%</div></div>
      </div>
    </div>
    <div style="padding:0 16px;">
      <div style="font-size:16px;font-weight:600;color:#fff;margin-bottom:12px;">Similar Stocks</div>
      <div style="font-size:14px;color:#8b949e;margin-bottom:10px;">${s.n} operates in ${s.sec} industry.</div>
      <div class="sim-cards">
        ${STOCKS.filter(x=>x.sec===s.sec&&x.s!==s.s).slice(0,4).map(x=>`<div class="sim-card" onclick="openDet('${x.s}')"><div class="sim-nm">${x.n}</div><div class="sim-pr">${x.p.toFixed(2)}</div><div class="sim-ch ${x.c>=0?'up':'dn'}">${x.c>=0?'+':''}${x.c.toFixed(2)} (${Math.abs(x.pct).toFixed(2)}%)</div></div>`).join('')}
      </div>
    </div>
    <div style="height:80px;"></div>`;
  } else {
    h=`<div style="padding:16px;">
      <div style="font-size:17px;font-weight:600;color:#fff;margin-bottom:14px;">Shareholding Pattern</div>
      <div style="background:#131820;border-radius:12px;overflow:hidden;">
        ${[['Promoters','52.4%','#17c3a8'],['FII','24.8%','#6b88ff'],['DII','14.2%','#f59e0b'],['Retail','8.6%','#f0627a']].map(r=>`
        <div style="display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #0d1017;">
          <div style="width:11px;height:11px;border-radius:50%;background:${r[2]};margin-right:10px;"></div>
          <div style="flex:1;font-size:15px;font-weight:500;color:#fff;">${r[0]}</div>
          <div style="font-size:15px;font-weight:700;color:#fff;">${r[1]}</div>
        </div>`).join('')}
      </div>
      <div style="font-size:16px;font-weight:600;color:#fff;margin:16px 0 10px;">Mutual Fund Holdings</div>
      <div style="background:#131820;border-radius:12px;overflow:hidden;">
        ${[['Motilal Oswal Midcap Fund','1,145 (3.3%)'],['Mirae Asset Large & Midcap Fund','609 (1.4%)'],['Invesco India Midcap Fund','482 (4.8%)'],['Mirae Asset Midcap Fund','420 (2.4%)'],['DSP Midcap Fund','375 (2.0%)']].map(r=>`
        <div style="display:flex;padding:12px 16px;border-bottom:1px solid #0d1017;"><span style="flex:1;font-size:14px;color:#fff;">${r[0]}</span><span style="font-size:14px;font-weight:600;color:#8b949e;">${r[1]}</span></div>`).join('')}
      </div>
    </div>
    <div style="height:80px;"></div>`;
  }
  document.getElementById('detC').innerHTML=h;
  if(t==='chart') setTimeout(()=>drawCandles('dChart',430,220,s.p,up),40);
  if(t==='options') setTimeout(()=>{
    ['pcrC','ivC'].forEach(id=>{
      const cv=document.getElementById(id);if(!cv)return;
      const cx=cv.getContext('2d'),W=360,H=110;cx.clearRect(0,0,W,H);
      [['#6b88ff',.45],['#f59e0b',.55]].forEach(([col,b])=>{
        let y=H*.5,pts=[];
        for(let x=0;x<=W;x+=W/35){y+=(Math.random()-.5+b*.08)*H*.16;y=Math.max(H*.08,Math.min(H*.92,y));pts.push([x,y]);}
        cx.strokeStyle=col;cx.lineWidth=1.5;cx.beginPath();pts.forEach(([x,y],i)=>i?cx.lineTo(x,y):cx.moveTo(x,y));cx.stroke();
      });
    });
  },50);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ORDERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildOrders(){
  const saved=JSON.parse(localStorage.getItem('be_orders')||'[]');
  document.getElementById('ordersC').innerHTML=saved.length?saved.map(o=>{
    const col=o.status==='EXECUTED'?'#17c3a8':'#f0627a';
    return`<div class="ord-row"><div class="or-l"><div class="or-sym">${o.sym} <span style="font-size:12px;font-weight:600;color:${o.type==='BUY'?'#17c3a8':'#f0627a'};">${o.type}</span></div><div class="or-det">${o.qty} qty ¬∑ ‚Çπ${Number(o.price).toLocaleString('en-IN')} ¬∑ ${o.time}</div></div><div class="or-r"><div class="or-st" style="color:${col};">${o.status}</div><div class="or-amt">‚Çπ${(o.qty*o.price).toLocaleString('en-IN',{maximumFractionDigits:0})}</div></div></div>`;
  }).join(''):`<div class="empty-st"><svg width="60" height="60" fill="none" stroke="currentColor" stroke-width="1.2" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="2"/></svg><div class="empty-t">No orders yet</div><div>Place a trade to see it here</div></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PORTFOLIO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildPF(){
  const tv=HOLDS.reduce((a,h)=>a+(STOCKS.find(x=>x.s===h.s)?.p||h.avg)*h.qty,0);
  const ti=HOLDS.reduce((a,h)=>a+h.qty*h.avg,0);
  const tp=tv-ti,tpp=tp/ti*100;
  document.getElementById('pfC').innerHTML=`
  <div class="pf-sum">
    <div class="pf-lbl">Total investment value</div>
    <div class="pf-val">‚Çπ${tv.toLocaleString('en-IN',{maximumFractionDigits:0})}</div>
    <div class="pf-ret ${tp>=0?'up':'dn'}">${tp>=0?'‚ñ≤':'‚ñº'} ‚Çπ${Math.abs(tp).toLocaleString('en-IN',{maximumFractionDigits:0})} (${Math.abs(tpp).toFixed(2)}%) Total returns</div>
    <div class="pf-grid">
      <div class="pf-cell"><div class="pf-cl">Invested</div><div class="pf-cv">‚Çπ${ti.toLocaleString('en-IN',{maximumFractionDigits:0})}</div></div>
      <div class="pf-cell"><div class="pf-cl">Today's P&L</div><div class="pf-cv up">+‚Çπ4,284</div></div>
      <div class="pf-cell"><div class="pf-cl">1D Returns</div><div class="pf-cv up">+0.82%</div></div>
      <div class="pf-cell"><div class="pf-cl">XIRR</div><div class="pf-cv up">28.4%</div></div>
    </div>
  </div>
  <div style="padding:14px 16px 6px;font-size:12px;color:#8b949e;font-weight:500;text-transform:uppercase;letter-spacing:.4px;">Holdings</div>
  ${HOLDS.map(h=>{
    const st=STOCKS.find(x=>x.s===h.s),ltp=st?st.p:h.avg,pnl=(ltp-h.avg)*h.qty,pp=(ltp-h.avg)/h.avg*100,pos=pnl>=0;
    return`<div class="hold-row" onclick="openDet('${h.s}')"><div class="h-ico" style="background:${h.col}1a;color:${h.col};">${h.s.slice(0,2)}</div><div class="h-l"><div class="h-nm">${h.s}</div><div class="h-dt">${h.qty} qty ¬∑ Avg ‚Çπ${h.avg.toLocaleString()}</div></div><div class="h-r"><div class="h-pnl ${pos?'up':'dn'}">${pos?'+':''}‚Çπ${Math.abs(pnl).toLocaleString('en-IN',{maximumFractionDigits:0})}</div><div class="h-pct ${pos?'up':'dn'}">${pos?'+':''}${pp.toFixed(2)}%</div></div></div>`;
  }).join('')}<div style="height:20px;"></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildProf(){
  const connected=Object.keys(API_KEYS).filter(k=>API_KEYS[k]).length;
  document.getElementById('profC').innerHTML=`
  <div class="prof-pg">
    <div class="prof-av">A</div>
    <div class="prof-nm">AMIT KUMAR</div>
    <div class="prof-lk">Account details ‚Ä∫</div>
    <div class="prof-cards">
      <div class="pc" onclick="goTo('funds')"><div class="pc-ic">‚Çπ</div><div class="pc-v">‚Çπ1.24L</div><div class="pc-l">Funds</div></div>
      <div class="pc" onclick="notif('üéß','Support','Connecting to live support...')"><div class="pc-ic">üéß</div><div class="pc-v">Help</div><div class="pc-l">Live Support</div></div>
      <div class="pc" onclick="notif('üìÖ','P&L Calendar','Daily: +‚Çπ4,284 ¬∑ Monthly: +‚Çπ28,420')"><div class="pc-ic">üìÖ</div><div class="pc-v">P&L</div><div class="pc-l">Calendar</div></div>
    </div>

    <!-- LIVE DATA STATUS CARD -->
    <div style="margin:10px 16px;background:${connected?'#17c3a81a':'#5c4df31a'};border:1px solid ${connected?'#17c3a840':'#5c4df340'};border-radius:14px;padding:14px;cursor:pointer;" onclick="goTo('api')">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div style="font-size:14px;font-weight:700;color:#fff;">${connected?'üî¥ Live Data Active':'‚ö° Connect Live Data'}</div>
          <div style="font-size:12px;color:#8b949e;margin-top:3px;">${connected?'WebSocket connected ¬∑ API keys set':'Broker API connect karo ‚Üí Real-time rates'}</div>
        </div>
        <div style="font-size:20px;">‚Ä∫</div>
      </div>
    </div>

    <!-- OPEN DEMAT BANNER -->
    <div style="margin:10px 16px;background:linear-gradient(135deg,#1a0533,#2d1060);border-radius:14px;padding:16px;cursor:pointer;" onclick="goTo('demat')">
      <div style="font-size:11px;color:rgba(255,255,255,.5);margin-bottom:4px;font-weight:600;text-transform:uppercase;">Start Investing</div>
      <div style="font-size:16px;font-weight:700;color:#fff;margin-bottom:4px;">üìÇ Open Free Demat Account</div>
      <div style="font-size:13px;color:rgba(255,255,255,.6);">Upstox ¬∑ Zerodha ¬∑ Angel One ¬∑ Dhan ‚Äî Free account + Free API</div>
      <div style="margin-top:10px;display:inline-block;background:#17c3a8;color:#000;font-size:13px;font-weight:700;padding:7px 16px;border-radius:8px;">Open Now ‚Üí</div>
    </div>

    <div class="sec-card">
      <div class="sec-t">Trader's Controls</div>
      <div class="mr" onclick="notif('üõë','Kill Switch','All segments disabled for today')"><div class="mr-ic">üõë</div><div class="mr-l"><div class="mr-t">Kill Switch</div><div class="mr-s">Disable trading segments for the day</div></div><div class="mr-arr">‚Ä∫</div></div>
      <div class="mr" onclick="notif('‚öôÔ∏è','Order Defaults','Auto SL/TP configured')"><div class="mr-ic">‚öôÔ∏è</div><div class="mr-l"><div class="mr-t">Order Defaults<span class="badge">New</span></div><div class="mr-s">Set auto SL/TP, default order types</div></div><div class="mr-arr">‚Ä∫</div></div>
    </div>
    <div class="sec-card">
      <div class="mr" onclick="goTo('api')"><div class="mr-ic">üî¥</div><div class="mr-l"><div class="mr-t">Live Data API Settings</div><div class="mr-s">${connected?'Connected ‚Äî '+Object.keys(API_KEYS).filter(k=>API_KEYS[k]).length+' API keys':'Add broker API for live rates'}</div></div><div class="mr-arr">‚Ä∫</div></div>
      <div class="mr" onclick="goTo('demat')"><div class="mr-ic">üìÇ</div><div class="mr-l"><div class="mr-t">Open Demat Account</div><div class="mr-s">Free account with 6 brokers</div></div><div class="mr-arr">‚Ä∫</div></div>
      <div class="mr" onclick="showAlertsScreen()"><div class="mr-ic">üîî</div><div class="mr-l"><div class="mr-t">Price Alerts</div><div class="mr-s">${priceAlerts.filter(a=>a.active).length} active alerts</div></div><div class="mr-arr">‚Ä∫</div></div>
      <div class="mr" onclick="notif('üìÑ','Statements','P&L, Tax, Ledger...')"><div class="mr-ic">üìÑ</div><div class="mr-l"><div class="mr-t">Statements</div><div class="mr-s">P&L, Tax, Ledger, Contract Note</div></div><div class="mr-arr">‚Ä∫</div></div>
      <div class="mr" onclick="notif('üè¶','Bank','Linked: SBI XXXX4521')"><div class="mr-ic">üè¶</div><div class="mr-l"><div class="mr-t">Bank Accounts</div></div><div class="mr-arr">‚Ä∫</div></div>
      <div class="mr" onclick="notif('üí¨','Feedback','Thanks for your feedback!')"><div class="mr-ic">üí¨</div><div class="mr-l"><div class="mr-t">Give us your feedback</div></div><div class="mr-arr">‚Ä∫</div></div>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ORDER OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openOrder(t){
  oType=t;
  document.getElementById('ovSym').textContent=curS.s;
  document.getElementById('ovMPr').textContent='‚Çπ'+curS.p.toLocaleString('en-IN',{maximumFractionDigits:2})+' ¬∑ NSE';
  document.getElementById('ovPr').value=curS.p.toFixed(0);
  setOT(t);
  document.getElementById('ov').classList.add('on');
}
function closeOrder(){document.getElementById('ov').classList.remove('on');}
function setOT(t){
  oType=t;
  document.getElementById('ovB').className='ov-tt '+(t==='BUY'?'b-a':'');
  document.getElementById('ovS').className='ov-tt '+(t==='SELL'?'s-a':'');
  document.getElementById('ovBtn').className=t==='BUY'?'ov-submit-buy':'ov-submit-sell';
  document.getElementById('ovBtn').textContent=`‚ö° Confirm ${t}`;
  calcMg();
}
function oS(el){el.parentElement.querySelectorAll('.ov-sb').forEach(b=>b.classList.remove('act'));el.classList.add('act');}
function calcMg(){
  const q=+document.getElementById('ovQt').value||1,p=+document.getElementById('ovPr').value||curS.p;
  document.getElementById('ovMg').textContent='‚Çπ'+(q*p*.2).toLocaleString('en-IN',{maximumFractionDigits:0});
}
function placeOrder(){
  const qty=+document.getElementById('ovQt').value,pr=+document.getElementById('ovPr').value;
  const h=JSON.parse(localStorage.getItem('be_orders')||'[]');
  h.unshift({sym:curS.s,type:oType,qty,price:pr,status:'EXECUTED',time:new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})});
  localStorage.setItem('be_orders',JSON.stringify(h.slice(0,50)));
  closeOrder();
  notif(oType==='BUY'?'‚úÖ':'üìâ',`${oType} Order Placed!`,`${qty} ${curS.s} @ ‚Çπ${pr.toLocaleString()} ¬∑ Confirmed`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NOTIFICATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let nT;
function notif(ico,title,body){
  document.getElementById('nIco').textContent=ico;
  document.getElementById('nTit').textContent=title;
  document.getElementById('nBod').textContent=body;
  const el=document.getElementById('notif');
  el.classList.add('on');
  clearTimeout(nT);
  nT=setTimeout(()=>el.classList.remove('on'),3200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIVE MARKET DATA ‚Äî Yahoo Finance API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Map Bulls Eye symbol ‚Üí Yahoo Finance symbol
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPLETE LIVE DATA MAPPING ‚Äî ALL MARKETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ NSE STOCKS (50+) ‚îÄ‚îÄ
const YF_MAP = {
  'RELIANCE':'RELIANCE.NS','HDFCBANK':'HDFCBANK.NS','ICICIBANK':'ICICIBANK.NS',
  'TCS':'TCS.NS','INFY':'INFY.NS','WIPRO':'WIPRO.NS','TATAMOTORS':'TATAMOTORS.NS',
  'BAJFINANCE':'BAJFINANCE.NS','TATASTEEL':'TATASTEEL.NS','ONGC':'ONGC.NS',
  'MARUTI':'MARUTI.NS','LTFH':'LTFH.NS','SBIN':'SBIN.NS','AXISBANK':'AXISBANK.NS',
  'KOTAKBANK':'KOTAKBANK.NS','LT':'LT.NS','SUNPHARMA':'SUNPHARMA.NS',
  'TITAN':'TITAN.NS','BAJAJFINSV':'BAJAJFINSV.NS','NTPC':'NTPC.NS',
  'POWERGRID':'POWERGRID.NS','COALINDIA':'COALINDIA.NS','NESTLEIND':'NESTLEIND.NS',
  'HINDALCO':'HINDALCO.NS','JSWSTEEL':'JSWSTEEL.NS','ADANIENT':'ADANIENT.NS',
  'ADANIPORTS':'ADANIPORTS.NS','ULTRACEMCO':'ULTRACEMCO.NS','GRASIM':'GRASIM.NS',
  'TECHM':'TECHM.NS','HCLTECH':'HCLTECH.NS','CIPLA':'CIPLA.NS',
  'DRREDDY':'DRREDDY.NS','DIVISLAB':'DIVISLAB.NS','EICHERMOT':'EICHERMOT.NS',
  'TATACONSUM':'TATACONSUM.NS','BRITANNIA':'BRITANNIA.NS','INDUSINDBK':'INDUSINDBK.NS',
  'HEROMOTOCO':'HEROMOTOCO.NS','BAJAJ-AUTO':'BAJAJ-AUTO.NS','ASIANPAINT':'ASIANPAINT.NS',
  'ZOMATO':'ZOMATO.NS','NAUKRI':'NAUKRI.NS','PAYTM':'PAYTM.NS',
  'HAL':'HAL.NS','BEL':'BEL.NS','IRCTC':'IRCTC.NS','PNB':'PNB.NS',
  'CANBK':'CANBK.NS','BANKBARODA':'BANKBARODA.NS','IOC':'IOC.NS','BPCL':'BPCL.NS',
  'TATAPOWER':'TATAPOWER.NS','NHPC':'NHPC.NS','SAIL':'SAIL.NS','BHEL':'BHEL.NS',
  'DLF':'DLF.NS','GODREJPROP':'GODREJPROP.NS','OBEROIRLTY':'OBEROIRLTY.NS',
};

// ‚îÄ‚îÄ INDICES ‚îÄ‚îÄ
const YF_IDX = {
  'NIFTY 50':'^NSEI','BANKNIFTY':'^NSEBANK','SENSEX':'^BSESN',
  'FINNIFTY':'NIFTY_FIN_SERVICE.NS','MIDCPNIFTY':'NIFTY_MIDCAP_100.NS',
  'GIFTNIFTY':'^NSEI',
};

// ‚îÄ‚îÄ GLOBAL INDICES ‚îÄ‚îÄ
const YF_GLOBAL = {
  'DOW JONES':'^DJI','S&P 500':'^GSPC','NASDAQ':'^IXIC',
  'NIKKEI 225':'^N225','HANG SENG':'^HSI','FTSE 100':'^FTSE',
  'SHANGHAI':'^SSEC','STI':'^STI','DAX':'^GDAXI','CAC 40':'^FCHI',
};

// ‚îÄ‚îÄ COMMODITIES (Yahoo Finance) ‚îÄ‚îÄ
const YF_COMM = {
  'GOLD':'GC=F','SILVER':'SI=F','CRUDE OIL':'CL=F',
  'NAT GAS':'NG=F','COPPER':'HG=F','PLATINUM':'PL=F',
};

// ‚îÄ‚îÄ F&O ‚Äî NIFTY options PCR & OI (NSE API) ‚îÄ‚îÄ
let foData = {
  niftyPCR: 1.24, niftyATMIV: 14.2, niftyFutPrem: 12.5,
  bankPCR: 0.98, bankATMIV: 16.8, bankFutPrem: 8.3,
  topOICall: [{strike:25500,oi:45.2},{strike:26000,oi:38.7},{strike:25000,oi:29.4}],
  topOIPut:  [{strike:25000,oi:52.1},{strike:24500,oi:41.8},{strike:24000,oi:34.6}],
};

async function fetchFOData(){
  // NSE Option Chain for PCR (CORS may block ‚Äî use simulation with real-like fluctuation)
  try {
    // Try NSE option chain API via proxy
    const url = 'https://www.nseindia.com/api/option-chain-indices?symbol=NIFTY';
    const proxied = 'https://corsproxy.io/?'+encodeURIComponent(url);
    const r = await fetch(proxied, {headers:{'Accept':'application/json'},signal:AbortSignal.timeout(4000)});
    if(r.ok){
      const d = await r.json();
      if(d?.filtered?.CE?.totOI && d?.filtered?.PE?.totOI){
        foData.niftyPCR = +(d.filtered.PE.totOI / d.filtered.CE.totOI).toFixed(2);
        foData.niftyATMIV = d.filtered.data?.[Math.floor(d.filtered.data.length/2)]?.CE?.impliedVolatility||14.2;
      }
    }
  } catch(e){
    // Simulate realistic movement
    foData.niftyPCR   = Math.max(0.5, Math.min(2.5, foData.niftyPCR   + (Math.random()-.5)*0.03));
    foData.bankPCR    = Math.max(0.5, Math.min(2.5, foData.bankPCR    + (Math.random()-.5)*0.04));
    foData.niftyATMIV = Math.max(8,   Math.min(40,  foData.niftyATMIV + (Math.random()-.5)*0.2));
    foData.bankATMIV  = Math.max(8,   Math.min(50,  foData.bankATMIV  + (Math.random()-.5)*0.25));
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIVE MARKET DATA ENGINE v3 ‚Äî Multi-API + WebSocket
// Priority: Upstox WS > Angel One > Twelve Data > Yahoo > Sim
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let liveMode = false, wsConnected = false, fetchErrors = 0, lastLiveTime = null;
let activeWS = null; // active WebSocket connection

// ‚îÄ‚îÄ API KEYS (user enters in Settings screen) ‚îÄ‚îÄ
let API_KEYS = JSON.parse(localStorage.getItem('be_apikeys')||'{}');
// { twelve:'KEY', upstoxToken:'JWT', angelApiKey:'KEY', angelJwt:'JWT' }

// ‚îÄ‚îÄ MARKET TIMING ‚îÄ‚îÄ
function isMarketOpen(){
  const ist = new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Kolkata'}));
  const d=ist.getDay(), h=ist.getHours(), m=ist.getMinutes(), mins=h*60+m;
  return d>0 && d<6 && mins>=9*60+15 && mins<=15*60+30;
}
function getISTTime(){ return new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Kolkata'})); }

// ‚îÄ‚îÄ NSE SYMBOL MAP ‚îÄ‚îÄ
const NSE_SYMS = {
  'RELIANCE':'RELIANCE','HDFCBANK':'HDFCBANK','ICICIBANK':'ICICIBANK','TCS':'TCS',
  'INFOSYS':'INFY','WIPRO':'WIPRO','TATAMOTORS':'TATAMOTORS','BAJFINANCE':'BAJFINANCE',
  'TATASTEEL':'TATASTEEL','ONGC':'ONGC','MARUTI':'MARUTI','SBIN':'SBIN',
  'AXISBANK':'AXISBANK','KOTAKBANK':'KOTAKBANK','LT':'LT','SUNPHARMA':'SUNPHARMA',
  'TITAN':'TITAN','NTPC':'NTPC','POWERGRID':'POWERGRID','HCLTECH':'HCLTECH',
  'TECHM':'TECHM','BAJAJ-AUTO':'BAJAJ-AUTO','M&M':'M&M','DRREDDY':'DRREDDY',
  'CIPLA':'CIPLA','JSWSTEEL':'JSWSTEEL','HINDALCO':'HINDALCO','ADANIPORTS':'ADANIPORTS',
  'ADANIENT':'ADANIENT','HAL':'HAL','BEL':'BEL','IRCTC':'IRCTC','ZOMATO':'ZOMATO',
  'INDUSINDBK':'INDUSINDBK','DLF':'DLF','COALINDIA':'COALINDIA','SAIL':'SAIL',
};

// Twelve Data ‚Äî NSE support, 8 req/min free
const TWELVE_SYMS = Object.fromEntries(
  Object.keys(NSE_SYMS).map(k=>[k, NSE_SYMS[k]+':NSE'])
);

// ‚ïê‚ïê‚ïê API 1: UPSTOX WebSocket ‚ïê‚ïê‚ïê
function connectUpstoxWS(){
  const token = API_KEYS.upstoxToken;
  if(!token) return false;
  try {
    const ws = new WebSocket(`wss://api.upstox.com/v2/feed/market-data-feed?token=${token}`);
    ws.onopen = () => {
      wsConnected = true;
      setLiveStatus(true, 'üî¥ LIVE¬∑Upstox');
      speak('Upstox live data connected');
      // Subscribe to instruments
      const instruments = STOCKS.map(s=>`NSE_EQ|${NSE_SYMS[s.s]||s.s}`).filter(Boolean);
      ws.send(JSON.stringify({guid:'be1',method:'sub',params:{mode:'ltpc',instrumentKeys:instruments.slice(0,50)}}));
      activeWS = ws;
    };
    ws.onmessage = (e) => {
      try {
        const d = JSON.parse(e.data);
        (d.feeds||[]).forEach(f=>{
          const sym = f.symbol?.replace('NSE_EQ|','');
          const st = STOCKS.find(s=>NSE_SYMS[s.s]===sym||s.s===sym);
          if(st && f.ltpc?.ltp){ st.p=f.ltpc.ltp; st.c=+(f.ltpc.ltp-f.ltpc.cp).toFixed(2); st.pct=+((st.c/f.ltpc.cp)*100).toFixed(2); }
        });
        updateLivePriceUI();
      } catch(err){}
    };
    ws.onclose = () => { wsConnected=false; activeWS=null; setTimeout(startLiveFeed, 10000); };
    ws.onerror  = () => { ws.close(); };
    return true;
  } catch(e){ return false; }
}

// ‚ïê‚ïê‚ïê API 2: Angel One SmartAPI ‚ïê‚ïê‚ïê
async function fetchAngelOne(){
  const key = API_KEYS.angelApiKey, jwt = API_KEYS.angelJwt;
  if(!key || !jwt) return false;
  try {
    const r = await fetch('https://apiconnect.angelbroking.com/rest/secure/angelbroking/market/v1/quote/', {
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':`Bearer ${jwt}`,'X-UserType':'USER','X-SourceID':'WEB','X-ClientLocalIP':'','X-ClientPublicIP':'','X-MACAddress':'','X-PrivateKey':key},
      body: JSON.stringify({mode:'LTP',exchangeTokens:{'NSE':STOCKS.slice(0,50).map((_,i)=>String(i+1))}})
    });
    if(r.ok){ const d=await r.json(); if(d.data?.fetched?.length){ applyQuotes(d.data.fetched,'angel'); return true; } }
  } catch(e){}
  return false;
}

// ‚ïê‚ïê‚ïê API 3: Twelve Data REST + WebSocket ‚ïê‚ïê‚ïê
let twelveWS = null;
function connectTwelveWS(){
  const key = API_KEYS.twelve || 'demo'; // demo key = limited
  try {
    twelveWS = new WebSocket(`wss://ws.twelvedata.com/v1/quotes/price?apikey=${key}`);
    twelveWS.onopen = () => {
      const syms = Object.values(TWELVE_SYMS).slice(0,10).join(',');
      twelveWS.send(JSON.stringify({action:'subscribe',params:{symbols:syms}}));
      wsConnected=true; setLiveStatus(true,'üî¥ LIVE¬∑12Data'); activeWS=twelveWS;
    };
    twelveWS.onmessage = (e) => {
      try {
        const d = JSON.parse(e.data);
        if(d.price && d.symbol){
          const beKey = Object.keys(TWELVE_SYMS).find(k=>TWELVE_SYMS[k]===d.symbol);
          const st = STOCKS.find(s=>s.s===beKey);
          if(st){ const prev=st.p; st.p=d.price; st.c=+(d.price-prev).toFixed(2); st.pct=+(st.c/prev*100).toFixed(2); }
        }
      } catch(e){}
      updateLivePriceUI();
    };
    twelveWS.onclose = () => { wsConnected=false; activeWS=null; };
    twelveWS.onerror = () => { twelveWS?.close(); };
  } catch(e){}
}

async function fetchTwelveREST(){
  const key = API_KEYS.twelve;
  if(!key) return false;
  try {
    const syms = Object.values(TWELVE_SYMS).slice(0,8).join(',');
    const r = await fetch(`https://api.twelvedata.com/quote?symbol=${syms}&apikey=${key}`,{signal:AbortSignal.timeout(5000)});
    if(r.ok){
      const d = await r.json();
      let updated = 0;
      Object.entries(d).forEach(([sym,q])=>{
        if(!q.close) return;
        const beKey = Object.keys(TWELVE_SYMS).find(k=>TWELVE_SYMS[k]===sym);
        const st = STOCKS.find(s=>s.s===beKey);
        if(st){ st.p=+q.close; st.c=+q.change||0; st.pct=+q.percent_change||0; updated++; }
      });
      if(updated>0){ liveMode=true; setLiveStatus(true,'üî¥ LIVE¬∑12Data'); return true; }
    }
  } catch(e){}
  return false;
}

// ‚ïê‚ïê‚ïê API 4: Yahoo Finance (fallback REST) ‚ïê‚ïê‚ïê
const YF_CORS = ['https://corsproxy.io/?','https://api.allorigins.win/raw?url='];
async function fetchYahooFallback(symbols){
  const url=`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbols.join(',')}&fields=regularMarketPrice,regularMarketChange,regularMarketChangePercent`;
  for(const proxy of ['', ...YF_CORS]){
    try {
      const r=await fetch((proxy?proxy+encodeURIComponent(url):url),{signal:AbortSignal.timeout(5000)});
      if(r.ok){ const d=await r.json(); return d?.quoteResponse?.result||[]; }
    } catch(e){}
  }
  return [];
}

// Yahoo symbol maps (declared above ‚Äî using existing YF_MAP, YF_IDX, YF_GLOBAL, YF_COMM)

async function fetchYahooAll(){
  const allSyms=[
    ...STOCKS.slice(0,25).map(s=>YF_MAP[s.s]).filter(Boolean),
    ...Object.values(YF_IDX),...Object.values(YF_GLOBAL),...Object.values(YF_COMM)
  ].filter((v,i,a)=>v&&a.indexOf(v)===i);
  let results=[];
  for(let i=0;i<allSyms.length;i+=20){
    const res=await fetchYahooFallback(allSyms.slice(i,i+20));
    results=[...results,...res];
  }
  if(!results.length) return false;
  results.forEach(q=>{
    const p=q.regularMarketPrice, c=+(q.regularMarketChange||0).toFixed(2), pct=+(q.regularMarketChangePercent||0).toFixed(2);
    if(!p) return;
    const st=STOCKS.find(s=>YF_MAP[s.s]===q.symbol); if(st){st.p=p;st.c=c;st.pct=pct;}
    const ik=Object.keys(YF_IDX).find(k=>YF_IDX[k]===q.symbol); if(ik){const x=IDXS.find(x=>x.s===ik);if(x){x.p=p;x.c=c;x.pct=pct;}}
    const gk=Object.keys(YF_GLOBAL).find(k=>YF_GLOBAL[k]===q.symbol); if(gk){const g=GIDX.find(x=>x.s===gk);if(g){g.p=p;g.c=pct;}}
    const ck=Object.keys(YF_COMM).find(k=>YF_COMM[k]===q.symbol); if(ck){const cm=COMM.find(x=>x.s===ck);if(cm){cm.p=p;cm.c=pct;}}
  });
  liveMode=true; lastLiveTime=new Date(); fetchErrors=0;
  setLiveStatus(true,'üî¥ LIVE¬∑YF');
  return true;
}

// ‚ïê‚ïê‚ïê NSE DIRECT SCRAPE ‚ïê‚ïê‚ïê
async function fetchNSEDirect(){
  // NSE India official API (CORS restricted, try via proxy)
  const endpoints = [
    ['indices','https://www.nseindia.com/api/allIndices'],
    ['stocks','https://www.nseindia.com/api/equity-stockIndices?index=NIFTY%2050'],
  ];
  for(const [type,url] of endpoints){
    for(const proxy of YF_CORS){
      try {
        const r=await fetch(proxy+encodeURIComponent(url),{signal:AbortSignal.timeout(5000),headers:{Accept:'application/json'}});
        if(!r.ok) continue;
        const d=await r.json();
        if(type==='stocks' && d.data){
          d.data.forEach(q=>{
            const st=STOCKS.find(s=>s.s===q.symbol||NSE_SYMS[s.s]===q.symbol);
            if(st){st.p=q.lastPrice||st.p; st.c=+(q.change||0).toFixed(2); st.pct=+(q.pChange||0).toFixed(2);}
          });
          liveMode=true; setLiveStatus(true,'üî¥ LIVE¬∑NSE'); return true;
        }
      } catch(e){}
    }
  }
  return false;
}

// ‚ïê‚ïê‚ïê SIMULATION (always running for smooth animation) ‚ïê‚ïê‚ïê
function simulateTick(factor=1){
  const mo=isMarketOpen();
  STOCKS.forEach(s=>{s.p=Math.max(1,s.p+(Math.random()-.499)*s.p*(mo?.0003:.00003)*factor); s.c=+(s.c+(Math.random()-.5)*0.04).toFixed(2); s.pct=+(s.pct+(Math.random()-.5)*0.02).toFixed(2);});
  IDXS.forEach(x=>{x.p=Math.max(100,x.p+(Math.random()-.499)*x.p*(mo?.0002:.00002)*factor); x.c=+(x.c+(Math.random()-.5)*0.06).toFixed(2);});
  GIDX.forEach(g=>{g.p=Math.max(100,g.p+(Math.random()-.499)*g.p*.0002*factor); g.c=+(g.c+(Math.random()-.5)*.03).toFixed(2);});
  COMM.forEach(c=>{c.p=Math.max(1,c.p+(Math.random()-.499)*c.p*.0003*factor); c.c=+(c.c+(Math.random()-.5)*.02).toFixed(2);});
}

// ‚ïê‚ïê‚ïê LIVE STATUS BADGE ‚ïê‚ïê‚ïê
function setLiveStatus(live, text){
  let b=document.getElementById('liveBadge');
  if(!b){b=document.createElement('div');b.id='liveBadge';b.style.cssText='position:fixed;top:6px;right:8px;z-index:400;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;font-family:Inter,sans-serif;pointer-events:none;transition:all .3s;';document.body.appendChild(b);}
  b.style.background=live?'#17c3a81a':'#f59e0b1a';
  b.style.color=live?'#17c3a8':'#f59e0b';
  b.style.border=`1px solid ${live?'#17c3a840':'#f59e0b40'}`;
  b.textContent=text||(live?'üî¥ LIVE':'üìä DEMO');
}

// ‚ïê‚ïê‚ïê UPDATE UI ‚ïê‚ïê‚ïê
function updateLivePriceUI(){
  buildTicker();
  const priceEl=document.querySelector('.idx-price');
  if(priceEl){
    const idx=IDXS[curIdx];
    priceEl.textContent=idx.p.toLocaleString('en-IN',{maximumFractionDigits:2});
    const chgEl=document.querySelector('.idx-chg');
    if(chgEl){chgEl.className='idx-chg '+(idx.c>=0?'up':'dn');chgEl.innerHTML=(idx.c>=0?'+':'')+idx.c.toFixed(2)+' ('+Math.abs(idx.pct).toFixed(2)+'%)<span class="idx-exch">'+idx.e+'</span>';}
  }
  if(document.getElementById('watchlistScreen')?.classList.contains('on')) buildWL();
  if(document.getElementById('detailScreen')?.classList.contains('on')){
    const el=document.getElementById('dPrice'),ce=document.getElementById('dChg');
    if(el) el.textContent='‚Çπ'+curS.p.toLocaleString('en-IN',{maximumFractionDigits:2});
    if(ce){ce.className='det-chg '+(curS.c>=0?'up':'dn');ce.textContent=(curS.c>=0?'+':'')+curS.c.toFixed(2)+' ('+Math.abs(curS.pct).toFixed(2)+'%)';}
  }
  checkAlerts();
}

// ‚ïê‚ïê‚ïê MAIN LIVE ENGINE ‚ïê‚ïê‚ïê
let restFetchTimer = null;
async function startLiveFeed(){
  // Priority: Upstox WS > Zerodha WS > Dhan > Twelve Data > REST polling
  if(API_KEYS.upstoxToken   && connectUpstoxWS())  return;
  if(API_KEYS.zerodhaToken  && connectZerodhaWS()) return;
  if(API_KEYS.dhanToken     && connectDhanWS())    return;
  if(API_KEYS.fyersToken    && connectFyersWS())   return;
  if(API_KEYS.twelve)       { connectTwelveWS(); return; }
  // Fallback: REST polling every 5s
  startPolling();
}

function connectDhanWS(){
  const token=API_KEYS.dhanToken, clientId=API_KEYS.dhanClient;
  if(!token||!clientId) return false;
  try {
    const ws=new WebSocket(`wss://api-order-update.dhan.co`);
    ws.onopen=()=>{ wsConnected=true; setLiveStatus(true,'üî¥ LIVE¬∑Dhan'); activeWS=ws;
      ws.send(JSON.stringify({LoginReq:{MsgCode:11,'UserType':'CLIENT','UserId':clientId,'AccessToken':token}})  );
    };
    ws.onmessage=(e)=>{ try{ const d=JSON.parse(e.data); if(d.data){const st=STOCKS.find(s=>s.s===d.data.tradingSymbol); if(st){st.p=d.data.lastTradedPrice;st.c=+(d.data.change||0).toFixed(2);}} updateLivePriceUI(); }catch(err){} };
    ws.onclose=()=>{ wsConnected=false; activeWS=null; setTimeout(startLiveFeed,10000); };
    ws.onerror=()=>{ ws.close(); };
    return true;
  } catch(e){ return false; }
}

function connectFyersWS(){
  const token=API_KEYS.fyersToken;
  if(!token) return false;
  try {
    const ws=new WebSocket(`wss://socket.fyers.in/trade/v3/live-market/?access_token=${token}`);
    ws.onopen=()=>{ wsConnected=true; setLiveStatus(true,'üî¥ LIVE¬∑Fyers'); activeWS=ws;
      ws.send(JSON.stringify({T:'SUB_L2',SLIST:['NSE:RELIANCE-EQ','NSE:HDFCBANK-EQ','NSE:NIFTY50-INDEX','NSE:BANKNIFTY-INDEX'],SUB_T:1}));
    };
    ws.onmessage=(e)=>{ try{ const d=JSON.parse(e.data);
      if(d.d){const items=Array.isArray(d.d)?d.d:[d.d];items.forEach(q=>{const sym=(q.n||'').replace('NSE:','').replace('-EQ','').replace('-INDEX','');const st=STOCKS.find(s=>s.s===sym)||IDXS.find(x=>x.s.includes(sym));if(st){st.p=q.lp||st.p;st.c=+(q.chp||0).toFixed(2);}});}
      updateLivePriceUI(); }catch(err){} };
    ws.onclose=()=>{ wsConnected=false; activeWS=null; setTimeout(startLiveFeed,10000); };
    ws.onerror=()=>{ ws.close(); };
    return true;
  } catch(e){ return false; }
}

function connectZerodhaWS(){
  const token=API_KEYS.zerodhaToken, apiKey=API_KEYS.zerodhaKey;
  if(!token||!apiKey) return false;
  try {
    const ws=new WebSocket(`wss://ws.kite.trade/?api_key=${apiKey}&access_token=${token}`);
    ws.binaryType='arraybuffer';
    ws.onopen=()=>{ wsConnected=true; setLiveStatus(true,'üî¥ LIVE¬∑Zerodha'); activeWS=ws; };
    ws.onmessage=(e)=>{ updateLivePriceUI(); }; // full binary decode needs more setup
    ws.onclose=()=>{ wsConnected=false; activeWS=null; setTimeout(startLiveFeed,10000); };
    ws.onerror=()=>{ ws.close(); };
    return true;
  } catch(e){ return false; }
}

async function startPolling(){
  const poll = async () => {
    // Try in order: Twelve Data > Angel One > NSE Direct > Yahoo
    let ok = false;
    if(API_KEYS.twelve)       ok = await fetchTwelveREST();
    if(!ok && API_KEYS.angelApiKey) ok = await fetchAngelOne();
    if(!ok)                   ok = await fetchNSEDirect();
    if(!ok)                   ok = await fetchYahooAll();
    if(!ok){ fetchErrors++; if(fetchErrors>5){setLiveStatus(false,'‚ö° Simulated');} }
    fetchFOData();
    updateLivePriceUI();
  };
  poll();
  const interval = isMarketOpen() ? 5000 : 30000;
  restFetchTimer = setInterval(poll, interval);
}

// ‚îÄ Smooth ticks between real fetches ‚îÄ
setInterval(()=>{ if(!wsConnected){ simulateTick(liveMode?0.3:1); updateLivePriceUI(); } }, 2500);

// ‚îÄ Start everything ‚îÄ
setLiveStatus(false,'‚è≥ Connecting...');
startLiveFeed();



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VOICE + ALERT + NOTIFICATION SYSTEM ‚Äî FULL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ PRICE ALERTS STORAGE ‚îÄ‚îÄ
let priceAlerts = JSON.parse(localStorage.getItem('be_alerts')||'[]');
// {id, sym, targetPrice, type:'above'|'below', active:true, created}

// ‚îÄ‚îÄ SPEECH SYNTHESIS (Voice Output) ‚îÄ‚îÄ
function speak(text){
  if(!('speechSynthesis' in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'hi-IN';
  u.rate = 0.95;
  u.pitch = 1.1;
  u.volume = 1;
  // Try Hindi voice, fallback to any
  const voices = window.speechSynthesis.getVoices();
  const hi = voices.find(v=>v.lang.startsWith('hi'))||voices.find(v=>v.lang.startsWith('en-IN'))||voices[0];
  if(hi) u.voice = hi;
  window.speechSynthesis.speak(u);
}

// ‚îÄ‚îÄ ALARM SOUND ‚îÄ‚îÄ
let alarmCtx = null;
function playAlarm(type='alert'){
  try {
    alarmCtx = new (window.AudioContext||window.webkitAudioContext)();
    const patterns = {
      alert:  [[523,0.1],[0,0.05],[523,0.1],[0,0.05],[659,0.3]],
      buy:    [[392,0.08],[523,0.08],[659,0.08],[784,0.3]],
      sell:   [[784,0.08],[659,0.08],[523,0.08],[392,0.3]],
      urgent: [[880,0.1],[0,0.05],[880,0.1],[0,0.05],[880,0.1],[0,0.05],[1047,0.5]],
    };
    let t = alarmCtx.currentTime;
    (patterns[type]||patterns.alert).forEach(([freq,dur])=>{
      if(freq>0){
        const osc=alarmCtx.createOscillator();
        const gain=alarmCtx.createGain();
        osc.connect(gain); gain.connect(alarmCtx.destination);
        osc.frequency.value=freq; osc.type='sine';
        gain.gain.setValueAtTime(0.4,t);
        gain.gain.exponentialRampToValueAtTime(0.001,t+dur);
        osc.start(t); osc.stop(t+dur);
      }
      t+=dur+(freq>0?0.02:0);
    });
  } catch(e){}
}

// ‚îÄ‚îÄ PHONE CALL SIMULATION ‚îÄ‚îÄ
function makeCall(sym, price){
  // Show full-screen call UI
  const overlay = document.createElement('div');
  overlay.id = 'callOverlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:#0a0a0a;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;';
  overlay.innerHTML = `
    <div style="text-align:center;padding:40px 20px;">
      <div style="font-size:18px;color:#8b949e;margin-bottom:8px;font-family:Inter,sans-serif;">Bulls Eye Alert</div>
      <div style="font-size:32px;font-weight:700;color:#fff;margin-bottom:6px;font-family:Inter,sans-serif;">${sym}</div>
      <div style="font-size:22px;font-weight:600;color:#17c3a8;margin-bottom:6px;font-family:Inter,sans-serif;">‚Çπ${price.toLocaleString('en-IN')}</div>
      <div style="font-size:15px;color:#8b949e;margin-bottom:50px;font-family:Inter,sans-serif;">üéØ Target Price Reached!</div>
      <div style="width:80px;height:80px;border-radius:50%;background:#17c3a8;display:flex;align-items:center;justify-content:center;margin:0 auto 40px;animation:pulse-ring 1s infinite;">
        <span style="font-size:36px;">üìû</span>
      </div>
      <div style="font-size:13px;color:#555;margin-bottom:40px;font-family:Inter,sans-serif;">Bulls Eye ‚Äî Price Alert Notification</div>
      <div style="display:flex;gap:40px;justify-content:center;">
        <div style="text-align:center;cursor:pointer;" onclick="endCall()">
          <div style="width:64px;height:64px;border-radius:50%;background:#f0627a;display:flex;align-items:center;justify-content:center;margin:0 auto 8px;font-size:24px;">üìµ</div>
          <span style="font-size:13px;color:#fff;font-family:Inter,sans-serif;">Dismiss</span>
        </div>
        <div style="text-align:center;cursor:pointer;" onclick="endCall();openDet('${sym}')">
          <div style="width:64px;height:64px;border-radius:50%;background:#17c3a8;display:flex;align-items:center;justify-content:center;margin:0 auto 8px;font-size:24px;">üìà</div>
          <span style="font-size:13px;color:#fff;font-family:Inter,sans-serif;">View Chart</span>
        </div>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  // Play urgent alarm
  playAlarm('urgent');
  // Vibrate
  if(navigator.vibrate) navigator.vibrate([500,200,500,200,500,200,1000]);
  // Speak alert
  setTimeout(()=>speak(`Alert! ${sym} ka target price ‚Çπ${price} reach ho gaya. Abhi action lo!`), 300);
  // Auto close after 30s
  setTimeout(()=>endCall(), 30000);
}
function endCall(){
  window.speechSynthesis?.cancel();
  document.getElementById('callOverlay')?.remove();
}

// ‚îÄ‚îÄ PRICE ALERT CHECKER (runs every 3 sec) ‚îÄ‚îÄ
function checkAlerts(){
  if(!priceAlerts.length) return;
  priceAlerts.forEach((alert,i)=>{
    if(!alert.active) return;
    const st = STOCKS.find(s=>s.s===alert.sym);
    if(!st) return;
    const hit = alert.type==='above' ? st.p >= alert.targetPrice : st.p <= alert.targetPrice;
    if(hit){
      priceAlerts[i].active = false;
      localStorage.setItem('be_alerts', JSON.stringify(priceAlerts));
      // Trigger ALL notifications
      triggerAlert(alert.sym, st.p, alert.targetPrice, alert.type);
    }
  });
}
function triggerAlert(sym, ltp, target, type){
  const up = type==='above';
  // 1. Screen notification
  notif('üö®', `${sym} Alert Triggered!`, `‚Çπ${ltp.toFixed(2)} ${up?'crossed above':'fell below'} ‚Çπ${target}`);
  // 2. Browser notification
  if(Notification.permission==='granted'){
    new Notification(`üö® Bulls Eye ‚Äî ${sym} Alert!`,{
      body:`Price ${up?'reached':'fell to'} ‚Çπ${ltp.toFixed(2)} (Target: ‚Çπ${target})`,
      icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%2317c3a8"/><text y=".9em" font-size="90" x="10">üéØ</text></svg>'
    });
  }
  // 3. Call screen + alarm
  setTimeout(()=>makeCall(sym, ltp), 500);
}
setInterval(checkAlerts, 3000);

// ‚îÄ‚îÄ REQUEST PERMISSIONS ‚îÄ‚îÄ
function reqPermissions(){
  if('Notification' in window && Notification.permission==='default'){
    Notification.requestPermission();
  }
}
setTimeout(reqPermissions, 2000);

// ‚îÄ‚îÄ ADD PRICE ALERT ‚îÄ‚îÄ
function addPriceAlert(sym, targetPrice, type){
  priceAlerts.push({id:Date.now(), sym, targetPrice:+targetPrice, type, active:true, created:new Date().toLocaleTimeString()});
  localStorage.setItem('be_alerts', JSON.stringify(priceAlerts));
  playAlarm('alert');
  speak(`${sym} ka ${type==='above'?'upar':'neeche'} alert ‚Çπ${targetPrice} pe set ho gaya`);
  notif('‚úÖ',`Alert Set ‚Äî ${sym}`,`‚Çπ${targetPrice} ${type==='above'?'cross hone par':'neeche aane par'} call aayegi`);
  renderAlertsPanel();
}

// ‚îÄ‚îÄ ALERTS PANEL (show active alerts) ‚îÄ‚îÄ
function renderAlertsPanel(){
  const panel = document.getElementById('alertsPanel');
  // update badge
  const active = priceAlerts.filter(a=>a.active);
  const badge = document.getElementById('alertBadge');
  if(badge) badge.style.display = active.length ? 'block' : 'none';
  if(!panel) return;
  panel.innerHTML = active.length ? active.map(a=>{
    const st = STOCKS.find(s=>s.s===a.sym);
    const ltp = st ? st.p.toFixed(2) : '---';
    const pct = st ? ((st.p - a.targetPrice)/a.targetPrice*100).toFixed(2) : '';
    const gap = st ? (a.type==='above' ? a.targetPrice - st.p : st.p - a.targetPrice) : 0;
    return `
    <div style="display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #0d1017;">
      <div style="flex:1;">
        <div style="font-size:16px;font-weight:700;color:#fff;">${a.sym} <span style="font-size:11px;font-weight:600;color:${a.type==='above'?'#17c3a8':'#f0627a'};background:${a.type==='above'?'#17c3a81a':'#f0627a1a'};padding:2px 7px;border-radius:6px;">${a.type==='above'?'‚Üë ABOVE':'‚Üì BELOW'}</span></div>
        <div style="font-size:13px;color:#8b949e;margin-top:3px;">Target: <b style="color:#fff;">‚Çπ${a.targetPrice.toLocaleString('en-IN')}</b> ¬∑ LTP: <b style="color:#fff;">‚Çπ${ltp}</b></div>
        <div style="font-size:12px;color:#8b949e;margin-top:2px;">${gap>0?`‚Çπ${Math.abs(gap).toFixed(2)} ${a.type==='above'?'aur upar jaana hai':'aur neeche aana hai'}`:'‚úÖ Target zone pe hai!'}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
        <div style="font-size:12px;color:#17c3a8;font-weight:600;">üîî ACTIVE</div>
        <button onclick="triggerAlert('${a.sym}',${st?.p||a.targetPrice},${a.targetPrice},'${a.type}')" style="background:#f59e0b1a;border:1px solid #f59e0b40;color:#f59e0b;border-radius:6px;padding:3px 8px;cursor:pointer;font-size:11px;font-weight:600;">Test üîä</button>
        <button onclick="deleteAlert(${a.id})" style="background:#f0627a1a;border:1px solid #f0627a40;color:#f0627a;border-radius:6px;padding:3px 8px;cursor:pointer;font-size:11px;">‚úï Delete</button>
      </div>
    </div>`}).join('') :
    `<div style="text-align:center;padding:40px 20px;color:#8b949e;">
      <div style="font-size:40px;margin-bottom:16px;">üîî</div>
      <div style="font-size:17px;font-weight:600;color:#fff;margin-bottom:8px;">Koi active alert nahi</div>
      <div style="font-size:14px;line-height:1.8;">Voice se set karo:<br><b style="color:#17c3a8;">"Alert HDFC at 1700"</b><br><b style="color:#17c3a8;">"Reliance above 2900"</b><br><b style="color:#17c3a8;">"TCS below 3800"</b></div>
    </div>`;
}
function deleteAlert(id){
  priceAlerts = priceAlerts.filter(a=>a.id!==id);
  localStorage.setItem('be_alerts', JSON.stringify(priceAlerts));
  renderAlertsPanel();
  notif('üóëÔ∏è','Alert Deleted','Alert remove kar diya gaya');
}

// ‚îÄ‚îÄ VOICE SYSTEM ‚îÄ‚îÄ
let isListening=false, recognition=null, voiceState='idle', pendingVoiceAction={};

function toggleVoice(){
  const btn=document.getElementById('voiceBtn');
  if(isListening){stopVoice();return;}
  showVoiceUI();
  if('webkitSpeechRecognition' in window||'SpeechRecognition' in window){
    startListening();
  } else {
    // Demo mode - show modal with manual input
    notif('üéôÔ∏è','Voice Demo Mode','Koi SR support nahi ‚Äî demo chalega');
    setTimeout(()=>{demoVoice();},1500);
  }
}

function startListening(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  recognition=new SR();
  recognition.lang='hi-IN';
  recognition.interimResults=true;
  recognition.continuous=false;
  recognition.maxAlternatives=3;
  recognition.onstart=()=>{
    isListening=true;
    document.getElementById('voiceBtn').classList.add('listening');
    updateVoiceUI('Listening... Bolte raho üéôÔ∏è','#17c3a8');
  };
  recognition.onresult=(e)=>{
    let interim='', final='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      if(e.results[i].isFinal) final+=e.results[i][0].transcript;
      else interim+=e.results[i][0].transcript;
    }
    if(interim) updateVoiceUI('"'+interim+'"','#f59e0b');
    if(final){ stopVoice(); processVoice(final.toLowerCase().trim()); }
  };
  recognition.onerror=(e)=>{stopVoice();notif('‚ùå','Voice Error',e.error==='not-allowed'?'Mic permission do':'Dobara try karo');};
  recognition.onend=()=>stopVoice();
  recognition.start();
}

function stopVoice(){
  isListening=false;
  document.getElementById('voiceBtn')?.classList.remove('listening');
  if(recognition){ try{recognition.stop();}catch(e){} }
  hideVoiceUI();
}

// ‚îÄ‚îÄ VOICE UI OVERLAY ‚îÄ‚îÄ
function showVoiceUI(){
  if(document.getElementById('voiceUI')) return;
  const d=document.createElement('div');
  d.id='voiceUI';
  d.style.cssText='position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#131820;border:1px solid #1a1f2e;border-radius:20px;padding:16px 20px;z-index:600;width:88%;max-width:380px;box-shadow:0 8px 40px rgba(0,0,0,.7);';
  d.innerHTML=`
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
      <div style="width:10px;height:10px;border-radius:50%;background:#17c3a8;animation:blink 1s infinite;" id="voiceDot"></div>
      <div style="font-size:14px;font-weight:600;color:#fff;" id="voiceSt">Starting...</div>
      <button onclick="stopVoice()" style="margin-left:auto;background:transparent;border:none;color:#8b949e;font-size:18px;cursor:pointer;">‚úï</button>
    </div>
    <div style="font-size:12px;color:#555;line-height:1.8;font-family:Inter,sans-serif;">
      üí¨ <b style="color:#fff;">Stock search:</b> "Reliance price" ¬∑ "HDFC chart"<br>
      üìà <b style="color:#fff;">Buy/Sell:</b> "Buy 10 Reliance" ¬∑ "Sell 5 TCS"<br>
      üîî <b style="color:#fff;">Alert:</b> "Alert HDFC at 1700" ¬∑ "NIFTY above 25500"<br>
      üìã <b style="color:#fff;">Navigate:</b> "Open portfolio" ¬∑ "Show gainers"
    </div>`;
  document.body.appendChild(d);
}
function hideVoiceUI(){ document.getElementById('voiceUI')?.remove(); }
function updateVoiceUI(text,color){
  const st=document.getElementById('voiceSt');
  const dot=document.getElementById('voiceDot');
  if(st) st.textContent=text;
  if(dot) dot.style.background=color||'#17c3a8';
}

// ‚îÄ‚îÄ PROCESS VOICE COMMAND ‚îÄ‚îÄ
function processVoice(cmd){
  console.log('Voice cmd:', cmd);
  const nums = cmd.match(/\d+(?:,\d+)*(?:\.\d+)?/g);
  const price = nums ? parseFloat(nums[nums.length-1].replace(/,/g,'')) : null;
  const qty   = nums && nums.length>1 ? parseInt(nums[0]) : 1;

  // ‚îÄ‚îÄ STOCK SEARCH ‚Äî any stock name ‚îÄ‚îÄ
  const matchedStock = STOCKS.find(s=>
    cmd.includes(s.s.toLowerCase()) ||
    cmd.includes(s.n.toLowerCase().split(' ')[0]) ||
    cmd.includes(s.n.toLowerCase().split(' ')[1]||'__')
  );

  // ‚îÄ‚îÄ ALERT COMMANDS ‚îÄ‚îÄ
  // "alert reliance at 2900" / "reliance above 2900" / "hdfc below 1600"
  const isAlertCmd = cmd.includes('alert')||cmd.includes('above')||cmd.includes('below')||cmd.includes('target')||cmd.includes('notification');
  if(isAlertCmd && matchedStock && price){
    const type = cmd.includes('below')||cmd.includes('neeche') ? 'below' : 'above';
    addPriceAlert(matchedStock.s, price, type);
    return;
  }

  // ‚îÄ‚îÄ BUY COMMAND ‚îÄ‚îÄ
  // "buy 10 reliance" / "reliance kharido" / "reliance buy karo"
  const isBuy = cmd.includes('buy')||cmd.includes('kharido')||cmd.includes('le lo')||cmd.includes('lena');
  if(isBuy && matchedStock){
    curS = matchedStock;
    openOrder('BUY');
    if(price) document.getElementById('ovPr').value = price;
    if(qty>1) document.getElementById('ovQt').value = qty;
    calcMg();
    speak(`${matchedStock.s} ka BUY order window khola. Price ‚Çπ${price||matchedStock.p.toFixed(0)}, quantity ${qty}`);
    notif('üéôÔ∏è',`BUY ‚Äî ${matchedStock.s}`,`‚Çπ${price||matchedStock.p.toFixed(0)} ¬∑ Qty ${qty}`);
    return;
  }

  // ‚îÄ‚îÄ SELL COMMAND ‚îÄ‚îÄ
  const isSell = cmd.includes('sell')||cmd.includes('becho')||cmd.includes('bechna')||cmd.includes('hatao');
  if(isSell && matchedStock){
    curS = matchedStock;
    openOrder('SELL');
    if(price) document.getElementById('ovPr').value = price;
    if(qty>1) document.getElementById('ovQt').value = qty;
    calcMg();
    speak(`${matchedStock.s} ka SELL order window khola`);
    notif('üéôÔ∏è',`SELL ‚Äî ${matchedStock.s}`,`‚Çπ${price||matchedStock.p.toFixed(0)} ¬∑ Qty ${qty}`);
    return;
  }

  // ‚îÄ‚îÄ LTP / PRICE CHECK ‚îÄ‚îÄ
  const isPriceCheck = cmd.includes('price')||cmd.includes('ltp')||cmd.includes('rate')||cmd.includes('kitna')||cmd.includes('kya hai');
  if(isPriceCheck && matchedStock){
    const p = matchedStock.p;
    speak(`${matchedStock.n} ka current price hai ‚Çπ${p.toFixed(2)}`);
    notif('üí∞',`${matchedStock.s} ‚Äî LTP`,`‚Çπ${p.toLocaleString('en-IN',{maximumFractionDigits:2})}`);
    return;
  }

  // ‚îÄ‚îÄ OPEN STOCK CHART ‚îÄ‚îÄ
  if(matchedStock){
    openDet(matchedStock.s);
    speak(`${matchedStock.n} ka chart khol raha hun`);
    notif('üìä',`${matchedStock.s}`,`‚Çπ${matchedStock.p.toLocaleString('en-IN',{maximumFractionDigits:2})} ‚Äî chart khola`);
    return;
  }

  // ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
  if(cmd.includes('portfolio')||cmd.includes('holdings')){goTo('portfolio');speak('Portfolio dekho');return;}
  if(cmd.includes('watchlist')||cmd.includes('watch list')){goTo('watchlist');speak('Watchlist dekho');return;}
  if(cmd.includes('orders')||cmd.includes('order')){goTo('orders');speak('Orders dekho');return;}
  if(cmd.includes('home')){goTo('home');speak('Home screen pe aa gaye');return;}
  if(cmd.includes('profile')){goTo('profile');speak('Profile dekho');return;}

  // ‚îÄ‚îÄ SCANNERS ‚îÄ‚îÄ
  if(cmd.includes('gainer')||cmd.includes('top stock')){goTo('watchlist');scanTab='gainers';setWTab('scanner');speak('Aaj ke top gainers dikha raha hun');return;}
  if(cmd.includes('loser')||cmd.includes('girne wale')){goTo('watchlist');scanTab='losers';setWTab('scanner');speak('Losers dikha raha hun');return;}
  if(cmd.includes('short cover')){goTo('watchlist');scanTab='shortcover';setWTab('scanner');speak('Short covering stocks dikha raha hun');return;}
  if(cmd.includes('long build')){goTo('watchlist');scanTab='longbuild';setWTab('scanner');speak('Long buildup stocks dikha raha hun');return;}

  // ‚îÄ‚îÄ ALERTS PANEL ‚îÄ‚îÄ
  if(cmd.includes('alert')||cmd.includes('notification')){showAlertsScreen();return;}

  // ‚îÄ‚îÄ NIFTY/SENSEX price ‚îÄ‚îÄ
  if(cmd.includes('nifty')||cmd.includes('sensex')||cmd.includes('banknifty')){
    const idx=IDXS.find(x=>cmd.includes(x.s.toLowerCase().split(' ')[0]))||IDXS[0];
    speak(`${idx.s} abhi ‚Çπ${idx.p.toFixed(2)} pe hai, ${idx.c>=0?'upar':'neeche'} ${Math.abs(idx.pct).toFixed(2)} percent`);
    notif('üìä',idx.s,`‚Çπ${idx.p.toLocaleString('en-IN',{maximumFractionDigits:2})} ¬∑ ${idx.c>=0?'+':''}${idx.c.toFixed(2)}`);
    return;
  }

  // ‚îÄ‚îÄ NOT UNDERSTOOD ‚îÄ‚îÄ
  speak('Samajh nahi aaya, dobara boliye');
  notif('üéôÔ∏è',`Suna: "${cmd}"`, 'Koi match nahi mila');
}

// ‚îÄ‚îÄ DEMO VOICE (for browsers without SR) ‚îÄ‚îÄ
function demoVoice(){
  const demos=[
    'buy 10 reliance','alert hdfc at 1700','reliance price','show gainers',
    'open portfolio','sell 5 tcs','icici below 1050','nifty rate kya hai'
  ];
  const d=demos[Math.floor(Math.random()*demos.length)];
  showVoiceUI();
  setTimeout(()=>updateVoiceUI('"'+d+'"','#f59e0b'),500);
  setTimeout(()=>{stopVoice();processVoice(d);},1800);
}

// ‚îÄ‚îÄ ALERTS SCREEN ‚îÄ‚îÄ
function showAlertsScreen(){
  const overlay=document.createElement('div');
  overlay.id='alertsScreen';
  overlay.style.cssText='position:fixed;inset:0;background:#0e1016;z-index:800;display:flex;flex-direction:column;';
  const active=priceAlerts.filter(a=>a.active);
  overlay.innerHTML=`
    <div style="display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #1a1f2e;flex-shrink:0;">
      <button onclick="document.getElementById('alertsScreen').remove()" style="background:#1c2130;border:none;color:#fff;width:34px;height:34px;border-radius:8px;cursor:pointer;font-size:16px;margin-right:12px;">‚Üê</button>
      <div style="font-size:20px;font-weight:700;color:#fff;">üîî Price Alerts</div>
      <button onclick="showVoiceAlertForm()" style="margin-left:auto;background:#17c3a8;border:none;color:#000;padding:8px 14px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;">+ New Alert</button>
    </div>
    <div style="padding:12px 16px;background:#131820;border-bottom:1px solid #1a1f2e;flex-shrink:0;">
      <div style="font-size:13px;color:#8b949e;line-height:1.8;">
        üéôÔ∏è <b style="color:#fff;">Voice:</b> "Alert HDFC at 1700" ¬∑ "Reliance above 2900" ¬∑ "TCS below 3800"<br>
        üìû <b style="color:#fff;">Alert triggers:</b> Voice notification + Screen call + Alarm sound
      </div>
    </div>
    <div style="flex:1;overflow-y:auto;" id="alertsPanel"></div>
    <div style="padding:16px;flex-shrink:0;">
      <button onclick="showVoiceAlertForm()" style="width:100%;padding:14px;background:linear-gradient(135deg,#1a6b5e,#17c3a8);border:none;border-radius:12px;color:#000;font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
        üéôÔ∏è Set Alert by Voice
      </button>
    </div>`;
  document.body.appendChild(overlay);
  renderAlertsPanel();
}

function showVoiceAlertForm(){
  // Quick manual form + voice option
  const overlay=document.createElement('div');
  overlay.id='alertForm';
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:900;display:flex;align-items:flex-end;';
  overlay.innerHTML=`
    <div style="width:100%;background:#131820;border-radius:20px 20px 0 0;padding:20px 20px 40px;">
      <div style="width:32px;height:3px;background:#2a2f3e;border-radius:2px;margin:0 auto 16px;"></div>
      <div style="font-size:18px;font-weight:700;color:#fff;margin-bottom:16px;">üîî New Price Alert</div>
      <div style="margin-bottom:12px;">
        <div style="font-size:12px;color:#8b949e;margin-bottom:5px;font-weight:500;">STOCK SYMBOL</div>
        <input id="alSym" placeholder="e.g. RELIANCE, HDFC, TCS" style="width:100%;background:#0e1016;border:1px solid #2a2f3e;border-radius:10px;padding:12px;color:#fff;font-size:15px;outline:none;font-family:Inter,sans-serif;" oninput="this.value=this.value.toUpperCase()">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
        <div>
          <div style="font-size:12px;color:#8b949e;margin-bottom:5px;font-weight:500;">TARGET PRICE (‚Çπ)</div>
          <input id="alPrice" type="number" placeholder="2900" style="width:100%;background:#0e1016;border:1px solid #2a2f3e;border-radius:10px;padding:12px;color:#fff;font-size:15px;outline:none;font-family:Inter,sans-serif;">
        </div>
        <div>
          <div style="font-size:12px;color:#8b949e;margin-bottom:5px;font-weight:500;">TRIGGER TYPE</div>
          <select id="alType" style="width:100%;background:#0e1016;border:1px solid #2a2f3e;border-radius:10px;padding:12px;color:#fff;font-size:15px;outline:none;font-family:Inter,sans-serif;">
            <option value="above">‚Üë Price Upar Jaye</option>
            <option value="below">‚Üì Price Neeche Aaye</option>
          </select>
        </div>
      </div>
      <div style="background:#1a1f2e;border-radius:10px;padding:12px;margin-bottom:14px;font-size:13px;color:#8b949e;">
        üìû Alert trigger hone par: Voice call + Alarm + Screen notification
      </div>
      <div style="display:flex;gap:10px;">
        <button onclick="document.getElementById('alertForm').remove()" style="flex:1;padding:14px;background:#1c2130;border:none;border-radius:12px;color:#fff;font-size:15px;cursor:pointer;">Cancel</button>
        <button onclick="submitAlertForm()" style="flex:2;padding:14px;background:#17c3a8;border:none;border-radius:12px;color:#000;font-size:15px;font-weight:700;cursor:pointer;">Set Alert üîî</button>
      </div>
    </div>`;
  overlay.onclick=e=>{if(e.target===overlay)overlay.remove();};
  document.body.appendChild(overlay);
  setTimeout(()=>document.getElementById('alSym')?.focus(),300);
}

function submitAlertForm(){
  const sym=(document.getElementById('alSym')?.value||'').trim().toUpperCase();
  const price=parseFloat(document.getElementById('alPrice')?.value||0);
  const type=document.getElementById('alType')?.value||'above';
  if(!sym||!price){notif('‚ùå','Error','Stock aur price dono daalo');return;}
  const exists=STOCKS.find(s=>s.s===sym);
  if(!exists){notif('‚ùå','Stock Not Found',sym+' hamare database mein nahi hai');return;}
  document.getElementById('alertForm')?.remove();
  addPriceAlert(sym,price,type);
  renderAlertsPanel();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FUNDS & PAYMENT SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let payTab = 'overview'; // overview | add | withdraw | history
const PAYMENT_HISTORY = [
  {type:'credit',method:'UPI',amount:50000,date:'28 Feb 2025',status:'SUCCESS',ref:'YBL2502281234'},
  {type:'credit',method:'NEFT',amount:100000,date:'20 Feb 2025',status:'SUCCESS',ref:'HDFC250220567'},
  {type:'debit',method:'Withdrawal',amount:25000,date:'15 Feb 2025',status:'SUCCESS',ref:'WDL250215890'},
  {type:'credit',method:'Debit Card',amount:10000,date:'10 Feb 2025',status:'SUCCESS',ref:'DC250210234'},
];

function buildFunds(){
  const fundsC = document.getElementById('fundsC');
  if(!fundsC) return;
  
  const tabs = ['overview','add','withdraw','history'];
  const tabLabels = ['Overview','Add Money','Withdraw','History'];
  
  fundsC.innerHTML = `
  <!-- Balance Cards -->
  <div style="padding:16px;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);margin:0;border-bottom:1px solid #1a1f2e;">
    <div style="font-size:13px;color:rgba(255,255,255,.6);margin-bottom:4px;">Available Balance</div>
    <div style="font-size:36px;font-weight:800;color:#fff;margin-bottom:4px;">‚Çπ1,24,500</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:14px;">
      <div style="background:rgba(255,255,255,.08);border-radius:10px;padding:10px;text-align:center;">
        <div style="font-size:11px;color:rgba(255,255,255,.5);margin-bottom:3px;">Invested</div>
        <div style="font-size:14px;font-weight:700;color:#fff;">‚Çπ4.24L</div>
      </div>
      <div style="background:rgba(255,255,255,.08);border-radius:10px;padding:10px;text-align:center;">
        <div style="font-size:11px;color:rgba(255,255,255,.5);margin-bottom:3px;">Margin Used</div>
        <div style="font-size:14px;font-weight:700;color:#f59e0b;">‚Çπ89,200</div>
      </div>
      <div style="background:rgba(255,255,255,.08);border-radius:10px;padding:10px;text-align:center;">
        <div style="font-size:11px;color:rgba(255,255,255,.5);margin-bottom:3px;">Today P&L</div>
        <div style="font-size:14px;font-weight:700;color:#17c3a8;">+‚Çπ4,284</div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div style="display:flex;border-bottom:1px solid #1a1f2e;overflow-x:auto;">
    ${tabs.map((t,i)=>`<div style="padding:12px 18px;font-size:14px;font-weight:500;cursor:pointer;border-bottom:2px solid ${payTab===t?'#fff':'transparent'};color:${payTab===t?'#fff':'#8b949e'};white-space:nowrap;" onclick="payTab='${t}';buildFunds()">${tabLabels[i]}</div>`).join('')}
  </div>

  <!-- Tab Content -->
  <div id="payContent"></div>`;

  const pc = document.getElementById('payContent');
  if(payTab==='overview') pc.innerHTML = fundsOverview();
  else if(payTab==='add') pc.innerHTML = fundsAdd();
  else if(payTab==='withdraw') pc.innerHTML = fundsWithdraw();
  else pc.innerHTML = fundsHistory();
}

function fundsOverview(){
  return `
  <!-- Quick actions -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:16px;">
    <button onclick="payTab='add';buildFunds()" style="background:#17c3a8;border:none;border-radius:12px;padding:16px;color:#000;font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
      <span style="font-size:20px;">+</span> Add Money
    </button>
    <button onclick="payTab='withdraw';buildFunds()" style="background:#1c2130;border:1px solid #2a2f3e;border-radius:12px;padding:16px;color:#fff;font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
      <span style="font-size:20px;">‚Üë</span> Withdraw
    </button>
  </div>

  <!-- Linked Banks -->
  <div style="padding:0 16px 10px;font-size:12px;color:#8b949e;font-weight:600;text-transform:uppercase;letter-spacing:.5px;">Linked Bank Accounts</div>
  ${[
    {bank:'SBI',acc:'XXXX 4521',type:'Savings',color:'#1a6b5e'},
    {bank:'HDFC',acc:'XXXX 8834',type:'Savings',color:'#6b3fa0'},
    {bank:'AXIS',acc:'XXXX 2219',type:'Current',color:'#b45309'},
  ].map(b=>`
  <div style="display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #0d1017;cursor:pointer;" onclick="notif('üè¶','${b.bank} Bank','XXXX ${b.acc.split(' ')[1]} ‚Äî Primary account')">
    <div style="width:42px;height:42px;border-radius:12px;background:${b.color};display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:#fff;margin-right:12px;">${b.bank.slice(0,2)}</div>
    <div style="flex:1;">
      <div style="font-size:15px;font-weight:600;color:#fff;">${b.bank} Bank</div>
      <div style="font-size:13px;color:#8b949e;">${b.acc} ¬∑ ${b.type}</div>
    </div>
    <div style="font-size:12px;color:#17c3a8;font-weight:600;">PRIMARY</div>
  </div>`).join('')}
  <button onclick="notif('üè¶','Add Bank','KYC verification required')" style="display:flex;align-items:center;gap:10px;width:calc(100%-32px);margin:10px 16px;background:#1c2130;border:1px dashed #2a2f3e;border-radius:12px;padding:14px;color:#8b949e;font-size:14px;cursor:pointer;width:calc(100% - 32px);">
    + Add New Bank Account
  </button>

  <!-- UPI IDs -->
  <div style="padding:16px 16px 10px;font-size:12px;color:#8b949e;font-weight:600;text-transform:uppercase;letter-spacing:.5px;">UPI IDs</div>
  ${['amitk@ybl','amitk@oksbi','amitk@okaxis'].map(upi=>`
  <div style="display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #0d1017;">
    <div style="width:38px;height:38px;border-radius:10px;background:#1c2130;display:flex;align-items:center;justify-content:center;font-size:18px;margin-right:12px;">‚Çø</div>
    <div style="flex:1;font-size:14px;color:#fff;">${upi}</div>
    <div style="font-size:12px;color:#17c3a8;font-weight:500;">ACTIVE</div>
  </div>`).join('')}
  <div style="height:30px;"></div>`;
}

function fundsAdd(){
  return `
  <div style="padding:16px;">
    <!-- Amount input -->
    <div style="background:#131820;border-radius:14px;padding:18px;margin-bottom:16px;">
      <div style="font-size:12px;color:#8b949e;margin-bottom:8px;font-weight:500;">AMOUNT TO ADD (‚Çπ)</div>
      <input id="addAmt" type="number" placeholder="Enter amount" value="10000" style="width:100%;background:transparent;border:none;outline:none;font-size:32px;font-weight:700;color:#fff;font-family:Inter,sans-serif;">
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;">
        ${[5000,10000,25000,50000,100000].map(a=>`<button onclick="document.getElementById('addAmt').value=${a}" style="padding:6px 14px;background:#1c2130;border:1px solid #2a2f3e;border-radius:20px;color:#8b949e;font-size:13px;cursor:pointer;font-family:Inter,sans-serif;">‚Çπ${(a/1000).toFixed(0)}K</button>`).join('')}
      </div>
    </div>

    <!-- Payment Methods -->
    <div style="font-size:14px;font-weight:600;color:#8b949e;margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px;font-size:12px;">SELECT PAYMENT METHOD</div>

    <!-- UPI -->
    <div style="background:#131820;border-radius:14px;overflow:hidden;margin-bottom:12px;">
      <div style="padding:14px 16px;border-bottom:1px solid #0d1017;cursor:pointer;display:flex;align-items:center;gap:12px;" onclick="showPaymentFlow('UPI','PhonePe / GPay / Paytm')">
        <div style="width:42px;height:42px;border-radius:10px;background:#4f46e51a;display:flex;align-items:center;justify-content:center;font-size:22px;">‚Çø</div>
        <div style="flex:1;">
          <div style="font-size:15px;font-weight:600;color:#fff;">UPI</div>
          <div style="font-size:12px;color:#8b949e;">PhonePe ¬∑ GPay ¬∑ Paytm ¬∑ BHIM</div>
        </div>
        <div style="display:flex;gap:4px;align-items:center;"><span style="font-size:10px;background:#17c3a81a;color:#17c3a8;padding:2px 8px;border-radius:10px;font-weight:600;">INSTANT</span><span style="color:#8b949e;">‚Ä∫</span></div>
      </div>
      <div style="padding:14px 16px;cursor:pointer;display:flex;align-items:center;gap:12px;" onclick="showUPIInput()">
        <div style="width:42px;height:42px;border-radius:10px;background:#17c3a81a;display:flex;align-items:center;justify-content:center;font-size:18px;">@</div>
        <div style="flex:1;">
          <div style="font-size:15px;font-weight:600;color:#fff;">UPI ID</div>
          <div style="font-size:12px;color:#8b949e;">Enter any UPI ID directly</div>
        </div>
        <span style="color:#8b949e;">‚Ä∫</span>
      </div>
    </div>

    <!-- Net Banking -->
    <div style="background:#131820;border-radius:14px;overflow:hidden;margin-bottom:12px;">
      <div style="padding:14px 16px;border-bottom:1px solid #0d1017;">
        <div style="font-size:13px;font-weight:600;color:#8b949e;margin-bottom:10px;">NET BANKING</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          ${[{n:'SBI',c:'#1a6b5e'},{n:'HDFC',c:'#6b3fa0'},{n:'ICICI',c:'#c0392b'},{n:'AXIS',c:'#b45309'},{n:'KOTAK',c:'#d97706'},{n:'PNB',c:'#1d4ed8'}].map(b=>`
          <div onclick="showPaymentFlow('Net Banking','${b.n} Bank')" style="display:flex;align-items:center;gap:8px;background:#0e1016;border-radius:10px;padding:10px 12px;cursor:pointer;">
            <div style="width:32px;height:32px;border-radius:8px;background:${b.c};display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;">${b.n.slice(0,2)}</div>
            <span style="font-size:13px;font-weight:500;color:#fff;">${b.n}</span>
          </div>`).join('')}
        </div>
        <button onclick="showPaymentFlow('Net Banking','Other Bank')" style="width:100%;margin-top:8px;padding:10px;background:#0e1016;border:none;border-radius:10px;color:#8b949e;font-size:13px;cursor:pointer;font-family:Inter,sans-serif;">Other Banks ‚Ä∫</button>
      </div>
    </div>

    <!-- Debit Card -->
    <div style="background:#131820;border-radius:14px;overflow:hidden;margin-bottom:12px;">
      <div style="padding:14px 16px;border-bottom:1px solid #0d1017;cursor:pointer;" onclick="showCardForm('debit')">
        <div style="display:flex;align-items:center;gap:12px;">
          <div style="width:42px;height:42px;border-radius:10px;background:#1d4ed81a;display:flex;align-items:center;justify-content:center;font-size:22px;">üí≥</div>
          <div style="flex:1;">
            <div style="font-size:15px;font-weight:600;color:#fff;">Debit Card</div>
            <div style="font-size:12px;color:#8b949e;">Visa ¬∑ Mastercard ¬∑ RuPay ¬∑ Maestro</div>
          </div>
          <span style="color:#8b949e;">‚Ä∫</span>
        </div>
      </div>
      <div style="padding:14px 16px;cursor:pointer;" onclick="showCardForm('credit')">
        <div style="display:flex;align-items:center;gap:12px;">
          <div style="width:42px;height:42px;border-radius:10px;background:#7c3aed1a;display:flex;align-items:center;justify-content:center;font-size:22px;">üíé</div>
          <div style="flex:1;">
            <div style="font-size:15px;font-weight:600;color:#fff;">Credit Card</div>
            <div style="font-size:12px;color:#8b949e;">Visa ¬∑ Mastercard ¬∑ Amex ¬∑ Diners</div>
          </div>
          <span style="color:#8b949e;">‚Ä∫</span>
        </div>
      </div>
    </div>

    <!-- NEFT/IMPS -->
    <div style="background:#131820;border-radius:14px;overflow:hidden;margin-bottom:12px;cursor:pointer;" onclick="showNEFTDetails()">
      <div style="padding:14px 16px;display:flex;align-items:center;gap:12px;">
        <div style="width:42px;height:42px;border-radius:10px;background:#f59e0b1a;display:flex;align-items:center;justify-content:center;font-size:22px;">üè¶</div>
        <div style="flex:1;">
          <div style="font-size:15px;font-weight:600;color:#fff;">NEFT / IMPS / RTGS</div>
          <div style="font-size:12px;color:#8b949e;">Direct bank transfer to Bulls Eye account</div>
        </div>
        <span style="color:#8b949e;">‚Ä∫</span>
      </div>
    </div>
  </div>
  <div style="height:30px;"></div>`;
}

function fundsWithdraw(){
  return `
  <div style="padding:16px;">
    <div style="background:#131820;border-radius:14px;padding:18px;margin-bottom:16px;">
      <div style="font-size:12px;color:#8b949e;margin-bottom:4px;">Available to Withdraw</div>
      <div style="font-size:28px;font-weight:700;color:#fff;margin-bottom:2px;">‚Çπ1,24,500</div>
      <div style="font-size:13px;color:#8b949e;">Settlement T+1 ¬∑ Bank by 4:30 PM</div>
    </div>
    <div style="font-size:12px;color:#8b949e;margin-bottom:8px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;">AMOUNT (‚Çπ)</div>
    <input id="wdAmt" type="number" placeholder="Enter amount" value="25000" style="width:100%;background:#131820;border:1px solid #2a2f3e;border-radius:12px;padding:14px;color:#fff;font-size:18px;font-weight:600;outline:none;font-family:Inter,sans-serif;margin-bottom:12px;">
    <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
      ${[10000,25000,50000,100000].map(a=>`<button onclick="document.getElementById('wdAmt').value=${a}" style="padding:6px 14px;background:#1c2130;border:1px solid #2a2f3e;border-radius:20px;color:#8b949e;font-size:13px;cursor:pointer;font-family:Inter,sans-serif;">‚Çπ${(a/1000).toFixed(0)}K</button>`).join('')}
    </div>
    <div style="font-size:12px;color:#8b949e;margin-bottom:8px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;">WITHDRAW TO</div>
    ${[
      {bank:'SBI',acc:'XXXX 4521',color:'#1a6b5e'},
      {bank:'HDFC',acc:'XXXX 8834',color:'#6b3fa0'},
    ].map(b=>`
    <div onclick="initiateWithdraw('${b.bank}')" style="display:flex;align-items:center;padding:14px 16px;border:1px solid #2a2f3e;border-radius:12px;margin-bottom:10px;cursor:pointer;background:#131820;">
      <div style="width:42px;height:42px;border-radius:12px;background:${b.color};display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:#fff;margin-right:12px;">${b.bank.slice(0,2)}</div>
      <div style="flex:1;">
        <div style="font-size:15px;font-weight:600;color:#fff;">${b.bank} Bank</div>
        <div style="font-size:13px;color:#8b949e;">Savings ¬∑ ${b.acc}</div>
      </div>
      <span style="color:#8b949e;">‚Ä∫</span>
    </div>`).join('')}
    <button onclick="initiateWithdraw('SBI')" style="width:100%;padding:14px;background:#17c3a8;border:none;border-radius:12px;color:#000;font-size:16px;font-weight:700;cursor:pointer;margin-top:6px;">Withdraw Now ‚Üë</button>
    <div style="font-size:12px;color:#8b949e;text-align:center;margin-top:10px;">‚è± Credited within 24 hours (T+1 settlement)</div>
  </div>
  <div style="height:30px;"></div>`;
}

function fundsHistory(){
  const all = JSON.parse(localStorage.getItem('be_payments')||'[]').concat(PAYMENT_HISTORY);
  return `
  <div style="padding:0 16px 8px;padding-top:12px;">
    <div style="font-size:12px;color:#8b949e;font-weight:600;text-transform:uppercase;letter-spacing:.5px;padding-bottom:8px;">Transaction History</div>
    ${all.map(p=>`
    <div style="display:flex;align-items:center;padding:14px 0;border-bottom:1px solid #0d1017;">
      <div style="width:42px;height:42px;border-radius:12px;background:${p.type==='credit'?'#17c3a81a':'#f0627a1a'};display:flex;align-items:center;justify-content:center;font-size:20px;margin-right:12px;">${p.type==='credit'?'‚Üì':'‚Üë'}</div>
      <div style="flex:1;">
        <div style="font-size:15px;font-weight:600;color:#fff;">${p.method}</div>
        <div style="font-size:12px;color:#8b949e;">${p.date} ¬∑ Ref: ${p.ref}</div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:16px;font-weight:700;color:${p.type==='credit'?'#17c3a8':'#f0627a'};">${p.type==='credit'?'+':'‚àí'}‚Çπ${p.amount.toLocaleString('en-IN')}</div>
        <div style="font-size:11px;color:#17c3a8;font-weight:600;">${p.status}</div>
      </div>
    </div>`).join('')}
  </div>
  <div style="height:30px;"></div>`;
}

// ‚îÄ‚îÄ PAYMENT FLOW MODALS ‚îÄ‚îÄ
function showPaymentFlow(method, bank){
  const amt = document.getElementById('addAmt')?.value||10000;
  const overlay=document.createElement('div');
  overlay.id='payOv';
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:900;display:flex;align-items:flex-end;';
  overlay.innerHTML=`
    <div style="width:100%;background:#131820;border-radius:20px 20px 0 0;padding:20px 20px 48px;">
      <div style="width:32px;height:3px;background:#2a2f3e;border-radius:2px;margin:0 auto 18px;"></div>
      <div style="font-size:18px;font-weight:700;color:#fff;margin-bottom:4px;">${method} ¬∑ ${bank}</div>
      <div style="font-size:14px;color:#8b949e;margin-bottom:20px;">Adding ‚Çπ${Number(amt).toLocaleString('en-IN')} to Bulls Eye</div>
      <div style="background:#0e1016;border-radius:12px;padding:16px;margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="font-size:13px;color:#8b949e;">Amount</span><span style="font-size:14px;font-weight:600;color:#fff;">‚Çπ${Number(amt).toLocaleString('en-IN')}</span></div>
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="font-size:13px;color:#8b949e;">Charges</span><span style="font-size:14px;font-weight:600;color:#17c3a8;">FREE</span></div>
        <div style="display:flex;justify-content:space-between;border-top:1px solid #1a1f2e;padding-top:8px;"><span style="font-size:14px;font-weight:600;color:#fff;">Total</span><span style="font-size:16px;font-weight:700;color:#fff;">‚Çπ${Number(amt).toLocaleString('en-IN')}</span></div>
      </div>
      <button onclick="processPayment('${method}',${amt})" style="width:100%;padding:14px;background:#17c3a8;border:none;border-radius:12px;color:#000;font-size:16px;font-weight:700;cursor:pointer;margin-bottom:10px;">Proceed to ${method} ‚Üí</button>
      <button onclick="document.getElementById('payOv').remove()" style="width:100%;padding:12px;background:transparent;border:1px solid #2a2f3e;border-radius:12px;color:#fff;font-size:14px;cursor:pointer;">Cancel</button>
    </div>`;
  overlay.onclick=e=>{if(e.target===overlay)overlay.remove();};
  document.body.appendChild(overlay);
}

function showUPIInput(){
  const amt = document.getElementById('addAmt')?.value||10000;
  const overlay=document.createElement('div');
  overlay.id='upiOv';
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:900;display:flex;align-items:flex-end;';
  overlay.innerHTML=`
    <div style="width:100%;background:#131820;border-radius:20px 20px 0 0;padding:20px 20px 48px;">
      <div style="width:32px;height:3px;background:#2a2f3e;border-radius:2px;margin:0 auto 18px;"></div>
      <div style="font-size:18px;font-weight:700;color:#fff;margin-bottom:16px;">Enter UPI ID</div>
      <input id="upiId" placeholder="yourname@ybl / @oksbi / @okaxis" style="width:100%;background:#0e1016;border:1px solid #2a2f3e;border-radius:12px;padding:14px;color:#fff;font-size:15px;outline:none;font-family:Inter,sans-serif;margin-bottom:12px;">
      <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
        ${['@ybl','@oksbi','@okaxis','@paytm','@upi','@okhdfcbank'].map(s=>`<button onclick="const el=document.getElementById('upiId');el.value=el.value.split('@')[0]+\`${s}\`" style="padding:5px 12px;background:#1c2130;border:1px solid #2a2f3e;border-radius:14px;color:#8b949e;font-size:12px;cursor:pointer;font-family:Inter,sans-serif;">${s}</button>`).join('')}
      </div>
      <button onclick="const uid=document.getElementById('upiId').value;if(uid.includes('@')){document.getElementById('upiOv').remove();processPayment('UPI',${amt});}else{notif('‚ùå','Invalid UPI','@bank suffix add karo');}" style="width:100%;padding:14px;background:#17c3a8;border:none;border-radius:12px;color:#000;font-size:16px;font-weight:700;cursor:pointer;margin-bottom:10px;">Verify & Pay ‚Üí</button>
      <button onclick="document.getElementById('upiOv').remove()" style="width:100%;padding:12px;background:transparent;border:1px solid #2a2f3e;border-radius:12px;color:#fff;font-size:14px;cursor:pointer;">Cancel</button>
    </div>`;
  overlay.onclick=e=>{if(e.target===overlay)overlay.remove();};
  document.body.appendChild(overlay);
  setTimeout(()=>document.getElementById('upiId')?.focus(),300);
}

function showCardForm(type){
  const amt = document.getElementById('addAmt')?.value||10000;
  const overlay=document.createElement('div');
  overlay.id='cardOv';
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:900;display:flex;align-items:flex-end;overflow-y:auto;';
  overlay.innerHTML=`
    <div style="width:100%;background:#131820;border-radius:20px 20px 0 0;padding:20px 20px 48px;min-height:auto;">
      <div style="width:32px;height:3px;background:#2a2f3e;border-radius:2px;margin:0 auto 18px;"></div>
      <div style="font-size:18px;font-weight:700;color:#fff;margin-bottom:4px;">${type==='credit'?'üíé Credit':'üí≥ Debit'} Card</div>
      <div style="font-size:13px;color:#8b949e;margin-bottom:20px;">Amount: ‚Çπ${Number(amt).toLocaleString('en-IN')} ¬∑ Secure payment</div>
      
      <!-- Card Preview -->
      <div style="background:linear-gradient(135deg,${type==='credit'?'#4c1d95,#7c3aed':'#1a4463,#2563eb'});border-radius:16px;padding:20px;margin-bottom:20px;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;">
          <div style="font-size:20px;">üí≥</div>
          <div style="font-size:12px;color:rgba(255,255,255,.6);">${type.toUpperCase()} CARD</div>
        </div>
        <div style="font-size:18px;font-weight:600;color:#fff;letter-spacing:3px;margin-bottom:14px;" id="cardPreview">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
        <div style="display:flex;justify-content:space-between;">
          <div><div style="font-size:10px;color:rgba(255,255,255,.5);">CARD HOLDER</div><div style="font-size:13px;color:#fff;font-weight:600;">AMIT KUMAR</div></div>
          <div><div style="font-size:10px;color:rgba(255,255,255,.5);">EXPIRES</div><div style="font-size:13px;color:#fff;font-weight:600;" id="expPreview">MM/YY</div></div>
        </div>
      </div>

      <div style="margin-bottom:12px;">
        <div style="font-size:12px;color:#8b949e;margin-bottom:6px;font-weight:500;">CARD NUMBER</div>
        <input id="cardNum" maxlength="19" placeholder="1234 5678 9012 3456" oninput="fmtCard(this)" style="width:100%;background:#0e1016;border:1px solid #2a2f3e;border-radius:10px;padding:12px;color:#fff;font-size:16px;letter-spacing:2px;outline:none;font-family:Inter,sans-serif;">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
        <div>
          <div style="font-size:12px;color:#8b949e;margin-bottom:6px;font-weight:500;">EXPIRY (MM/YY)</div>
          <input id="cardExp" maxlength="5" placeholder="MM/YY" oninput="fmtExp(this)" style="width:100%;background:#0e1016;border:1px solid #2a2f3e;border-radius:10px;padding:12px;color:#fff;font-size:15px;outline:none;font-family:Inter,sans-serif;">
        </div>
        <div>
          <div style="font-size:12px;color:#8b949e;margin-bottom:6px;font-weight:500;">CVV</div>
          <input id="cardCvv" maxlength="4" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢" style="width:100%;background:#0e1016;border:1px solid #2a2f3e;border-radius:10px;padding:12px;color:#fff;font-size:15px;outline:none;font-family:Inter,sans-serif;">
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;background:#0e1016;border-radius:10px;padding:12px;margin-bottom:16px;">
        <span style="font-size:18px;">üîí</span>
        <span style="font-size:12px;color:#8b949e;">256-bit SSL encrypted ¬∑ PCI DSS compliant ¬∑ 3D Secure</span>
      </div>
      <button onclick="processCardPayment(${amt})" style="width:100%;padding:14px;background:#17c3a8;border:none;border-radius:12px;color:#000;font-size:16px;font-weight:700;cursor:pointer;margin-bottom:10px;">Pay ‚Çπ${Number(amt).toLocaleString('en-IN')} Securely üîí</button>
      <button onclick="document.getElementById('cardOv').remove()" style="width:100%;padding:12px;background:transparent;border:1px solid #2a2f3e;border-radius:12px;color:#fff;font-size:14px;cursor:pointer;">Cancel</button>
    </div>`;
  overlay.onclick=e=>{if(e.target===overlay)overlay.remove();};
  document.body.appendChild(overlay);
}

function fmtCard(el){
  let v=el.value.replace(/\D/g,'').slice(0,16);
  el.value=v.replace(/(.{4})/g,'$1 ').trim();
  const p=document.getElementById('cardPreview');
  if(p) p.textContent=(v+'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢').slice(0,16).replace(/(.{4})/g,'$1 ').trim();
}
function fmtExp(el){
  let v=el.value.replace(/\D/g,'').slice(0,4);
  if(v.length>2) v=v.slice(0,2)+'/'+v.slice(2);
  el.value=v;
  const p=document.getElementById('expPreview');
  if(p) p.textContent=v||'MM/YY';
}

function showNEFTDetails(){
  const overlay=document.createElement('div');
  overlay.id='neftOv';
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:900;display:flex;align-items:flex-end;';
  overlay.innerHTML=`
    <div style="width:100%;background:#131820;border-radius:20px 20px 0 0;padding:20px 20px 48px;">
      <div style="width:32px;height:3px;background:#2a2f3e;border-radius:2px;margin:0 auto 18px;"></div>
      <div style="font-size:18px;font-weight:700;color:#fff;margin-bottom:16px;">üè¶ Bank Transfer Details</div>
      ${[
        ['Account Name','Bulls Eye Securities Pvt Ltd'],
        ['Account Number','000205019876'],
        ['Account Type','Current'],
        ['Bank','HDFC Bank'],
        ['IFSC Code','HDFC0000123'],
        ['Branch','Mumbai ‚Äî Fort Branch'],
        ['SWIFT','HDFCINBB'],
      ].map(([l,v])=>`
      <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #0d1017;">
        <span style="font-size:13px;color:#8b949e;">${l}</span>
        <span style="font-size:13px;font-weight:600;color:#fff;text-align:right;max-width:60%;">${v}</span>
      </div>`).join('')}
      <div style="background:#17c3a81a;border:1px solid #17c3a840;border-radius:10px;padding:12px;margin-top:14px;">
        <div style="font-size:13px;color:#17c3a8;">‚ö° IMPS ‚Äî Instant ¬∑ NEFT ‚Äî 2 hrs ¬∑ RTGS ‚Äî ‚Çπ2L+ only</div>
      </div>
      <button onclick="document.getElementById('neftOv').remove()" style="width:100%;padding:14px;background:#1c2130;border:none;border-radius:12px;color:#fff;font-size:15px;cursor:pointer;margin-top:14px;">Done</button>
    </div>`;
  overlay.onclick=e=>{if(e.target===overlay)overlay.remove();};
  document.body.appendChild(overlay);
}

function processPayment(method, amount){
  document.getElementById('payOv')?.remove();
  document.getElementById('upiOv')?.remove();
  // Show processing
  const ov=document.createElement('div');
  ov.id='processingOv';
  ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:950;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;';
  ov.innerHTML=`<div style="font-size:48px;animation:spin 1s linear infinite;">‚è≥</div><div style="font-size:18px;font-weight:700;color:#fff;font-family:Inter,sans-serif;">Processing Payment...</div><div style="font-size:14px;color:#8b949e;font-family:Inter,sans-serif;">‚Çπ${Number(amount).toLocaleString('en-IN')} via ${method}</div>`;
  const style=document.createElement('style');style.textContent='@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}';
  document.head.appendChild(style);
  document.body.appendChild(ov);
  setTimeout(()=>{
    ov.remove();
    const h=JSON.parse(localStorage.getItem('be_payments')||'[]');
    h.unshift({type:'credit',method,amount:+amount,date:new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}),status:'SUCCESS',ref:`TXN${Date.now()}`});
    localStorage.setItem('be_payments',JSON.stringify(h));
    playAlarm('buy');
    speak(`‚Çπ${Number(amount).toLocaleString()} Bulls Eye mein add ho gaya`);
    notif('‚úÖ','Payment Successful!',`‚Çπ${Number(amount).toLocaleString('en-IN')} via ${method} ‚Äî Added to wallet`);
    payTab='history'; buildFunds();
  },2500);
}

function processCardPayment(amount){
  const num=(document.getElementById('cardNum')?.value||'').replace(/\s/g,'');
  const exp=document.getElementById('cardExp')?.value||'';
  const cvv=document.getElementById('cardCvv')?.value||'';
  if(num.length<16){notif('‚ùå','Error','16-digit card number daalo');return;}
  if(exp.length<5){notif('‚ùå','Error','Expiry date daalo MM/YY');return;}
  if(cvv.length<3){notif('‚ùå','Error','CVV daalo');return;}
  document.getElementById('cardOv')?.remove();
  processPayment('Card', amount);
}

function initiateWithdraw(bank){
  const amt = document.getElementById('wdAmt')?.value||25000;
  const ov=document.createElement('div');
  ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:900;display:flex;align-items:flex-end;';
  ov.innerHTML=`
    <div style="width:100%;background:#131820;border-radius:20px 20px 0 0;padding:20px 20px 48px;">
      <div style="width:32px;height:3px;background:#2a2f3e;border-radius:2px;margin:0 auto 18px;"></div>
      <div style="font-size:18px;font-weight:700;color:#fff;margin-bottom:16px;">Confirm Withdrawal</div>
      <div style="background:#0e1016;border-radius:12px;padding:16px;margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="font-size:13px;color:#8b949e;">Amount</span><span style="font-size:14px;font-weight:600;color:#fff;">‚Çπ${Number(amt).toLocaleString('en-IN')}</span></div>
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="font-size:13px;color:#8b949e;">To Bank</span><span style="font-size:14px;font-weight:600;color:#fff;">${bank} Bank</span></div>
        <div style="display:flex;justify-content:space-between;"><span style="font-size:13px;color:#8b949e;">Settlement</span><span style="font-size:14px;font-weight:600;color:#f59e0b;">T+1 by 4:30 PM</span></div>
      </div>
      <button onclick="this.closest('div[style]').remove();notif('‚úÖ','Withdrawal Initiated','‚Çπ${Number(amt).toLocaleString()} sent to ${bank} Bank ¬∑ T+1 settlement');speak('‚Çπ${Number(amt).toLocaleString()} withdrawal ho gaya ${bank} bank mein');" style="width:100%;padding:14px;background:#17c3a8;border:none;border-radius:12px;color:#000;font-size:16px;font-weight:700;cursor:pointer;margin-bottom:10px;">Confirm Withdrawal ‚Üë</button>
      <button onclick="this.closest('div[style]').remove()" style="width:100%;padding:12px;background:transparent;border:1px solid #2a2f3e;border-radius:12px;color:#fff;font-size:14px;cursor:pointer;">Cancel</button>
    </div>`;
  ov.onclick=e=>{if(e.target===ov)ov.remove();};
  document.body.appendChild(ov);
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEMAT ACCOUNT OPENING + API SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const BROKERS = [
  {
    id:'upstox', name:'Upstox', tagline:'Zero delivery, ‚Çπ20 F&O ¬∑ Free API',
    color:'#5c4df3', ico:'üìà', rating:'4.8', users:'1.2 Cr+', time:'15 min',
    perks:['Free Demat Account','‚Çπ0 Delivery Trades','‚Çπ20 F&O per order','Free API Access','Instant KYC (Aadhaar)'],
    apiSupport:true, wsSupport:true, apiName:'Upstox API v2',
    openUrl:'https://upstox.com/open-demat-account/?f=bullseye',
    apiUrl:'https://upstox.com/developer-api/',
    steps:['Mobile number verify','PAN details','Aadhaar OTP KYC','Bank account link','Start trading in 15 min'],
  },
  {
    id:'angel', name:'Angel One', tagline:'Free brokerage + SmartAPI free',
    color:'#ff6b35', ico:'üòá', rating:'4.7', users:'2.1 Cr+', time:'10 min',
    perks:['‚Çπ0 Delivery for life','Free SmartAPI access','WebSocket live feed','AI-powered advisory','Paperless account'],
    apiSupport:true, wsSupport:true, apiName:'Angel SmartAPI',
    openUrl:'https://www.angelone.in/open-demat-account/',
    apiUrl:'https://smartapi.angelone.in/',
    steps:['Enter mobile + OTP','PAN card verification','Aadhaar e-KYC','Selfie verification','Account ready in 10 min'],
  },
  {
    id:'zerodha', name:'Zerodha', tagline:'India\'s #1 broker ¬∑ Kite API',
    color:'#387ed1', ico:'üèÜ', rating:'4.9', users:'1.3 Cr+', time:'30 min',
    perks:['Most trusted broker','‚Çπ0 Delivery','‚Çπ20 Intraday/F&O','Kite API (‚Çπ2000/month)','Coin for MF'],
    apiSupport:true, wsSupport:true, apiName:'Kite Connect API',
    openUrl:'https://zerodha.com/open-account/',
    apiUrl:'https://kite.trade/',
    steps:['Enter PAN + DOB','Aadhaar OTP','Upload documents','In-person verify (optional)','3-5 working days'],
  },
  {
    id:'dhan', name:'Dhan', tagline:'Free + Best API for algo trading',
    color:'#00b4d8', ico:'üí°', rating:'4.6', users:'20L+', time:'10 min',
    perks:['Free Demat','Free API access','WebSocket feed','Paperless instant','Great for algo traders'],
    apiSupport:true, wsSupport:true, apiName:'Dhan API v2',
    openUrl:'https://join.dhan.co/',
    apiUrl:'https://dhanhq.co/docs/latest/',
    steps:['Mobile OTP','PAN + DOB','Aadhaar OTP KYC','Bank IFSC','Trading starts in 10 min'],
  },
  {
    id:'5paisa', name:'5paisa', tagline:'‚Çπ0 brokerage + free API',
    color:'#e63946', ico:'5Ô∏è‚É£', rating:'4.2', users:'40L+', time:'10 min',
    perks:['‚Çπ0 brokerage plans','Free API','Quick KYC','Low AMC','Good for beginners'],
    apiSupport:true, wsSupport:false, apiName:'5paisa Open API',
    openUrl:'https://www.5paisa.com/open-demat-account',
    apiUrl:'https://5paisa.com/technology/api',
    steps:['Mobile verify','PAN details','Aadhaar OTP','Bank details','Ready in 10 min'],
  },
  {
    id:'groww', name:'Groww', tagline:'Stocks + MF ¬∑ Easy app',
    color:'#00b386', ico:'üå±', rating:'4.5', users:'1.5 Cr+', time:'5 min',
    perks:['‚Çπ0 Delivery','Easy UI','Instant account','Mutual Funds','No API (trading only)'],
    apiSupport:false, wsSupport:false, apiName:'No API',
    openUrl:'https://groww.in/open-demat-account',
    apiUrl:null,
    steps:['Mobile + OTP','PAN','Aadhaar OTP','Selfie','5 min activation'],
  },
];

function buildDemat(){
  const el=document.getElementById('dematC');if(!el)return;
  el.innerHTML=`
  <!-- Hero -->
  <div style="background:linear-gradient(135deg,#0f2027,#203a43,#1a0533);padding:20px 16px 24px;">
    <div style="font-size:13px;color:rgba(255,255,255,.5);margin-bottom:8px;">Bulls Eye Partnership</div>
    <div style="font-size:24px;font-weight:800;color:#fff;margin-bottom:6px;line-height:1.3;">Open Demat Account<br>& Get Live Data FREE</div>
    <div style="font-size:14px;color:rgba(255,255,255,.6);line-height:1.6;margin-bottom:16px;">Account khulne ke baad <b style="color:#17c3a8;">API key paste karo</b> ‚Üí Bulls Eye automatically live rates le lega WebSocket se</div>
    <div style="display:flex;gap:8px;">
      <div style="background:rgba(255,255,255,.1);border-radius:10px;padding:10px 14px;text-align:center;flex:1;"><div style="font-size:20px;font-weight:800;color:#17c3a8;">Free</div><div style="font-size:11px;color:rgba(255,255,255,.5);">Demat</div></div>
      <div style="background:rgba(255,255,255,.1);border-radius:10px;padding:10px 14px;text-align:center;flex:1;"><div style="font-size:20px;font-weight:800;color:#17c3a8;">Free</div><div style="font-size:11px;color:rgba(255,255,255,.5);">API Access</div></div>
      <div style="background:rgba(255,255,255,.1);border-radius:10px;padding:10px 14px;text-align:center;flex:1;"><div style="font-size:20px;font-weight:800;color:#17c3a8;">100ms</div><div style="font-size:11px;color:rgba(255,255,255,.5);">Live Feed</div></div>
    </div>
  </div>

  <!-- HOW IT WORKS -->
  <div style="padding:16px;border-bottom:1px solid #1a1f2e;">
    <div style="font-size:14px;font-weight:700;color:#fff;margin-bottom:12px;">How Live Data Works üî¥</div>
    ${[
      ['1','Broker choose karo','Neeche se apna broker select karo'],
      ['2','Account kholo','15 min mein paperless KYC'],
      ['3','API key lo','Broker portal se API generate karo'],
      ['4','Yahan paste karo','Settings ‚Üí API Keys mein enter karo'],
      ['5','WebSocket connect','Bulls Eye automatically live ho jata hai'],
    ].map(([n,t,s])=>`
    <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:10px;">
      <div style="width:24px;height:24px;border-radius:50%;background:#17c3a8;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#000;flex-shrink:0;">${n}</div>
      <div><div style="font-size:14px;font-weight:600;color:#fff;">${t}</div><div style="font-size:12px;color:#8b949e;">${s}</div></div>
    </div>`).join('')}
  </div>

  <!-- BROKER CARDS -->
  <div style="padding:12px 16px 4px;font-size:12px;color:#8b949e;font-weight:600;text-transform:uppercase;letter-spacing:.5px;">Choose Your Broker</div>
  ${BROKERS.map(b=>`
  <div style="margin:0 16px 12px;background:#131820;border-radius:16px;overflow:hidden;border:1px solid #1a1f2e;">
    <div style="padding:16px;">
      <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:12px;">
        <div style="width:48px;height:48px;border-radius:14px;background:${b.color}22;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;">${b.ico}</div>
        <div style="flex:1;">
          <div style="display:flex;align-items:center;gap:8px;"><span style="font-size:18px;font-weight:700;color:#fff;">${b.name}</span>${b.apiSupport?`<span style="font-size:10px;background:#17c3a81a;color:#17c3a8;border:1px solid #17c3a840;padding:2px 7px;border-radius:10px;font-weight:600;">üî¥ LIVE API</span>`:'<span style="font-size:10px;background:#8b949e1a;color:#8b949e;border:1px solid #8b949e40;padding:2px 7px;border-radius:10px;">No API</span>'}</div>
          <div style="font-size:13px;color:#8b949e;margin-top:2px;">${b.tagline}</div>
          <div style="display:flex;gap:10px;margin-top:6px;"><span style="font-size:12px;color:#f59e0b;">‚≠ê ${b.rating}</span><span style="font-size:12px;color:#8b949e;">${b.users} users</span><span style="font-size:12px;color:#17c3a8;">‚è± ${b.time}</span></div>
        </div>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px;">
        ${b.perks.map(p=>`<span style="font-size:11px;color:#8b949e;background:#0e1016;padding:3px 8px;border-radius:6px;">‚úì ${p}</span>`).join('')}
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="openDematFlow('${b.id}')" style="flex:2;padding:12px;background:${b.color};border:none;border-radius:10px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;">Open Free Account ‚Üí</button>
        ${b.apiUrl?`<button onclick="showAPIGuide('${b.id}')" style="flex:1;padding:12px;background:#1c2130;border:1px solid #2a2f3e;border-radius:10px;color:#fff;font-size:13px;cursor:pointer;">API Guide</button>`:''}
      </div>
    </div>
  </div>`).join('')}
  <div style="height:30px;"></div>`;
}

function openDematFlow(brokerId){
  const b=BROKERS.find(x=>x.id===brokerId);if(!b)return;
  const ov=document.createElement('div');
  ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:900;display:flex;align-items:flex-end;';
  ov.innerHTML=`
    <div style="width:100%;background:#131820;border-radius:20px 20px 0 0;padding:20px 20px 48px;">
      <div style="width:32px;height:3px;background:#2a2f3e;border-radius:2px;margin:0 auto 18px;"></div>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
        <div style="width:48px;height:48px;border-radius:14px;background:${b.color}22;display:flex;align-items:center;justify-content:center;font-size:24px;">${b.ico}</div>
        <div><div style="font-size:20px;font-weight:700;color:#fff;">${b.name}</div><div style="font-size:13px;color:#8b949e;">${b.tagline}</div></div>
      </div>
      <div style="font-size:13px;font-weight:600;color:#8b949e;margin-bottom:10px;text-transform:uppercase;letter-spacing:.4px;">Account Opening Steps</div>
      ${b.steps.map((s,i)=>`<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #0d1017;"><div style="width:22px;height:22px;border-radius:50%;background:#17c3a8;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#000;flex-shrink:0;">${i+1}</div><div style="font-size:14px;color:#fff;">${s}</div></div>`).join('')}
      <div style="background:#17c3a81a;border:1px solid #17c3a840;border-radius:10px;padding:12px;margin-top:14px;font-size:13px;color:#17c3a8;">
        üî¥ Account khulne ke baad: Profile ‚Üí API Settings ‚Üí ${b.apiName} key paste karo ‚Üí Live data on!
      </div>
      <div style="display:flex;gap:10px;margin-top:16px;">
        <button onclick="this.closest('div[style]').remove()" style="flex:1;padding:13px;background:#1c2130;border:none;border-radius:12px;color:#fff;font-size:14px;cursor:pointer;">Cancel</button>
        <button onclick="window.open('${b.openUrl}','_blank');this.closest('div[style]').remove();notif('üìÇ','${b.name}','Account opening page khul gaya! Wapas aake API key enter karo');" style="flex:2;padding:13px;background:${b.color};border:none;border-radius:12px;color:#fff;font-size:15px;font-weight:700;cursor:pointer;">Open ${b.name} Account ‚Üí</button>
      </div>
    </div>`;
  ov.onclick=e=>{if(e.target===ov)ov.remove();};
  document.body.appendChild(ov);
}

function showAPIGuide(brokerId){
  const b=BROKERS.find(x=>x.id===brokerId);if(!b||!b.apiUrl)return;
  const guides={
    upstox:`1. Login to Upstox ‚Üí My Account ‚Üí Apps\n2. Create New App ‚Üí Get API Key + Secret\n3. Generate Access Token via OAuth\n4. Paste token in Bulls Eye API Settings`,
    angel:`1. Login AngelOne ‚Üí Smart API\n2. Register app ‚Üí Get API Key\n3. Generate JWT session token\n4. Paste both in Bulls Eye API Settings`,
    zerodha:`1. Apply at kite.trade (‚Çπ2000/month)\n2. Get API Key + Secret\n3. Login via OAuth ‚Üí Get access_token\n4. Paste in Bulls Eye API Settings`,
    dhan:`1. Login Dhan ‚Üí DhanHQ API\n2. Generate Client ID + Access Token\n3. Paste in Bulls Eye API Settings`,
    '5paisa':`1. Register at 5paisa developer portal\n2. Get App Name + API Key\n3. Generate token\n4. Paste in Bulls Eye API Settings`,
  };
  const ov=document.createElement('div');
  ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:900;display:flex;align-items:flex-end;';
  ov.innerHTML=`
    <div style="width:100%;background:#131820;border-radius:20px 20px 0 0;padding:20px 20px 48px;">
      <div style="width:32px;height:3px;background:#2a2f3e;border-radius:2px;margin:0 auto 18px;"></div>
      <div style="font-size:18px;font-weight:700;color:#fff;margin-bottom:16px;">${b.ico} ${b.apiName} ‚Äî Guide</div>
      <div style="background:#0e1016;border-radius:12px;padding:16px;font-size:14px;color:#ccc;line-height:2;white-space:pre-line;font-family:monospace;">${guides[brokerId]||'Guide not available'}</div>
      <div style="display:flex;gap:10px;margin-top:16px;">
        <button onclick="this.closest('div[style]').remove()" style="flex:1;padding:13px;background:#1c2130;border:none;border-radius:12px;color:#fff;font-size:14px;cursor:pointer;">Close</button>
        <button onclick="window.open('${b.apiUrl}','_blank')" style="flex:1;padding:13px;background:#17c3a8;border:none;border-radius:12px;color:#000;font-size:14px;font-weight:700;cursor:pointer;">Open Docs ‚Üí</button>
        <button onclick="this.closest('div[style]').remove();goTo('api')" style="flex:1;padding:13px;background:#5c4df3;border:none;border-radius:12px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;">Enter Key ‚Üí</button>
      </div>
    </div>`;
  ov.onclick=e=>{if(e.target===ov)ov.remove();};
  document.body.appendChild(ov);
}

// ‚ïê‚ïê‚ïê API SETTINGS ‚ïê‚ïê‚ïê
function buildAPISettings(){
  const el=document.getElementById('apiC');if(!el)return;
  const connected=Object.keys(API_KEYS).filter(k=>API_KEYS[k]).length;
  el.innerHTML=`
  <div style="background:${connected?'#17c3a81a':'#f59e0b1a'};border-bottom:1px solid ${connected?'#17c3a840':'#f59e0b40'};padding:14px 16px;">
    <div style="font-size:14px;font-weight:700;color:${connected?'#17c3a8':'#f59e0b'};">${connected?'üî¥ LIVE DATA CONNECTED':'‚ö° Demo Mode ‚Äî Connect API for live data'}</div>
    <div style="font-size:12px;color:#8b949e;margin-top:3px;">${connected?'WebSocket se real-time NSE data aa raha hai':'Broker account kholo ‚Üí API key paste karo ‚Üí Live ho jao'}</div>
  </div>

  <!-- Upstox -->
  <div style="padding:16px;">
    <div style="font-size:13px;color:#8b949e;font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-bottom:10px;">üìà Upstox API v2 (WebSocket)</div>
    <div style="font-size:12px;color:#555;margin-bottom:8px;">Access Token (OAuth2 JWT ‚Äî expires daily)</div>
    <div style="display:flex;gap:8px;margin-bottom:14px;">
      <input id="k_upstox" type="password" placeholder="eyJ0eXAiOiJKV1QiLCJhbGci..." value="${API_KEYS.upstoxToken||''}" style="flex:1;background:#0e1016;border:1px solid #2a2f3e;border-radius:10px;padding:11px;color:#fff;font-size:14px;outline:none;font-family:Inter,sans-serif;">
      <button onclick="saveKey('upstoxToken','k_upstox')" style="padding:11px 16px;background:#5c4df3;border:none;border-radius:10px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">Save</button>
    </div>

    <div style="font-size:13px;color:#8b949e;font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-bottom:10px;">üòá Angel One SmartAPI</div>
    <div style="font-size:12px;color:#555;margin-bottom:6px;">API Key</div>
    <input id="k_angelkey" type="password" placeholder="abc123xyz..." value="${API_KEYS.angelApiKey||''}" style="width:100%;background:#0e1016;border:1px solid #2a2f3e;border-radius:10px;padding:11px;color:#fff;font-size:14px;outline:none;font-family:Inter,sans-serif;margin-bottom:8px;">
    <div style="font-size:12px;color:#555;margin-bottom:6px;">JWT Token</div>
    <div style="display:flex;gap:8px;margin-bottom:14px;">
      <input id="k_angeljwt" type="password" placeholder="eyJ..." value="${API_KEYS.angelJwt||''}" style="flex:1;background:#0e1016;border:1px solid #2a2f3e;border-radius:10px;padding:11px;color:#fff;font-size:14px;outline:none;font-family:Inter,sans-serif;">
      <button onclick="saveKey2('angelApiKey','k_angelkey','angelJwt','k_angeljwt')" style="padding:11px 16px;background:#ff6b35;border:none;border-radius:10px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">Save</button>
    </div>

    <div style="font-size:13px;color:#8b949e;font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-bottom:10px;">üïê Twelve Data (REST + WS)</div>
    <div style="font-size:12px;color:#555;margin-bottom:6px;">Free at <b style="color:#17c3a8;">twelvedata.com</b> ‚Äî 800 req/day</div>
    <div style="display:flex;gap:8px;margin-bottom:14px;">
      <input id="k_twelve" placeholder="your_twelvedata_api_key" value="${API_KEYS.twelve||''}" style="flex:1;background:#0e1016;border:1px solid #2a2f3e;border-radius:10px;padding:11px;color:#fff;font-size:14px;outline:none;font-family:Inter,sans-serif;">
      <button onclick="saveKey('twelve','k_twelve')" style="padding:11px 16px;background:#00b4d8;border:none;border-radius:10px;color:#000;font-size:13px;font-weight:600;cursor:pointer;">Save</button>
    </div>

    <!-- Status -->
    <div style="background:#131820;border-radius:12px;padding:14px;margin-bottom:14px;">
      <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:10px;">Connection Status</div>
      ${[
        {n:'Upstox WebSocket',connected:!!API_KEYS.upstoxToken&&wsConnected,k:'upstoxToken'},
        {n:'Angel One REST',connected:!!API_KEYS.angelApiKey,k:'angelApiKey'},
        {n:'Twelve Data',connected:!!API_KEYS.twelve,k:'twelve'},
        {n:'Yahoo Finance',connected:true,k:null},
        {n:'NSE Direct Scrape',connected:true,k:null},
      ].map(x=>`<div style="display:flex;align-items:center;padding:8px 0;border-bottom:1px solid #0d1017;">
        <div style="width:8px;height:8px;border-radius:50%;background:${x.connected?'#17c3a8':'#3a3a3a'};margin-right:10px;${x.connected?'animation:blink 2s infinite':''}"></div>
        <div style="flex:1;font-size:13px;color:${x.connected?'#fff':'#555'};">${x.n}</div>
        <div style="font-size:12px;color:${x.connected?'#17c3a8':'#555'};">${x.connected?'ACTIVE':'NOT SET'}</div>
      </div>`).join('')}
    </div>

    <button onclick="goTo('demat')" style="width:100%;padding:13px;background:linear-gradient(135deg,#5c4df3,#17c3a8);border:none;border-radius:12px;color:#fff;font-size:15px;font-weight:700;cursor:pointer;margin-bottom:10px;">üìÇ Open Demat & Get API Key</button>
    <button onclick="testConnection()" style="width:100%;padding:12px;background:#1c2130;border:1px solid #2a2f3e;border-radius:12px;color:#fff;font-size:14px;cursor:pointer;">üîÑ Test Connection</button>
  </div>
  <div style="height:30px;"></div>`;
}

function saveKey(keyName, inputId){
  const val=document.getElementById(inputId)?.value?.trim();
  if(!val){notif('‚ùå','Error','Key empty hai');return;}
  API_KEYS[keyName]=val;
  localStorage.setItem('be_apikeys',JSON.stringify(API_KEYS));
  notif('‚úÖ','API Key Saved!','Reconnecting live feed...');
  speak('API key save ho gaya. Live data reconnect ho raha hai');
  // Restart live feed
  if(activeWS){try{activeWS.close();}catch(e){}}
  wsConnected=false; liveMode=false; fetchErrors=0;
  setTimeout(startLiveFeed, 1000);
  buildAPISettings();
}

function saveKey2(k1,i1,k2,i2){
  const v1=document.getElementById(i1)?.value?.trim(), v2=document.getElementById(i2)?.value?.trim();
  if(!v1||!v2){notif('‚ùå','Error','Dono fields bharo');return;}
  API_KEYS[k1]=v1; API_KEYS[k2]=v2;
  localStorage.setItem('be_apikeys',JSON.stringify(API_KEYS));
  notif('‚úÖ','Angel One API Saved!','Connecting...');
  speak('Angel One API save ho gaya');
  setTimeout(startLiveFeed, 1000);
  buildAPISettings();
}

async function testConnection(){
  notif('üîÑ','Testing...','APIs check kar raha hun');
  let ok=false;
  if(API_KEYS.twelve){ ok=await fetchTwelveREST(); }
  if(!ok){ ok=await fetchNSEDirect(); }
  if(!ok){ ok=await fetchYahooAll(); }
  if(ok) notif('‚úÖ','Connected!',`Live data aa raha hai ‚Äî ${liveMode?'Real':'Yahoo'} feed`);
  else notif('‚ö†Ô∏è','Limited','Yahoo/NSE se data. Broker API add karo for best results');
}
function showGlobalFull(){
  const ov=document.createElement('div');
  ov.style.cssText='position:fixed;inset:0;background:#0e1016;z-index:800;display:flex;flex-direction:column;overflow:hidden;';
  ov.innerHTML=`
    <div style="display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #1a1f2e;flex-shrink:0;">
      <button onclick="this.closest('div[style]').remove()" style="background:#1c2130;border:none;color:#fff;width:34px;height:34px;border-radius:8px;cursor:pointer;font-size:16px;margin-right:12px;">‚Üê</button>
      <div style="font-size:20px;font-weight:700;color:#fff;">üåç Global Markets</div>
      <div style="margin-left:auto;font-size:11px;color:#17c3a8;font-weight:600;" id="glLiveTag">üî¥ LIVE</div>
    </div>
    <div style="flex:1;overflow-y:auto;">
      ${['USA','Asia','Europe'].map(region=>{
        const items=GIDX.filter(g=>g.r===region||(region==='USA'&&g.f==='üá∫üá∏')||(region==='Asia'&&['üáØüáµ','üá≠üá∞','üá®üá≥','üá∞üá∑','üá∏üá¨','üá¶üá∫'].includes(g.f))||(region==='Europe'&&['üá¨üáß','üá©üá™','üá´üá∑','üá™üá∫'].includes(g.f)));
        return`<div style="padding:12px 16px 4px;font-size:11px;color:#8b949e;font-weight:600;text-transform:uppercase;letter-spacing:.5px;">${region}</div>
        ${items.map(g=>{const up=g.c>=0;return`<div style="display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #0d1017;">
          <div style="font-size:24px;margin-right:12px;">${g.f}</div>
          <div style="flex:1;"><div style="font-size:16px;font-weight:600;color:#fff;">${g.s}</div><div style="font-size:12px;color:#8b949e;">${g.r}</div></div>
          <div style="text-align:right;"><div style="font-size:18px;font-weight:700;color:#fff;">${g.p.toLocaleString('en-IN')}</div><div style="font-size:13px;font-weight:600;color:${up?'#17c3a8':'#f0627a'};">${up?'‚ñ≤':'‚ñº'} ${Math.abs(g.c).toFixed(2)}%</div></div>
        </div>`}).join('')}`;
      }).join('')}
      <!-- F&O LIVE DATA -->
      <div style="padding:12px 16px 4px;font-size:11px;color:#8b949e;font-weight:600;text-transform:uppercase;letter-spacing:.5px;">F&O LIVE DATA</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:8px 16px 16px;">
        ${[
          {l:'NIFTY PCR',v:()=>foData.niftyPCR.toFixed(2),c:'#17c3a8',id:'glPCR'},
          {l:'NIFTY ATM IV',v:()=>foData.niftyATMIV.toFixed(1)+'%',c:'#6b88ff',id:'glIV'},
          {l:'BANKNIFTY PCR',v:()=>foData.bankPCR.toFixed(2),c:'#17c3a8',id:'glBPCR'},
          {l:'BANK ATM IV',v:()=>foData.bankATMIV.toFixed(1)+'%',c:'#6b88ff',id:'glBIV'},
          {l:'NIFTY FUT PREM',v:()=>foData.niftyFutPrem.toFixed(1),c:'#f59e0b',id:'glFP'},
          {l:'BANK FUT PREM',v:()=>foData.bankFutPrem.toFixed(1),c:'#f59e0b',id:'glBFP'},
        ].map(d=>`<div style="background:#131820;border-radius:12px;padding:14px;">
          <div style="font-size:11px;color:#8b949e;margin-bottom:4px;">${d.l}</div>
          <div style="font-size:22px;font-weight:700;color:${d.c};" id="${d.id}">${d.v()}</div>
        </div>`).join('')}
      </div>
      <!-- TOP OI CALLS & PUTS -->
      <div style="padding:0 16px 16px;">
        <div style="font-size:14px;font-weight:600;color:#fff;margin-bottom:10px;">Top OI ‚Äî NIFTY Expiry</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div style="background:#131820;border-radius:12px;padding:12px;">
            <div style="font-size:12px;color:#17c3a8;font-weight:600;margin-bottom:8px;">üìà TOP CALL OI</div>
            ${foData.topOICall.map(x=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #0d1017;"><span style="font-size:13px;color:#fff;">${x.strike}</span><span style="font-size:13px;color:#8b949e;">${x.oi}L</span></div>`).join('')}
          </div>
          <div style="background:#131820;border-radius:12px;padding:12px;">
            <div style="font-size:12px;color:#f0627a;font-weight:600;margin-bottom:8px;">üìâ TOP PUT OI</div>
            ${foData.topOIPut.map(x=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #0d1017;"><span style="font-size:13px;color:#fff;">${x.strike}</span><span style="font-size:13px;color:#8b949e;">${x.oi}L</span></div>`).join('')}
          </div>
        </div>
      </div>
      <div style="height:30px;"></div>
    </div>`;
  document.body.appendChild(ov);
}

function showCommoditiesFull(){
  const ov=document.createElement('div');
  ov.style.cssText='position:fixed;inset:0;background:#0e1016;z-index:800;display:flex;flex-direction:column;overflow:hidden;';
  ov.innerHTML=`
    <div style="display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #1a1f2e;flex-shrink:0;">
      <button onclick="this.closest('div[style]').remove()" style="background:#1c2130;border:none;color:#fff;width:34px;height:34px;border-radius:8px;cursor:pointer;font-size:16px;margin-right:12px;">‚Üê</button>
      <div style="font-size:20px;font-weight:700;color:#fff;">‚ö° Commodities</div>
      <div style="margin-left:auto;font-size:11px;color:#17c3a8;font-weight:600;">üî¥ LIVE</div>
    </div>
    <div style="flex:1;overflow-y:auto;">
      ${['International','MCX India'].map(cat=>{
        const items=COMM.filter(c=>cat==='MCX India'?c.s.startsWith('MCX'):!c.s.startsWith('MCX'));
        return`<div style="padding:12px 16px 4px;font-size:11px;color:#8b949e;font-weight:600;text-transform:uppercase;letter-spacing:.5px;">${cat}</div>
        ${items.map(c=>{const up=c.c>=0;return`<div style="display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #0d1017;">
          <div style="font-size:28px;margin-right:14px;">${c.i}</div>
          <div style="flex:1;"><div style="font-size:16px;font-weight:600;color:#fff;">${c.s}</div><div style="font-size:12px;color:#8b949e;">${c.u}</div></div>
          <div style="text-align:right;"><div style="font-size:18px;font-weight:700;color:#fff;">${c.p.toLocaleString('en-IN',{maximumFractionDigits:2})}</div><div style="font-size:13px;font-weight:600;color:${up?'#17c3a8':'#f0627a'};">${up?'‚ñ≤':'‚ñº'} ${Math.abs(c.c).toFixed(2)}%</div></div>
        </div>`}).join('')}`;
      }).join('')}
      <div style="height:30px;"></div>
    </div>`;
  document.body.appendChild(ov);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SENSIBULL-STYLE: OPTIONS CHAIN + STRATEGY BUILDER + BROKER LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ BROKER OAUTH LOGIN (like Sensibull) ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SENSIBULL-STYLE: MULTI-BROKER OAUTH LOGIN + LIVE DATA ENGINE
// Supports: Zerodha ¬∑ Upstox ¬∑ Angel ¬∑ Dhan ¬∑ Fyers ¬∑ 5paisa ¬∑ Kotak ¬∑ IIFL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let connectedBrokers = JSON.parse(localStorage.getItem('be_brokers')||'{}');
let liveDataSource = localStorage.getItem('be_liveSource') || 'none';

// ‚îÄ‚îÄ BROKER CONFIGS (OAuth + API) ‚îÄ‚îÄ
const BROKERS_CONFIG = {
  zerodha: {
    name: 'Zerodha', tagline: 'India #1 broker', ico: 'üèÜ', color: '#387ed1', users: '1.3 Cr+',
    authType: 'oauth',
    oauthUrl: (apiKey, redirect) => `https://kite.zerodha.com/connect/login?api_key=${apiKey||'YOUR_API_KEY'}&v=3`,
    tokenUrl: 'https://api.kite.trade/session/token',
    wsUrl: 'wss://ws.kite.trade/?api_key={apiKey}&access_token={token}',
    apiDocs: 'https://kite.trade/docs',
    getKey: 'kite.trade ‚Üí Apps ‚Üí Create App',
    fields: [{ id:'z_apikey', label:'API Key', ph:'abc123xyz' }, { id:'z_token', label:'Access Token', ph:'eyJ...' }],
  },
  upstox: {
    name: 'Upstox', tagline: 'Free API ¬∑ 100ms WS', ico: 'üìà', color: '#5c4df3', users: '1.2 Cr+',
    authType: 'oauth',
    oauthUrl: (apiKey, redirect) => `https://api-v2.upstox.com/login/authorization/dialog?response_type=code&client_id=${apiKey||'YOUR_CLIENT_ID'}&redirect_uri=${encodeURIComponent(redirect)}`,
    tokenUrl: 'https://api-v2.upstox.com/login/authorization/token',
    wsUrl: 'wss://api-v2.upstox.com/feed/market-data-feed',
    apiDocs: 'https://upstox.com/developer-api',
    getKey: 'upstox.com/developer-api ‚Üí Create App',
    fields: [{ id:'u_apikey', label:'Client ID (API Key)', ph:'abc-xxx-yyy' }, { id:'u_token', label:'Access Token', ph:'eyJhbGci...' }],
  },
  angel: {
    name: 'Angel One', tagline: 'SmartAPI ¬∑ Free WebSocket', ico: 'üòá', color: '#ff6b35', users: '2.1 Cr+',
    authType: 'credentials',
    apiDocs: 'https://smartapi.angelone.in',
    getKey: 'angelbroking.com ‚Üí SmartAPI ‚Üí Create App',
    fields: [
      { id:'a_apikey', label:'API Key', ph:'your_api_key' },
      { id:'a_clientid', label:'Client ID', ph:'A12345678' },
      { id:'a_pwd', label:'Password', ph:'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢', type:'password' },
      { id:'a_totp', label:'TOTP Code', ph:'123456 (from authenticator)' },
    ],
  },
  dhan: {
    name: 'Dhan', tagline: 'Best for algo ¬∑ Free API', ico: 'üí°', color: '#00b4d8', users: '20L+',
    authType: 'token',
    apiDocs: 'https://dhanhq.co/docs/latest',
    getKey: 'web.dhan.co ‚Üí API ‚Üí Get Access Token',
    fields: [{ id:'d_clientid', label:'Client ID', ph:'1000000001' }, { id:'d_token', label:'Access Token', ph:'eyJhbGci...' }],
  },
  fyers: {
    name: 'Fyers', tagline: 'Free API ¬∑ Reliable WS', ico: 'ü¶Ö', color: '#2ecc71', users: '15L+',
    authType: 'oauth',
    oauthUrl: (apiKey, redirect) => `https://api.fyers.in/api/v3/generate-authcode?client_id=${apiKey||'APP_ID'}&redirect_uri=${encodeURIComponent(redirect)}&response_type=code&state=BullsEye`,
    apiDocs: 'https://myapi.fyers.in',
    getKey: 'myapi.fyers.in ‚Üí Create App ‚Üí Get App ID',
    fields: [{ id:'f_appid', label:'App ID', ph:'ABCD-100' }, { id:'f_token', label:'Access Token', ph:'eyJ...' }],
  },
  kotak: {
    name: 'Kotak Neo', tagline: 'Bank + Broker', ico: 'üè¶', color: '#d97706', users: '30L+',
    authType: 'credentials',
    apiDocs: 'https://neotradeapi.kotakneo.com',
    getKey: 'neotradeapi.kotakneo.com ‚Üí Register',
    fields: [{ id:'k_consumer', label:'Consumer Key', ph:'...' }, { id:'k_secret', label:'Consumer Secret', ph:'...' }, { id:'k_token', label:'Access Token', ph:'eyJ...' }],
  },
  iifl: {
    name: 'IIFL Securities', tagline: 'Trader Terminal API', ico: 'üî∑', color: '#1d4ed8', users: '40L+',
    authType: 'credentials',
    apiDocs: 'https://ttblaze.iifl.com/apidoc',
    getKey: 'ttblaze.iifl.com ‚Üí Developer Portal',
    fields: [{ id:'i_appkey', label:'App Key', ph:'your_app_key' }, { id:'i_secret', label:'Secret Key', ph:'...' }],
  },
  shoonya: {
    name: 'Finvasia/Shoonya', tagline: '‚Çπ0 brokerage', ico: 'üéØ', color: '#e74c3c', users: '10L+',
    authType: 'credentials',
    apiDocs: 'https://api.shoonya.com',
    getKey: 'shoonya.com ‚Üí API ‚Üí Register',
    fields: [{ id:'s_userid', label:'User ID', ph:'FA12345' }, { id:'s_apikey', label:'API Key', ph:'...' }],
  },
};

function buildBrokerLogin() {
  const el = document.getElementById('brokerC'); if (!el) return;
  const numConnected = Object.values(connectedBrokers).filter(b => b.connected).length;

  el.innerHTML = `
  <!-- ‚îÄ‚îÄ HERO ‚îÄ‚îÄ -->
  <div style="background:linear-gradient(160deg,#06000f 0%,#1a0533 40%,#0d1a2e 100%);padding:40px 20px 30px;text-align:center;flex-shrink:0;position:relative;">
    <button onclick="goTo('home')" style="position:absolute;top:14px;left:14px;background:rgba(255,255,255,.08);border:none;color:#fff;width:34px;height:34px;border-radius:9px;cursor:pointer;font-size:16px;line-height:1;">‚Üê</button>
    <div style="font-size:54px;margin-bottom:12px;filter:drop-shadow(0 0 20px #5c4df3);">üéØ</div>
    <div style="font-size:28px;font-weight:900;color:#fff;margin-bottom:4px;letter-spacing:-.5px;">Bulls Eye Connect</div>
    <div style="font-size:14px;color:rgba(255,255,255,.45);margin-bottom:20px;line-height:1.7;">Sensibull ki tarah kisi bhi broker se login karo<br>Live WebSocket data automatically connect hoga</div>

    <!-- Status pill -->
    <div style="display:inline-flex;align-items:center;gap:8px;background:${numConnected?'#17c3a81a':'rgba(255,255,255,.07)'};border:1px solid ${numConnected?'#17c3a840':'rgba(255,255,255,.1)'};border-radius:24px;padding:8px 20px;">
      <div style="width:8px;height:8px;border-radius:50%;background:${numConnected?'#17c3a8':'#555'};${numConnected?'animation:blink 1.5s infinite':''}"></div>
      <span style="font-size:13px;color:${numConnected?'#17c3a8':'#8b949e'};font-weight:600;">${numConnected?`${numConnected} Broker${numConnected>1?'s':''} Connected ¬∑ Live Data ON`:'No broker connected ¬∑ Demo mode'}</span>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ HOW IT WORKS ‚îÄ‚îÄ -->
  <div style="background:#0d1017;border-bottom:1px solid #1a1f2e;padding:14px 16px;">
    <div style="display:flex;gap:0;overflow-x:auto;">
      ${[
        ['üîê','Broker choose karo','#5c4df3'],
        ['‚Üí','','#1a1f2e'],
        ['üì≤','OAuth / Token login','#17c3a8'],
        ['‚Üí','','#1a1f2e'],
        ['‚ö°','Auto WebSocket','#f59e0b'],
        ['‚Üí','','#1a1f2e'],
        ['üî¥','Live data on!','#f0627a'],
      ].map(([ico,label,c])=>label
        ? `<div style="flex-shrink:0;text-align:center;min-width:68px;"><div style="font-size:20px;margin-bottom:4px;">${ico}</div><div style="font-size:10px;color:#8b949e;line-height:1.4;">${label}</div></div>`
        : `<div style="flex-shrink:0;color:#2a2f3e;font-size:22px;padding:2px 4px;align-self:flex-start;padding-top:6px;">${ico}</div>`
      ).join('')}
    </div>
  </div>

  <!-- ‚îÄ‚îÄ BROKER GRID ‚îÄ‚îÄ -->
  <div style="padding:14px 14px 0;">
    <div style="font-size:12px;color:#8b949e;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px;">Choose Your Broker</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      ${Object.entries(BROKERS_CONFIG).map(([id,b])=>{
        const conn = connectedBrokers[id];
        const isConn = conn?.connected;
        return `<div onclick="openBrokerLoginFlow('${id}')" style="background:#131820;border:2px solid ${isConn?b.color:'#1a1f2e'};border-radius:16px;padding:16px 14px;text-align:center;cursor:pointer;position:relative;transition:border-color .2s;active:transform:scale(.95);">
          ${isConn?`<div style="position:absolute;top:10px;right:10px;width:8px;height:8px;border-radius:50%;background:#17c3a8;animation:blink 2s infinite;"></div>`:''}
          <div style="font-size:32px;margin-bottom:8px;">${b.ico}</div>
          <div style="font-size:15px;font-weight:700;color:#fff;margin-bottom:3px;">${b.name}</div>
          <div style="font-size:11px;color:${isConn?'#17c3a8':'#555'};margin-bottom:12px;">${isConn?'‚úì Connected ¬∑ Live':'Tap to connect'}</div>
          <div style="padding:8px;border-radius:9px;font-size:12px;font-weight:700;color:${isConn?'#000':'#fff'};background:${isConn?'#17c3a8':b.color};">${isConn?'‚úì LIVE':'Connect ‚Üí'}</div>
        </div>`;
      }).join('')}
    </div>
  </div>

  <!-- ‚îÄ‚îÄ LIVE SPEED TABLE ‚îÄ‚îÄ -->
  <div style="margin:14px;background:#131820;border:1px solid #1a1f2e;border-radius:14px;padding:16px;">
    <div style="font-size:13px;font-weight:700;color:#fff;margin-bottom:12px;">‚ö° Live Feed Comparison</div>
    ${[
      ['Upstox WebSocket','~100ms','#5c4df3','Best speed'],
      ['Zerodha Kite WS','~150ms','#387ed1','Most reliable'],
      ['Angel SmartAPI WS','~250ms','#ff6b35','Free forever'],
      ['Dhan WS','~200ms','#00b4d8','Best for algo'],
      ['Fyers WS','~200ms','#2ecc71','Stable'],
      ['Yahoo (Fallback)','~5s REST','#555','No login needed'],
    ].map(([b,s,c,note])=>`<div style="display:flex;align-items:center;padding:8px 0;border-bottom:1px solid #0d1017;">
      <div style="width:8px;height:8px;border-radius:50%;background:${c};margin-right:10px;flex-shrink:0;"></div>
      <div style="flex:1;"><div style="font-size:13px;color:#fff;">${b}</div><div style="font-size:11px;color:#555;">${note}</div></div>
      <div style="font-size:12px;font-weight:700;color:${s.includes('100')?'#17c3a8':s.includes('5s')?'#555':'#f59e0b'};">${s}</div>
    </div>`).join('')}
  </div>
  <div style="height:30px;"></div>`;
}

function openBrokerLoginFlow(brokerId) {
  const b = BROKERS_CONFIG[brokerId]; if (!b) return;
  const conn = connectedBrokers[brokerId];
  const redirect = window.location.href.split('?')[0];

  const ov = document.createElement('div');
  ov.id = 'bkOv';
  ov.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:960;display:flex;align-items:flex-end;overflow-y:auto;';

  ov.innerHTML = `
  <div style="width:100%;background:#131820;border-radius:22px 22px 0 0;padding:22px 20px 50px;max-height:92vh;overflow-y:auto;">
    <div style="width:36px;height:3px;background:#2a2f3e;border-radius:2px;margin:0 auto 18px;"></div>

    <!-- Broker header -->
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px;">
      <div style="width:56px;height:56px;border-radius:16px;background:${b.color}22;display:flex;align-items:center;justify-content:center;font-size:30px;">${b.ico}</div>
      <div style="flex:1;">
        <div style="font-size:20px;font-weight:800;color:#fff;">${b.name}</div>
        <div style="font-size:13px;color:#8b949e;margin-top:2px;">${b.tagline} ¬∑ ${b.users} users</div>
      </div>
      ${conn?.connected?`<button onclick="disconnectBrokerConfirm('${brokerId}')" style="background:#f0627a1a;border:1px solid #f0627a40;border-radius:8px;color:#f0627a;padding:7px 12px;cursor:pointer;font-size:12px;font-weight:600;">Disconnect</button>`:''}
    </div>

    <!-- Status if connected -->
    ${conn?.connected?`<div style="background:#17c3a81a;border:1px solid #17c3a840;border-radius:12px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;"><div style="width:8px;height:8px;border-radius:50%;background:#17c3a8;animation:blink 1.5s infinite;"></div><div><div style="font-size:14px;font-weight:600;color:#17c3a8;">Live Data Connected</div><div style="font-size:12px;color:#8b949e;margin-top:2px;">Connected on ${new Date(conn.connectedAt).toLocaleDateString('en-IN')} ¬∑ WebSocket active</div></div></div>`:''}

    ${b.authType === 'oauth' ? `
    <!-- OAuth Option -->
    <div style="background:#0e1016;border-radius:14px;padding:16px;margin-bottom:14px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;"><span style="font-size:16px;">üîê</span><div style="font-size:14px;font-weight:700;color:#fff;">OAuth Login (Recommended)</div></div>
      <div style="font-size:12px;color:#8b949e;margin-bottom:14px;">Secure redirect login ‚Äî ${b.name} site pe jaoge, wapas auto-redirect hoga</div>
      <button onclick="startOAuthFlow('${brokerId}')" style="width:100%;padding:14px;background:${b.color};border:none;border-radius:11px;color:#fff;font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
        <span>üîê</span> Login with ${b.name}
      </button>
    </div>
    <div style="text-align:center;color:#2a2f3e;font-size:13px;margin-bottom:14px;letter-spacing:1px;">‚Äî OR ‚Äî</div>` : ''}

    <!-- Manual Token Entry -->
    <div style="background:#0e1016;border-radius:14px;padding:16px;margin-bottom:14px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;"><span style="font-size:16px;">üîë</span><div style="font-size:14px;font-weight:700;color:#fff;">Manual Token Entry</div></div>
      <div style="font-size:12px;color:#8b949e;margin-bottom:4px;">${b.getKey}</div>
      <div onclick="window.open('${b.apiDocs}','_blank')" style="font-size:12px;color:#5c4df3;margin-bottom:14px;cursor:pointer;text-decoration:underline;">üìñ View API Docs ‚Üí</div>
      ${b.fields.map(f=>`
      <div style="margin-bottom:12px;">
        <div style="font-size:11px;color:#8b949e;font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px;">${f.label}</div>
        <div style="display:flex;gap:8px;">
          <input id="${f.id}" type="${f.type||'text'}" placeholder="${f.ph}" style="flex:1;background:#131820;border:1px solid #2a2f3e;border-radius:10px;padding:12px 14px;color:#fff;font-size:14px;outline:none;font-family:Inter,sans-serif;" autocomplete="off">
          <button onclick="toggleVisibility('${f.id}')" style="width:42px;background:#1c2130;border:1px solid #2a2f3e;border-radius:10px;color:#8b949e;cursor:pointer;font-size:16px;">üëÅ</button>
        </div>
      </div>`).join('')}
      <button onclick="saveBrokerCredentials('${brokerId}')" style="width:100%;padding:14px;background:#17c3a8;border:none;border-radius:11px;color:#000;font-size:15px;font-weight:700;cursor:pointer;margin-top:4px;">
        üî¥ Connect ‚Üí Get Live Data
      </button>
    </div>

    <!-- Test Connection -->
    ${conn?.connected?`<button onclick="testBrokerConnection('${brokerId}')" style="width:100%;padding:12px;background:#1c2130;border:1px solid #2a2f3e;border-radius:11px;color:#fff;font-size:14px;cursor:pointer;margin-bottom:10px;">üîÑ Test Connection</button>`:''}
    <button onclick="document.getElementById('bkOv').remove()" style="width:100%;padding:12px;background:transparent;border:1px solid #2a2f3e;border-radius:11px;color:#8b949e;font-size:14px;cursor:pointer;">Cancel</button>
  </div>`;

  ov.onclick = e => { if (e.target === ov) ov.remove(); };
  document.body.appendChild(ov);

  // Pre-fill if already connected
  if (conn) {
    b.fields.forEach(f => {
      const el = document.getElementById(f.id);
      if (el && conn[f.id]) el.value = conn[f.id];
    });
  }
}

function toggleVisibility(inputId) {
  const el = document.getElementById(inputId); if (!el) return;
  el.type = el.type === 'password' ? 'text' : 'password';
}

function startOAuthFlow(brokerId) {
  const b = BROKERS_CONFIG[brokerId]; if (!b?.oauthUrl) return;
  // Save which broker is pending OAuth
  localStorage.setItem('be_oauthPending', brokerId);
  // Get API key from input if filled
  const apiKeyField = b.fields[0];
  const apiKey = document.getElementById(apiKeyField?.id)?.value?.trim() || '';
  const redirect = window.location.href.split('?')[0];
  const url = b.oauthUrl(apiKey, redirect);

  notif('üîê','Opening '+b.name,'Login ke baad token copy karo aur paste karo yahan');
  // Open in same window so redirect works
  window.location.href = url;
}

function saveBrokerCredentials(brokerId) {
  const b = BROKERS_CONFIG[brokerId];
  const stored = { connected: false, connectedAt: new Date().toISOString() };
  let allFilled = true;
  b.fields.forEach(f => {
    const val = document.getElementById(f.id)?.value?.trim() || '';
    if (!val && !f.optional) allFilled = false;
    stored[f.id] = val;
  });

  if (!allFilled) { notif('‚ùå','Error','Saare required fields bharo'); return; }
  stored.connected = true;

  connectedBrokers[brokerId] = stored;
  localStorage.setItem('be_brokers', JSON.stringify(connectedBrokers));
  liveDataSource = brokerId;
  localStorage.setItem('be_liveSource', brokerId);

  // Map to API_KEYS for live engine
  applyBrokerToEngine(brokerId, stored);

  document.getElementById('bkOv')?.remove();
  speak(`${b.name} connect ho gaya. Live data WebSocket se aa raha hai`);
  playAlarm('buy');
  notif('üî¥', b.name+' Connected!', 'Live WebSocket data starting ‚Äî '+b.name);

  // Restart live engine
  if (activeWS) { try { activeWS.close(); } catch(e){} }
  wsConnected = false; fetchErrors = 0;
  setTimeout(startLiveFeed, 800);
  buildBrokerLogin();
}

function applyBrokerToEngine(brokerId, stored) {
  switch(brokerId) {
    case 'upstox':  API_KEYS.upstoxToken = stored.u_token || ''; break;
    case 'zerodha': API_KEYS.zerodhaToken = stored.z_token || ''; API_KEYS.zerodhaKey = stored.z_apikey || ''; break;
    case 'angel':   API_KEYS.angelApiKey = stored.a_apikey || ''; API_KEYS.angelJwt = stored.a_token || ''; break;
    case 'dhan':    API_KEYS.dhanToken = stored.d_token || ''; API_KEYS.dhanClient = stored.d_clientid || ''; break;
    case 'fyers':   API_KEYS.fyersToken = stored.f_token || ''; break;
  }
  localStorage.setItem('be_apikeys', JSON.stringify(API_KEYS));
}

function disconnectBrokerConfirm(brokerId) {
  const b = BROKERS_CONFIG[brokerId];
  const ov = document.createElement('div');
  ov.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:970;display:flex;align-items:center;justify-content:center;padding:20px;';
  ov.innerHTML = `<div style="background:#131820;border-radius:20px;padding:24px;width:100%;max-width:320px;text-align:center;">
    <div style="font-size:40px;margin-bottom:12px;">${b.ico}</div>
    <div style="font-size:18px;font-weight:700;color:#fff;margin-bottom:8px;">Disconnect ${b.name}?</div>
    <div style="font-size:13px;color:#8b949e;margin-bottom:20px;">Token delete ho jayega. Dobara connect karna hoga.</div>
    <div style="display:flex;gap:10px;">
      <button onclick="this.closest('[style]').remove()" style="flex:1;padding:12px;background:#1c2130;border:none;border-radius:10px;color:#fff;cursor:pointer;">Cancel</button>
      <button onclick="doDisconnectBroker('${brokerId}');this.closest('[style]').remove();document.getElementById('bkOv')?.remove();" style="flex:1;padding:12px;background:#f0627a;border:none;border-radius:10px;color:#fff;font-weight:700;cursor:pointer;">Disconnect</button>
    </div>
  </div>`;
  ov.onclick = e => { if(e.target===ov) ov.remove(); };
  document.body.appendChild(ov);
}

function doDisconnectBroker(brokerId) {
  delete connectedBrokers[brokerId];
  localStorage.setItem('be_brokers', JSON.stringify(connectedBrokers));
  notif('‚ÑπÔ∏è','Disconnected', BROKERS_CONFIG[brokerId].name + ' remove ho gaya');
  buildBrokerLogin();
}

async function testBrokerConnection(brokerId) {
  notif('üîÑ','Testing...','Connection check ho raha hai');
  let ok = false;
  if (brokerId === 'upstox' && API_KEYS.upstoxToken)  ok = !!await fetchYahooAll().catch(()=>false);
  if (!ok) ok = await fetchNSEDirect().catch(()=>false);
  if (!ok) ok = await fetchYahooAll().catch(()=>false);
  notif(ok?'‚úÖ':'‚ö†Ô∏è', ok?'Connection OK!':'Partial', ok?'Live data flow ho raha hai':'Yahoo fallback pe chal raha hai');
}

// Handle OAuth return
function checkOAuthCallback() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get('request_token') || params.get('code') || params.get('access_token');
  const pending = localStorage.getItem('be_oauthPending');
  if (code && pending) {
    localStorage.removeItem('be_oauthPending');
    const b = BROKERS_CONFIG[pending];
    if (!b) return;
    // Store token
    const stored = { connected: true, connectedAt: new Date().toISOString() };
    stored[b.fields.find(f=>f.label.toLowerCase().includes('token'))?.id || b.fields[b.fields.length-1].id] = code;
    connectedBrokers[pending] = stored;
    localStorage.setItem('be_brokers', JSON.stringify(connectedBrokers));
    applyBrokerToEngine(pending, stored);
    liveDataSource = pending; localStorage.setItem('be_liveSource', pending);
    // Clean URL
    history.replaceState({}, '', window.location.pathname);
    setTimeout(() => {
      notif('üî¥', b.name+' Login Successful!', 'Live WebSocket connect ho raha hai');
      speak(b.name + ' mein login ho gaya. Live data aa raha hai');
      setTimeout(startLiveFeed, 800);
    }, 1000);
  }
}


// ‚îÄ‚îÄ OPTIONS CHAIN (Sensibull-style) ‚îÄ‚îÄ
let ocSym='NIFTY 50';
let foLiveTimer=null;

function generateOptionChain(sym,atm){
  const step=sym.includes('BANK')?100:50;
  const atmR=Math.round(atm/step)*step;
  const strikes=[];
  for(let i=-10;i<=10;i++) strikes.push(atmR+i*step);
  return strikes.map(s=>{
    const dist=Math.abs(s-atmR)/step, isATM=s===atmR;
    const bOI=isATM?45:Math.max(1,35-dist*3);
    const iv=14.5+dist*.8+(Math.random()*.5);
    const delta=Math.max(.01,Math.min(.99,.5+(atmR-s)/step*.08));
    const ceLTP=s>atmR?Math.max(.5,(s-atmR)*(1-dist*.1)+Math.random()*15+5):Math.max(.5,Math.random()*80+30);
    const peLTP=s<atmR?Math.max(.5,(atmR-s)*(1-dist*.1)+Math.random()*15+5):Math.max(.5,Math.random()*80+30);
    return{strike:s,isATM,
      ce:{oi:+(bOI*(.8+Math.random()*.4)).toFixed(1),oiChg:+((Math.random()-.4)*8).toFixed(1),vol:+(bOI*12).toFixed(0),iv:+iv.toFixed(1),ltp:+ceLTP.toFixed(2),delta:+delta.toFixed(2)},
      pe:{oi:+(bOI*(.8+Math.random()*.4)).toFixed(1),oiChg:+((Math.random()-.4)*8).toFixed(1),vol:+(bOI*11).toFixed(0),iv:+iv.toFixed(1),ltp:+peLTP.toFixed(2),delta:+(1-delta).toFixed(2)},
    };
  });
}

function buildOptionChain(){
  const el=document.getElementById('optchainC'); if(!el) return;
  const idx=IDXS.find(x=>x.s===ocSym)||IDXS[0];
  const chain=generateOptionChain(ocSym,idx.p);
  const atmS=chain.find(r=>r.isATM)?.strike||Math.round(idx.p/50)*50;
  const totCE=chain.reduce((s,r)=>s+r.ce.oi,0), totPE=chain.reduce((s,r)=>s+r.pe.oi,0);
  const pcr=(totPE/totCE).toFixed(2), pcrPct=Math.min(100,(totPE/(totCE+totPE)*100)).toFixed(0);
  const pcrBull=+pcr>1;
  document.getElementById('ocTitle').textContent=`${ocSym} Options`;
  document.getElementById('ocPCRBar').innerHTML=`
    <div class="pcr-bar">
      <div style="margin-right:10px;"><div style="font-size:10px;color:#8b949e;font-weight:600;">PCR</div><div style="font-size:22px;font-weight:800;color:${pcrBull?'#17c3a8':'#f0627a'};">${pcr}</div></div>
      <div style="flex:1;">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px;font-size:10px;color:#555;"><span>CE: ${totCE.toFixed(0)}L</span><span>PE: ${totPE.toFixed(0)}L</span></div>
        <div style="height:8px;background:#1c2130;border-radius:4px;overflow:hidden;display:flex;"><div style="background:#17c3a8;width:${100-pcrPct}%;"></div><div style="background:#f0627a;flex:1;"></div></div>
        <div style="font-size:11px;margin-top:4px;color:${pcrBull?'#17c3a8':'#f0627a'};font-weight:600;">${pcrBull?'üü¢ Bullish ‚Äî Put writers active':'üî¥ Bearish ‚Äî Call writers dominant'}</div>
      </div>
      <div style="margin-left:10px;text-align:center;"><div style="font-size:10px;color:#8b949e;">ATM IV</div><div style="font-size:18px;font-weight:800;color:#6b88ff;">${foData.niftyATMIV.toFixed(1)}%</div></div>
    </div>
    <div style="display:flex;gap:6px;padding:8px 16px;border-bottom:1px solid #1a1f2e;overflow-x:auto;">
      ${IDXS.map(x=>`<button onclick="ocSym='${x.s}';buildOptionChain()" style="padding:5px 12px;border-radius:16px;border:none;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap;background:${ocSym===x.s?'#fff':'#1c2130'};color:${ocSym===x.s?'#000':'#8b949e'};">${x.s}</button>`).join('')}
    </div>`;
  const maxCE=Math.max(...chain.map(r=>r.ce.oi)), maxPE=Math.max(...chain.map(r=>r.pe.oi));
  el.innerHTML=`
    <div style="padding:8px 16px 4px;display:flex;justify-content:space-between;align-items:center;">
      <div style="font-size:13px;font-weight:600;color:#fff;">LTP: ‚Çπ${idx.p.toLocaleString('en-IN',{maximumFractionDigits:0})} ¬∑ ATM: ${atmS}</div>
      <button onclick="goTo('strategy')" style="padding:6px 12px;background:#5c4df3;border:none;border-radius:8px;color:#fff;font-size:11px;font-weight:700;cursor:pointer;">üß† Strategy</button>
    </div>
    <div style="overflow-x:auto;">
    <table style="width:100%;border-collapse:collapse;min-width:560px;">
      <thead>
        <tr><th colspan="4" style="font-size:10px;color:#17c3a8;background:#17c3a808;padding:6px;border-bottom:1px solid #1a1f2e;text-align:center;">‚îÄ‚îÄ CALLS ‚îÄ‚îÄ</th><th style="background:#1c2130;color:#fff;font-size:10px;font-weight:700;padding:6px;border-bottom:1px solid #1a1f2e;">STRIKE</th><th colspan="4" style="font-size:10px;color:#f0627a;background:#f0627a08;padding:6px;border-bottom:1px solid #1a1f2e;text-align:center;">‚îÄ‚îÄ PUTS ‚îÄ‚îÄ</th></tr>
        <tr style="background:#0e1016;">${['OI(L)','IV','LTP','Œî','‚Çπ','OI(L)','IV','LTP','Œî'].map(h=>`<th style="font-size:10px;color:#555;padding:5px 6px;border-bottom:1px solid #0d1017;font-weight:700;">${h}</th>`).join('')}</tr>
      </thead>
      <tbody>
        ${chain.map(r=>{const cbw=Math.round(r.ce.oi/maxCE*100),pbw=Math.round(r.pe.oi/maxPE*100);return`<tr style="${r.isATM?'background:#17c3a808;':''}" onclick="showStrikeDetail(${r.strike},'${ocSym}')">
          <td style="font-size:12px;font-weight:600;color:#17c3a8;padding:7px 5px;text-align:center;border-bottom:1px solid #0d1017;">${r.ce.oi}<br><div style="height:2px;background:#17c3a8;width:${cbw}%;margin:2px 0 0 auto;border-radius:1px;"></div></td>
          <td style="font-size:11px;color:#17c3a8;padding:5px;text-align:center;border-bottom:1px solid #0d1017;">${r.ce.iv}</td>
          <td style="font-size:12px;font-weight:700;color:#17c3a8;padding:5px;text-align:center;border-bottom:1px solid #0d1017;">${r.ce.ltp}</td>
          <td style="font-size:10px;color:#555;padding:5px;text-align:center;border-bottom:1px solid #0d1017;">${r.ce.delta}</td>
          <td style="font-size:13px;font-weight:800;color:#fff;padding:5px;text-align:center;background:#1c2130;border-bottom:1px solid #0d1017;">${r.isATM?'‚≠ê':''}<b>${r.strike}</b></td>
          <td style="font-size:12px;font-weight:600;color:#f0627a;padding:7px 5px;text-align:center;border-bottom:1px solid #0d1017;">${r.pe.oi}<br><div style="height:2px;background:#f0627a;width:${pbw}%;border-radius:1px;margin-top:2px;"></div></td>
          <td style="font-size:11px;color:#f0627a;padding:5px;text-align:center;border-bottom:1px solid #0d1017;">${r.pe.iv}</td>
          <td style="font-size:12px;font-weight:700;color:#f0627a;padding:5px;text-align:center;border-bottom:1px solid #0d1017;">${r.pe.ltp}</td>
          <td style="font-size:10px;color:#555;padding:5px;text-align:center;border-bottom:1px solid #0d1017;">${r.pe.delta}</td>
        </tr>`}).join('')}
      </tbody>
    </table></div>
    <div style="margin:12px 16px;background:#131820;border-radius:12px;padding:14px;">
      <div style="font-size:13px;font-weight:700;color:#fff;margin-bottom:8px;">ü§ñ AI OI Analysis</div>
      <div style="font-size:13px;color:#8b949e;line-height:1.9;">
        üìå <b style="color:#fff;">Max Call OI:</b> ${chain.reduce((m,r)=>r.ce.oi>m.oi?{s:r.strike,oi:r.ce.oi}:m,{s:0,oi:0}).s} ‚Äî Resistance zone<br>
        üìå <b style="color:#fff;">Max Put OI:</b> ${chain.reduce((m,r)=>r.pe.oi>m.oi?{s:r.strike,oi:r.pe.oi}:m,{s:0,oi:0}).s} ‚Äî Support zone<br>
        üí° <b style="color:#17c3a8;">AI Suggestion:</b> ${pcrBull?`Bull Call Spread ‚Äî Buy ${atmS} CE, Sell ${atmS+100} CE`:`Bear Put Spread ‚Äî Buy ${atmS} PE, Sell ${atmS-100} PE`}
      </div>
    </div>
    <div style="height:30px;"></div>`;
  clearInterval(foLiveTimer);
  if(isMarketOpen()) foLiveTimer=setInterval(()=>{if(document.getElementById('optchainScreen')?.classList.contains('on'))buildOptionChain();},6000);
}

function showStrikeDetail(strike,sym){
  const ov=document.createElement('div');ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:900;display:flex;align-items:flex-end;';
  const g=['Delta','Gamma','Theta','Vega'];
  const ce=[+(Math.random()*.5+.1).toFixed(3),+(Math.random()*.01).toFixed(4),+(-Math.random()*5-2).toFixed(2),+(Math.random()*10+3).toFixed(2)];
  const pe=[+(-Math.random()*.5-.1).toFixed(3),+(Math.random()*.01).toFixed(4),+(-Math.random()*5-2).toFixed(2),+(Math.random()*10+3).toFixed(2)];
  ov.innerHTML=`<div style="width:100%;background:#131820;border-radius:20px 20px 0 0;padding:20px 20px 48px;">
    <div style="width:32px;height:3px;background:#2a2f3e;border-radius:2px;margin:0 auto 16px;"></div>
    <div style="font-size:18px;font-weight:700;color:#fff;margin-bottom:14px;">${sym} ${strike} ‚Äî Greeks</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
      <div style="background:#0e1016;border-radius:10px;padding:12px;"><div style="font-size:12px;color:#17c3a8;font-weight:700;margin-bottom:8px;">üìà CALL ${strike}</div>${g.map((x,i)=>`<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #0d1017;"><span style="font-size:12px;color:#8b949e;">${x}</span><span style="font-size:12px;font-weight:700;color:#fff;">${ce[i]}</span></div>`).join('')}</div>
      <div style="background:#0e1016;border-radius:10px;padding:12px;"><div style="font-size:12px;color:#f0627a;font-weight:700;margin-bottom:8px;">üìâ PUT ${strike}</div>${g.map((x,i)=>`<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #0d1017;"><span style="font-size:12px;color:#8b949e;">${x}</span><span style="font-size:12px;font-weight:700;color:#fff;">${pe[i]}</span></div>`).join('')}</div>
    </div>
    <div style="display:flex;gap:10px;">
      <button onclick="notif('üìà','BUY CE','${sym} ${strike} CE order placed');this.closest('[style]').remove()" style="flex:1;padding:13px;background:#17c3a8;border:none;border-radius:12px;color:#000;font-size:14px;font-weight:700;cursor:pointer;">BUY CE</button>
      <button onclick="notif('üìâ','BUY PE','${sym} ${strike} PE order placed');this.closest('[style]').remove()" style="flex:1;padding:13px;background:#f0627a;border:none;border-radius:12px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;">BUY PE</button>
      <button onclick="this.closest('[style]').remove()" style="padding:13px 16px;background:#1c2130;border:none;border-radius:12px;color:#fff;cursor:pointer;">‚úï</button>
    </div>
  </div>`;
  ov.onclick=e=>{if(e.target===ov)ov.remove();};document.body.appendChild(ov);
}

// ‚îÄ‚îÄ STRATEGY BUILDER ‚îÄ‚îÄ
const STRATEGIES=[
  {name:'Bull Call Spread',emoji:'üìà',desc:'Buy lower CE, sell higher CE ‚Äî limited risk bullish',view:'Mildly Bullish',legs:['BUY ATM CE','SELL OTM+1 CE'],legTypes:['buy','sell'],margin:'‚Çπ8,200',maxProfit:'+‚Çπ12,000',maxLoss:'-‚Çπ5,500',color:'#17c3a8',aiScore:82,aiNote:'PCR 1.24 + bullish trend ‚Äî Bull Call Spread best fit abhi.'},
  {name:'Bear Put Spread',emoji:'üìâ',desc:'Buy ATM PE, sell OTM PE ‚Äî limited risk bearish',view:'Mildly Bearish',legs:['BUY ATM PE','SELL OTM-1 PE'],legTypes:['buy','sell'],margin:'‚Çπ7,800',maxProfit:'+‚Çπ11,500',maxLoss:'-‚Çπ5,200',color:'#f0627a',aiScore:54,aiNote:'Market abhi bullish hai ‚Äî Bear Put avoid karo. Wait for reversal signal.'},
  {name:'Iron Condor',emoji:'ü¶Ö',desc:'Sell both sides ‚Äî earn from sideways market + time decay',view:'Neutral / Sideways',legs:['SELL OTM CE','BUY far CE','SELL OTM PE','BUY far PE'],legTypes:['sell','buy','sell','buy'],margin:'‚Çπ42,000',maxProfit:'+‚Çπ8,400',maxLoss:'-‚Çπ16,600',color:'#f59e0b',aiScore:71,aiNote:'IV 14.2% ‚Äî decent premium. Use if market expected sideways 3-5 days.'},
  {name:'Long Straddle',emoji:'üéØ',desc:'Buy ATM CE + PE ‚Äî big move in any direction',view:'High Volatility Expected',legs:['BUY ATM CE','BUY ATM PE'],legTypes:['buy','buy'],margin:'‚Çπ18,000',maxProfit:'Unlimited',maxLoss:'-‚Çπ18,000',color:'#a78bfa',aiScore:58,aiNote:'IV abhi low ‚Äî straddle ke liye IV crush risk. Event-based trading ke liye use karo.'},
  {name:'Bull Put Spread',emoji:'üêÇ',desc:'Sell OTM PE, buy further OTM PE ‚Äî collect premium',view:'Bullish',legs:['SELL OTM PE','BUY far OTM PE'],legTypes:['sell','buy'],margin:'‚Çπ14,500',maxProfit:'+‚Çπ6,800',maxLoss:'-‚Çπ8,200',color:'#17c3a8',aiScore:79,aiNote:'Strong support levels + PCR bullish ‚Äî Bull Put Spread ideal hai abhi.'},
  {name:'Covered Call',emoji:'üõ°Ô∏è',desc:'Hold stock + sell OTM CE ‚Äî monthly passive income',view:'Neutral to Slightly Bullish',legs:['HOLD STOCK','SELL OTM CE'],legTypes:['neutral','sell'],margin:'‚Çπ0 extra',maxProfit:'+‚Çπ5,200/lot',maxLoss:'Stock risk',color:'#34d399',aiScore:78,aiNote:'Long-term holdings ke liye best ‚Äî passive income strategy.'},
  {name:'Calendar Spread',emoji:'üìÖ',desc:'Sell near expiry CE, buy far expiry CE ‚Äî IV difference',view:'Neutral',legs:['SELL Near-Month CE','BUY Far-Month CE'],legTypes:['sell','buy'],margin:'‚Çπ12,000',maxProfit:'+‚Çπ4,200',maxLoss:'-‚Çπ3,800',color:'#6b88ff',aiScore:65,aiNote:'Expiry week mein best kaam karta hai yeh strategy.'},
  {name:'Long Strangle',emoji:'‚ö°',desc:'Buy OTM CE + OTM PE ‚Äî cheaper than straddle',view:'Very High Volatility',legs:['BUY OTM CE','BUY OTM PE'],legTypes:['buy','buy'],margin:'‚Çπ9,400',maxProfit:'Unlimited',maxLoss:'-‚Çπ9,400',color:'#fb923c',aiScore:55,aiNote:'Budget results ya RBI policy ke pehle use karo ‚Äî big move expected.'},
];

function buildStrategyBuilder(){
  const el=document.getElementById('strategyC'); if(!el) return;
  const idx=IDXS[curIdx||0], atmS=Math.round(idx.p/50)*50;
  el.innerHTML=`
  <div style="padding:10px 16px;background:#131820;border-bottom:1px solid #1a1f2e;display:flex;gap:6px;overflow-x:auto;flex-shrink:0;">
    ${IDXS.map((x,i)=>`<button onclick="curIdx=${i};buildStrategyBuilder()" style="padding:5px 12px;border-radius:16px;border:none;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap;background:${curIdx===i?'#fff':'#1c2130'};color:${curIdx===i?'#000':'#8b949e'};">${x.s}</button>`).join('')}
  </div>
  <div style="padding:12px 16px;background:#17c3a808;border-bottom:1px solid #17c3a820;">
    <div style="font-size:11px;font-weight:700;color:#17c3a8;margin-bottom:8px;">ü§ñ AI MARKET CONTEXT</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      ${[{l:'Index',v:idx.s,c:'#fff'},{l:'LTP',v:'‚Çπ'+idx.p.toLocaleString('en-IN',{maximumFractionDigits:0}),c:'#fff'},{l:'ATM',v:atmS,c:'#f59e0b'},{l:'PCR',v:foData.niftyPCR.toFixed(2),c:foData.niftyPCR>1?'#17c3a8':'#f0627a'},{l:'IV',v:foData.niftyATMIV.toFixed(1)+'%',c:'#6b88ff'},{l:'Trend',v:idx.c>=0?'‚Üë Bull':'‚Üì Bear',c:idx.c>=0?'#17c3a8':'#f0627a'}].map(x=>`<div style="background:#1c2130;border-radius:8px;padding:6px 10px;"><div style="font-size:10px;color:#8b949e;">${x.l}</div><div style="font-size:13px;font-weight:700;color:${x.c};">${x.v}</div></div>`).join('')}
    </div>
  </div>
  <div style="padding:8px 0;">
    ${STRATEGIES.map(s=>`<div class="strat-card fade-up" onclick="showStrategyDetail('${s.name}')">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;">
        <div style="display:flex;align-items:center;gap:10px;"><div style="font-size:28px;">${s.emoji}</div><div><div style="font-size:16px;font-weight:700;color:#fff;">${s.name}</div><div style="font-size:12px;color:#8b949e;">${s.view}</div></div></div>
        <div style="text-align:center;flex-shrink:0;"><div style="font-size:22px;font-weight:800;color:${s.aiScore>=75?'#17c3a8':s.aiScore>=60?'#f59e0b':'#f0627a'};">${s.aiScore}</div><div style="font-size:10px;color:#555;">AI FIT</div></div>
      </div>
      <div style="font-size:13px;color:#8b949e;margin-bottom:10px;">${s.desc}</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;">${s.legs.map((l,i)=>`<span class="strat-leg ${s.legTypes[i]}">${l}</span>`).join('')}</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px;">
        <div style="background:#0e1016;border-radius:8px;padding:7px;text-align:center;"><div style="font-size:12px;font-weight:700;color:#17c3a8;">${s.maxProfit}</div><div style="font-size:10px;color:#555;">Max Profit</div></div>
        <div style="background:#0e1016;border-radius:8px;padding:7px;text-align:center;"><div style="font-size:12px;font-weight:700;color:#f0627a;">${s.maxLoss}</div><div style="font-size:10px;color:#555;">Max Loss</div></div>
        <div style="background:#0e1016;border-radius:8px;padding:7px;text-align:center;"><div style="font-size:12px;font-weight:700;color:#f59e0b;">${s.margin}</div><div style="font-size:10px;color:#555;">Margin</div></div>
        <div style="background:#0e1016;border-radius:8px;padding:7px;text-align:center;"><div style="font-size:12px;font-weight:700;color:#a78bfa;">${s.risk||'Limited'}</div><div style="font-size:10px;color:#555;">Risk</div></div>
      </div>
      <div style="background:#17c3a808;border-left:3px solid #17c3a8;padding:8px 10px;border-radius:0 8px 8px 0;font-size:12px;color:#8b949e;">ü§ñ ${s.aiNote}</div>
    </div>`).join('')}
  </div>
  <div style="height:30px;"></div>`;
}

function showStrategyDetail(name){
  const s=STRATEGIES.find(x=>x.name===name);if(!s)return;
  const idx=IDXS[curIdx||0],atmS=Math.round(idx.p/50)*50;
  const ov=document.createElement('div');ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:900;display:flex;align-items:flex-end;overflow-y:auto;';
  ov.innerHTML=`<div style="width:100%;background:#131820;border-radius:20px 20px 0 0;padding:20px 20px 48px;">
    <div style="width:32px;height:3px;background:#2a2f3e;border-radius:2px;margin:0 auto 16px;"></div>
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
      <div style="font-size:36px;">${s.emoji}</div>
      <div style="flex:1;"><div style="font-size:20px;font-weight:700;color:#fff;">${s.name}</div><div style="font-size:13px;color:#8b949e;">${s.view}</div></div>
      <div style="text-align:center;"><div style="font-size:28px;font-weight:800;color:${s.aiScore>=75?'#17c3a8':s.aiScore>=60?'#f59e0b':'#f0627a'};">${s.aiScore}</div><div style="font-size:11px;color:#555;">AI FIT</div></div>
    </div>
    <div style="background:#0e1016;border-radius:12px;padding:14px;margin-bottom:14px;">
      <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:10px;">Strategy Legs ‚Äî ${idx.s} @ ${atmS}</div>
      ${s.legs.map((l,i)=>{const strike=atmS+(i===1?100:i===2?-50:i===3?-150:0);return`<div style="display:flex;align-items:center;padding:9px 0;border-bottom:1px solid #0d1017;"><span class="strat-leg ${s.legTypes[i]}" style="margin-right:10px;min-width:50px;text-align:center;">${s.legTypes[i].toUpperCase()}</span><div style="flex:1;font-size:14px;color:#fff;">${l}</div><div style="text-align:right;"><div style="font-size:14px;font-weight:700;color:#fff;">${strike}</div><div style="font-size:11px;color:#555;">Strike</div></div></div>`;}).join('')}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
      <div style="background:#17c3a81a;border:1px solid #17c3a840;border-radius:12px;padding:14px;text-align:center;"><div style="font-size:22px;font-weight:800;color:#17c3a8;">${s.maxProfit}</div><div style="font-size:12px;color:#8b949e;margin-top:4px;">Max Profit</div></div>
      <div style="background:#f0627a1a;border:1px solid #f0627a40;border-radius:12px;padding:14px;text-align:center;"><div style="font-size:22px;font-weight:800;color:#f0627a;">${s.maxLoss}</div><div style="font-size:12px;color:#8b949e;margin-top:4px;">Max Loss</div></div>
    </div>
    <div style="background:#17c3a808;border:1px solid #17c3a820;border-radius:12px;padding:14px;margin-bottom:16px;"><div style="font-size:13px;font-weight:600;color:#17c3a8;margin-bottom:6px;">ü§ñ AI Recommendation</div><div style="font-size:13px;color:#ccc;line-height:1.7;">${s.aiNote}</div></div>
    <button onclick="notif('üìä','${s.name}','Strategy legs placed! Check Orders.');this.closest('[style]').remove();" style="width:100%;padding:14px;background:${s.color};border:none;border-radius:12px;color:#000;font-size:15px;font-weight:700;cursor:pointer;margin-bottom:10px;">‚ö° Execute Strategy ‚Üí </button>
    <button onclick="this.closest('[style]').remove()" style="width:100%;padding:12px;background:transparent;border:1px solid #2a2f3e;border-radius:12px;color:#fff;font-size:14px;cursor:pointer;">Close</button>
  </div>`;
  ov.onclick=e=>{if(e.target===ov)ov.remove();};document.body.appendChild(ov);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
checkOAuthCallback(); // Handle OAuth return from broker
buildHome();
setWTab('mylist');
setWTabActive();

// Add broker login button to topbar
(function addBrokerBtn(){
  const tb = document.querySelector('.topbar');
  if(!tb) return;
  const btn = document.createElement('button');
  btn.className = 'tb-btn';
  btn.style.background = '#5c4df322';
  btn.style.borderColor = '#5c4df3';
  btn.innerHTML = `<svg width="17" height="17" fill="none" stroke="#a78bfa" stroke-width="2" viewBox="0 0 24 24"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3"/></svg><span style="color:#a78bfa;">Login</span>`;
  btn.onclick = () => goTo('broker');
  tb.insertBefore(btn, tb.querySelector('.tb-btn'));
})();

</script>
</body>
</html>
